<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Colorado Homebuyer Navigator</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useMemo } = React;

    // Icon components using Lucide
    const Icon = ({ name, className }) => {
      const ref = React.useRef(null);
      React.useEffect(() => {
        if (ref.current) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          ref.current.appendChild(icon);
        }
      }, [name]);
      return <span ref={ref} className={className} style={{ display: 'inline-flex', alignItems: 'center' }} />;
    };

    // Tooltip component
    const Tooltip = ({ text, children }) => {
      const [show, setShow] = useState(false);
      return (
        <span className="relative inline-block">
          <span
            onMouseEnter={() => setShow(true)}
            onMouseLeave={() => setShow(false)}
            className="cursor-help border-b border-dotted border-gray-400"
          >
            {children}
          </span>
          {show && (
            <span className="absolute z-10 bottom-full left-1/2 -translate-x-1/2 mb-2 px-3 py-2 text-xs text-white bg-gray-900 rounded-lg whitespace-nowrap max-w-xs">
              {text}
              <span className="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-gray-900" />
            </span>
          )}
        </span>
      );
    };

    // Format currency
    const formatCurrency = (num) => {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
    };

    // Credit readiness assessment function
    const assessCreditReadiness = (creditScore) => {
      if (creditScore === '<580' || creditScore === '580-619') {
        return {
          status: 'not-ready',
          approvalRate: 0,
          color: 'red',
          message: 'Credit building required before homeownership',
          action: 'Focus on credit repair first',
          timeline: '12-24 months of credit building recommended',
          canProceed: false
        };
      } else if (creditScore === '620-659') {
        return {
          status: 'challenging',
          approvalRate: 35,
          color: 'orange',
          message: 'You meet minimum requirements, but approval will be difficult',
          action: 'Strongly recommend housing counselor consultation',
          timeline: 'Consider improving credit 6-12 months for better odds',
          canProceed: true
        };
      } else if (creditScore === '660-699') {
        return {
          status: 'moderate',
          approvalRate: 60,
          color: 'yellow',
          message: 'Moderate approval chances - other factors matter significantly',
          action: 'Housing counselor can assess your full profile',
          timeline: 'Can proceed now or improve credit 3-6 months',
          canProceed: true
        };
      } else if (creditScore === '700-739') {
        return {
          status: 'good',
          approvalRate: 75,
          color: 'green',
          message: 'Good approval chances with typical financial profile',
          action: 'Proceed with confidence',
          timeline: 'Ready to begin application process',
          canProceed: true
        };
      } else if (creditScore === '740-779' || creditScore === '780+') {
        return {
          status: 'excellent',
          approvalRate: creditScore === '780+' ? 95 : 85,
          color: 'green',
          message: 'Excellent approval chances - strong credit profile',
          action: 'You\'re in great shape',
          timeline: 'Ready to begin application process',
          canProceed: true
        };
      } else {
        // Default for unselected or older format values
        return {
          status: 'unknown',
          approvalRate: 70,
          color: 'gray',
          message: 'Please select your credit score range',
          action: 'Select credit score to see guidance',
          timeline: '',
          canProceed: true
        };
      }
    };

    // Get repayment terms for each program type
    const getRepaymentTerms = (programId, amount) => {
      const terms = {
        'chfa-grant': {
          type: 'grant',
          description: 'Never owed back (true grant)',
          shortDesc: 'Grant - never repay',
          owedAtSale: () => 0,
          forgiveness: 'Immediate',
          icon: 'ðŸŽ',
          note: 'You "pay" for this through a slightly higher interest rate (~0.4%)'
        },
        'chfa-second': {
          type: 'deferred',
          description: 'Deferred loan - no monthly payment, owed when you sell or refinance',
          shortDesc: 'Deferred until sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven - always owed',
          icon: 'ðŸ’³',
          note: 'Reduces your net proceeds when you sell'
        },
        'metro-dpa': {
          type: 'forgivable',
          description: 'Forgiven after 3 years of ownership',
          shortDesc: 'Forgiven after 3 years',
          owedAtSale: (years) => years >= 3 ? 0 : Math.round(amount * ((36 - (years * 12)) / 36)),
          forgiveness: '3 years',
          icon: 'â³',
          note: 'Prorated if you sell before 3 years'
        },
        'idf-boulder': {
          type: 'deferred',
          description: 'Deferred loan - owed when you sell',
          shortDesc: 'Deferred until sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven',
          icon: 'ðŸ’³',
          note: null
        },
        'boulder-h2o': {
          type: 'deferred',
          description: 'Deferred loan - owed when you sell',
          shortDesc: 'Deferred until sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven',
          icon: 'ðŸ’³',
          note: null
        },
        'chac-loan': {
          type: 'deferred-then-payment',
          description: 'No payment for 5 years, then monthly payment begins OR repay when you sell',
          shortDesc: 'Deferred 5 years, then payments or repay at sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven',
          icon: 'ðŸ’³',
          note: 'After 5 years: starts requiring payments OR repay in full'
        },
        // Occupation-specific programs
        'teacher-next-door': {
          type: 'deferred',
          description: '50% discount becomes lien - forgiven after 3 years residence',
          shortDesc: 'Forgiven after 3 years occupancy',
          owedAtSale: (years) => years >= 3 ? 0 : amount,
          forgiveness: '3 years',
          icon: 'ðŸŽ“',
          note: 'Must live in home as primary residence for 3 years'
        },
        'homes-for-heroes': {
          type: 'grant',
          description: 'Rebates and fee reductions - no repayment',
          shortDesc: 'Grant - never repay',
          owedAtSale: () => 0,
          forgiveness: 'Immediate',
          icon: 'ðŸŽ',
          note: null
        },
        'police-fire-foundation': {
          type: 'grant',
          description: 'True grant for first responders - no repayment',
          shortDesc: 'Grant - never repay',
          owedAtSale: () => 0,
          forgiveness: 'Immediate',
          icon: 'ðŸŽ',
          note: null
        },
        // Federal programs
        'va-loan': {
          type: 'loan-benefit',
          description: 'Standard mortgage - no down payment required',
          shortDesc: 'Standard mortgage (0% down)',
          owedAtSale: () => 0,
          forgiveness: 'N/A - standard loan',
          icon: 'ðŸŽ–ï¸',
          note: 'VA funding fee can be rolled into loan'
        },
        'usda-rural': {
          type: 'loan-benefit',
          description: 'Standard mortgage - no down payment in rural areas',
          shortDesc: 'Standard mortgage (0% down)',
          owedAtSale: () => 0,
          forgiveness: 'N/A - standard loan',
          icon: 'ðŸŒ¾',
          note: 'Guarantee fee applies'
        },
        'section-184': {
          type: 'loan-benefit',
          description: 'Low down payment mortgage for tribal members',
          shortDesc: 'Standard mortgage (1.25-2.25% down)',
          owedAtSale: () => 0,
          forgiveness: 'N/A - standard loan',
          icon: 'ðŸ ',
          note: 'Requires HUD-approved Section 184 lender'
        },
        // County workforce programs
        'summit-workforce': {
          type: 'deferred',
          description: 'Deferred loan tied to deed-restricted property',
          shortDesc: 'Deferred - repay at sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven',
          icon: 'â›·ï¸',
          note: 'Property remains deed-restricted after sale'
        },
        'eagle-workforce': {
          type: 'deferred',
          description: 'Deferred loan for Eagle County workforce housing',
          shortDesc: 'Deferred - repay at sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven',
          icon: 'ðŸ¦…',
          note: 'Deed-restricted property'
        },
        'pitkin-workforce': {
          type: 'deferred',
          description: 'Subsidy via deed-restricted purchase price',
          shortDesc: 'Deferred - repay at sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven',
          icon: 'ðŸ”ï¸',
          note: 'Strict resale restrictions apply'
        },
        'routt-yampa': {
          type: 'deferred',
          description: 'Deferred loan for Steamboat area workers',
          shortDesc: 'Deferred - repay at sale',
          owedAtSale: () => amount,
          forgiveness: 'Not forgiven',
          icon: 'ðŸŽ¿',
          note: null
        },
        // Specialty programs
        'disability-housing': {
          type: 'grant',
          description: 'Grant for buyers with disabilities - no repayment',
          shortDesc: 'Grant - never repay',
          owedAtSale: () => 0,
          forgiveness: 'Immediate',
          icon: 'â™¿',
          note: 'May include home modification funds'
        },
        'energy-efficient': {
          type: 'loan-addition',
          description: 'Rolled into primary mortgage - standard repayment',
          shortDesc: 'Part of mortgage payment',
          owedAtSale: () => 0,
          forgiveness: 'N/A - part of mortgage',
          icon: 'âš¡',
          note: 'Increases loan amount and monthly payment'
        },
        'refugee-homeownership': {
          type: 'grant',
          description: 'Grant for refugees and asylees - no repayment',
          shortDesc: 'Grant - never repay',
          owedAtSale: () => 0,
          forgiveness: 'Immediate',
          icon: 'ðŸŽ',
          note: 'Includes free counseling services'
        },
        'fha-203k': {
          type: 'loan-addition',
          description: 'Renovation costs rolled into mortgage',
          shortDesc: 'Part of mortgage payment',
          owedAtSale: () => 0,
          forgiveness: 'N/A - part of mortgage',
          icon: 'ðŸ”¨',
          note: 'Single loan covers purchase + repairs'
        },
        'second-chance': {
          type: 'forgivable',
          description: 'Forgiven after 5 years of ownership',
          shortDesc: 'Forgiven after 5 years',
          owedAtSale: (years) => years >= 5 ? 0 : Math.round(amount * ((60 - (years * 12)) / 60)),
          forgiveness: '5 years',
          icon: 'â³',
          note: 'Prorated if you sell before 5 years'
        },
        'healthcare-heroes': {
          type: 'grant',
          description: 'Grant for healthcare workers - no repayment',
          shortDesc: 'Grant - never repay',
          owedAtSale: () => 0,
          forgiveness: 'Immediate',
          icon: 'ðŸ¥',
          note: null
        },
        'nonprofit-employee': {
          type: 'forgivable',
          description: 'Forgiven after 3 years of ownership',
          shortDesc: 'Forgiven after 3 years',
          owedAtSale: (years) => years >= 3 ? 0 : Math.round(amount * ((36 - (years * 12)) / 36)),
          forgiveness: '3 years',
          icon: 'â³',
          note: 'Must remain in nonprofit employment'
        },
        'farmer-rancher': {
          type: 'loan-benefit',
          description: 'FSA loan with favorable terms for farmers',
          shortDesc: 'Standard loan (low down)',
          owedAtSale: () => 0,
          forgiveness: 'N/A - standard loan',
          icon: 'ðŸŒ½',
          note: 'Requires farm operation plan'
        },
        // Affordable Housing Programs
        'elevation-clt': {
          type: 'affordable-housing',
          description: 'Purchase home at 20-40% below market value through Community Land Trust',
          shortDesc: 'CLT - reduced purchase price',
          owedAtSale: () => 0,
          forgiveness: 'N/A - reduced price model',
          icon: 'ðŸ˜ï¸',
          note: 'You own the home, the trust owns the land. Monthly land lease ~$50-75. Limited appreciation (25% of gains).'
        },
        'thistle-clt': {
          type: 'affordable-housing',
          description: 'Purchase home at 20-40% below market value through Community Land Trust',
          shortDesc: 'CLT - reduced purchase price',
          owedAtSale: () => 0,
          forgiveness: 'N/A - reduced price model',
          icon: 'ðŸ˜ï¸',
          note: 'You own the home, the trust owns the land. Monthly land lease ~$50-75. Limited appreciation (25% of gains).'
        },
        'habitat-humanity': {
          type: 'affordable-housing',
          description: 'Below-market home with 0% interest mortgage and sweat equity requirement',
          shortDesc: 'Nonprofit - 0% mortgage',
          owedAtSale: () => 0,
          forgiveness: 'N/A - affordable mortgage',
          icon: 'ðŸ”¨',
          note: 'Requires 200-500 hours of "sweat equity" (helping build homes). No interest on mortgage.'
        },
        'denver-shared-equity': {
          type: 'affordable-housing',
          description: 'City-subsidized homes at below-market prices with shared equity arrangement',
          shortDesc: 'Shared equity - reduced price',
          owedAtSale: (years, appreciation) => appreciation * 0.25,
          forgiveness: 'N/A - shared appreciation model',
          icon: 'ðŸ ',
          note: 'City shares in 25% of appreciation when you sell. Keeps home affordable for next buyer.'
        },
        'chac-affordable': {
          type: 'affordable-housing',
          description: 'Below-market townhomes and condos with affordability restrictions',
          shortDesc: 'Nonprofit - reduced price',
          owedAtSale: () => 0,
          forgiveness: 'N/A - reduced price model',
          icon: 'ðŸ˜ï¸',
          note: 'Resale restrictions keep homes affordable. May have income appreciation limits.'
        },
        'rmnp-workforce': {
          type: 'affordable-housing',
          description: 'Below-market homes for workers in mountain communities',
          shortDesc: 'Workforce housing - reduced price',
          owedAtSale: () => 0,
          forgiveness: 'N/A - deed-restricted',
          icon: 'ðŸ”ï¸',
          note: 'Deed-restricted for local workforce. Must work in the area. Limited appreciation.'
        }
      };

      return terms[programId] || {
        type: 'unknown',
        description: 'Contact program for details',
        shortDesc: 'See program details',
        owedAtSale: () => amount,
        forgiveness: 'Unknown',
        icon: 'â“',
        note: null
      };
    };

    const DocumentsDropdown = ({ documents, isOpen, onToggle }) => {
      return (
        <div className="bg-white rounded-lg shadow-md mb-6 overflow-hidden">
          <button
            onClick={onToggle}
            className="w-full p-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors"
          >
            <div className="flex items-center gap-3">
              <Icon name="FileText" className="w-5 h-5 text-blue-600" />
              <span className="font-medium text-gray-900">Documents to Gather</span>
              <span className="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full">
                {documents.length} items
              </span>
            </div>
            <Icon
              name={isOpen ? "ChevronUp" : "ChevronDown"}
              className="w-5 h-5 text-gray-500"
            />
          </button>

          {isOpen && (
            <div className="border-t border-gray-200 p-4 bg-gray-50">
              <p className="text-sm text-gray-600 mb-4">
                Start gathering these documents now to speed up your applications later.
              </p>
              <div className="space-y-2">
                {documents.map((doc, idx) => (
                  <div
                    key={idx}
                    className="bg-white border border-gray-200 rounded-lg p-3 flex items-start gap-3"
                  >
                    <input
                      type="checkbox"
                      className="w-4 h-4 mt-0.5 rounded border-gray-300"
                    />
                    <div className="flex-1">
                      <p className="text-sm font-medium text-gray-900">{doc.name}</p>
                      <p className="text-xs text-gray-500">{doc.programs}</p>
                      {doc.optional && (
                        <p className="text-xs text-blue-600 mt-1">ðŸ’¡ {doc.optional}</p>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    };

    const ColoradoHomebuyerNavigator = () => {
      const [step, setStep] = useState(0);
      const [showDocuments, setShowDocuments] = useState(false);
      const [showNestedDocuments, setShowNestedDocuments] = useState(false);
      const [showComparison, setShowComparison] = useState(false);
      const [showAllOptions, setShowAllOptions] = useState(false);
      const [showRateInfo, setShowRateInfo] = useState(false);
      const [showCreditWarning, setShowCreditWarning] = useState(false);
      const [creditWarningAcknowledged, setCreditWarningAcknowledged] = useState(false);
      const [pickedOwnPrograms, setPickedOwnPrograms] = useState(false);
      const [expandedPackages, setExpandedPackages] = useState({});
      const [selectedPath, setSelectedPath] = useState(null); // 'dpa' or 'affordable'
      const [formData, setFormData] = useState({
        location: '',
        income: '',
        householdSize: '1',
        firstTimeBuyer: true,
        downPaymentSaved: '',
        creditScore: '',
        selectedPrograms: [],
        employerName: '',
        veteranStatus: false,
        occupation: '', // For occupation-specific programs
        hasDisability: false, // For disability-specific programs
        interestedInRenovation: false, // For FHA 203k and renovation programs
        isNativeAmerican: false, // For Section 184 Native American Loan
        hasSSN: true, // Has Social Security Number (vs ITIN only)
        purchasePrice: '',
        stayDuration: '',
        priorities: [], // Ranked array of priorities, first = most important
        recommendedLender: null, // { name, phone, specialties, rating, avgDays, reason }
        // Home preferences (NEW - home-first flow)
        bedrooms: 'any',
        bathrooms: 'any',
        propertyType: 'Any',
        neighborhoods: [],
        maxMonthlyPayment: '',
        listingType: 'all',
        selectedHomes: [] // Array of home IDs user wants to explore
      });
      const [listingFilter, setListingFilter] = useState('all');
      const [showRealtorsDropdown, setShowRealtorsDropdown] = useState(false);
      const [showLendersDropdown, setShowLendersDropdown] = useState(false);
      const [showDocumentUpload, setShowDocumentUpload] = useState(false);
      const [uploadedDocuments, setUploadedDocuments] = useState([]);
      const [applicationData, setApplicationData] = useState({
        signature: '',
        agreeToTerms: false,
        authorizeCredit: false,
        submitted: false,
        submittedAt: null
      });

      // Prepare step tracking
      const [prepareProgress, setPrepareProgress] = useState({
        classesCompleted: false,
        documentsUploaded: false
      });

      // Realtor selection and scheduling
      const [selectedRealtors, setSelectedRealtors] = useState([]);
      const [realtorConsultations, setRealtorConsultations] = useState({}); // {realtorName: {date, time}}

      // Lender selection and pre-approval
      const [selectedLenders, setSelectedLenders] = useState([]);
      const [preApprovalData, setPreApprovalData] = useState({
        employerName: '',
        employerPhone: '',
        yearsAtJob: '',
        monthlyDebts: '',
        bankruptcyHistory: 'no',
        submitted: false,
        submittedAt: null
      });
      const [feedback, setFeedback] = useState({
        helpful: null,
        clarity: '',
        wouldPay: null,
        comments: '',
        rateHelpful: null, // 'yes-helpful', 'somewhat', 'no-wanted-specific', 'ignored'
        rateImprovements: [] // array of improvement suggestions
      });

      // Program eligibility logic
      const programs = [
        {
          id: 'chfa-grant',
          name: 'CHFA Down Payment Grant',
          amount: 'Up to $25,000 (3% of loan)',
          description: 'Grant (no repayment) paired with CHFA first mortgage',
          requirements: ['First-time buyer', 'CHFA mortgage', 'Income limits apply'],
          counties: ['all'],
          incomeLimit: 140000,
          pros: 'No repayment required',
          cons: 'Higher interest rate on mortgage',
          isGrant: true,
          calcAmount: (price) => Math.min(price * 0.03, 25000),
          rateAdder: 0.004,
          yearsToForgiveness: 0,
          isDeferred: false,
          processingWeeks: 4
        },
        {
          id: 'chfa-second',
          name: 'CHFA Second Mortgage',
          amount: 'Up to $25,000 (4% of loan)',
          description: 'Silent second mortgage, deferred payment',
          requirements: ['First-time buyer', 'CHFA mortgage'],
          counties: ['all'],
          incomeLimit: 140000,
          pros: 'Lower interest rate than grant option',
          cons: 'Reduces equity when you sell',
          isGrant: false,
          calcAmount: (price) => Math.min(price * 0.04, 25000),
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 4
        },
        {
          id: 'metro-dpa',
          name: 'MetroDPA (Denver Metro)',
          amount: 'Up to 5% (max $25,000)',
          description: 'Forgivable loan - forgiven after 3 years',
          requirements: ['Denver/Jefferson/Adams/Arapahoe/Douglas/Broomfield county', 'First-time buyer'],
          counties: ['Denver', 'Jefferson', 'Adams', 'Arapahoe', 'Douglas', 'Broomfield'],
          incomeLimit: 176700,
          pros: 'Completely forgiven after 3 years',
          cons: 'Cannot stack with CHFA grant',
          isGrant: false,
          calcAmount: (price) => Math.min(price * 0.05, 25000),
          rateAdder: 0.002,
          yearsToForgiveness: 3,
          isDeferred: false,
          processingWeeks: 3
        },
        {
          id: 'idf-boulder',
          name: 'IDF Boulder County DPA',
          amount: 'Up to 20% of purchase price',
          description: 'Down payment assistance for Boulder County residents',
          requirements: ['Boulder County', 'Income limits', 'Homebuyer education'],
          counties: ['Boulder'],
          incomeLimit: 120000,
          pros: 'Can be substantial amount',
          cons: 'Long processing time (4-6 weeks)',
          isGrant: false,
          calcAmount: (price) => Math.min(price * 0.10, 40000),
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 6
        },
        {
          id: 'boulder-h2o',
          name: 'Boulder H2O Loan',
          amount: 'Up to 15% down payment',
          description: 'Revolving loan fund for Boulder residents',
          requirements: ['City of Boulder', 'Complete education BEFORE offer', 'Permanently affordable housing'],
          counties: ['Boulder'],
          incomeLimit: 95000,
          pros: 'Low interest rate',
          cons: 'Must complete education before making offer',
          isGrant: false,
          calcAmount: (price) => Math.min(price * 0.10, 35000),
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 5
        },
        {
          id: 'chac-loan',
          name: 'CHAC Down Payment Loan',
          amount: 'Up to $12,000',
          description: 'Second mortgage with flexible terms',
          requirements: ['Statewide', 'Homebuyer education', 'CHAC counseling'],
          counties: ['all'],
          incomeLimit: 120000,
          pros: 'Flexible payment options',
          cons: 'Requires two separate education courses',
          isGrant: false,
          calcAmount: (price) => 12000,
          rateAdder: 0,
          yearsToForgiveness: 5,
          isDeferred: true,
          processingWeeks: 4
        },
        // ============================================
        // OCCUPATION-SPECIFIC PROGRAMS
        // ============================================
        {
          id: 'teacher-next-door',
          name: 'Teacher Next Door (Good Neighbor)',
          amount: '50% discount on HUD homes',
          description: 'HUD Good Neighbor Next Door for educators - 50% off list price',
          requirements: ['K-12 Teacher', 'Full-time public/private school', 'Must live in home 3 years'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'Massive 50% discount on select HUD properties',
          cons: 'Limited inventory - must check HUD listings',
          isGrant: false,
          calcAmount: (price) => 0, // Property discount, not cash DPA
          rateAdder: 0,
          yearsToForgiveness: 3,
          isDeferred: true,
          processingWeeks: 6,
          occupation: 'educator',
          category: 'occupation',
          isPropertyDiscount: true // Not actual cash assistance
        },
        {
          id: 'homes-for-heroes',
          name: 'Homes for Heroes',
          amount: 'Avg $3,000 in savings',
          description: 'Rebates and reduced fees for first responders, healthcare workers, and teachers',
          requirements: ['First responder, healthcare, or educator', 'Use participating agent/lender'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'Multiple fee reductions and lender credits',
          cons: 'Must use specific participating lenders',
          isGrant: true,
          calcAmount: (price) => 3000,
          rateAdder: 0,
          yearsToForgiveness: 0,
          isDeferred: false,
          processingWeeks: 2,
          occupation: ['educator', 'first-responder', 'healthcare', 'law-enforcement'],
          category: 'occupation'
        },
        {
          id: 'police-fire-foundation',
          name: 'Police & Fire Foundation Grant',
          amount: 'Up to $6,000 grant',
          description: 'Down payment grant for law enforcement officers and firefighters',
          requirements: ['Active law enforcement or firefighter', 'First-time buyer', 'Primary residence'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'True grant - never repaid',
          cons: 'Competitive application process',
          isGrant: true,
          calcAmount: (price) => 6000,
          rateAdder: 0,
          yearsToForgiveness: 0,
          isDeferred: false,
          processingWeeks: 4,
          occupation: ['first-responder', 'law-enforcement'],
          category: 'occupation'
        },
        // ============================================
        // FEDERAL PROGRAMS
        // ============================================
        {
          id: 'va-loan',
          name: 'VA Home Loan',
          amount: '0% down payment',
          description: 'Zero down payment loan for veterans and active military',
          requirements: ['Veteran or active military', 'Certificate of Eligibility', 'Meet credit requirements'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'No down payment, no PMI, competitive rates',
          cons: 'VA funding fee (can be rolled into loan)',
          isGrant: false,
          calcAmount: (price) => price * 0.00,
          rateAdder: -0.005,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 5,
          occupation: 'military',
          category: 'federal'
        },
        {
          id: 'usda-rural',
          name: 'USDA Rural Development Loan',
          amount: '0% down payment',
          description: 'Zero down payment for rural and suburban areas',
          requirements: ['Rural/suburban location', 'Income limits by area', 'Primary residence'],
          counties: ['Weld', 'Larimer', 'Morgan', 'Logan', 'El Paso', 'Mesa', 'Montrose', 'La Plata', 'Pueblo'],
          incomeLimit: 110650,
          pros: 'No down payment, low interest rates',
          cons: 'Geographic restrictions, guarantee fee',
          isGrant: false,
          calcAmount: (price) => 0,
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 6,
          category: 'federal'
        },
        {
          id: 'section-184',
          name: 'Section 184 Native American Loan',
          amount: 'Low down payment (1.25-2.25%)',
          description: 'HUD loan program for Native Americans',
          requirements: ['Enrolled tribal member', 'Primary residence', 'HUD-approved lender'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'Very low down payment, no PMI, flexible underwriting',
          cons: 'Must use HUD-approved Section 184 lender',
          isGrant: false,
          calcAmount: (price) => price * 0.0125,
          rateAdder: -0.002,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 5,
          category: 'federal'
        },
        {
          id: 'itin-loan',
          name: 'ITIN Home Loan',
          amount: '10-15% down payment required',
          description: 'Mortgage option for buyers with ITIN (no SSN required)',
          requirements: ['Valid ITIN', '2+ years tax returns', '10-15% down payment', 'Credit history'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'No SSN required, path to homeownership for ITIN holders',
          cons: 'Higher down payment, higher interest rates, fewer lenders',
          isGrant: false,
          calcAmount: (price) => 0,
          rateAdder: 0.015,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 6,
          category: 'federal',
          itinFriendly: true
        },
        // ============================================
        // COMMUNITY LAND TRUSTS & AFFORDABLE HOMEOWNERSHIP
        // ============================================
        {
          id: 'elevation-clt',
          name: 'Elevation Community Land Trust',
          amount: '20-40% below market price',
          description: 'Buy a home at 20-40% below market value. You own the home, the trust owns the land.',
          requirements: ['Income at or below 80% AMI', 'First-time buyer preferred', 'Homebuyer education', 'Primary residence'],
          counties: ['Denver', 'Adams', 'Arapahoe', 'Jefferson', 'Boulder', 'Broomfield'],
          incomeLimit: 85000,
          pros: 'Dramatically lower purchase price, permanently affordable, build some equity',
          cons: 'Limited appreciation (25% of increase), land lease fee (~$50-75/mo), resale restrictions',
          isGrant: false,
          calcAmount: (price) => price * 0.30, // Represents the discount, not DPA
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 8,
          category: 'affordable-housing',
          isAffordableHousing: true,
          programType: 'Community Land Trust'
        },
        {
          id: 'thistle-clt',
          name: 'Thistle Community Land Trust',
          amount: '25-35% below market price',
          description: 'Boulder County CLT offering permanently affordable homes with shared equity model.',
          requirements: ['Income limits (varies by household size)', 'Work or live in Boulder County', 'Homebuyer education', 'Cannot own other property'],
          counties: ['Boulder'],
          incomeLimit: 115000,
          pros: 'Access to Boulder County at affordable prices, strong community support, solar-ready homes',
          cons: 'Limited appreciation, waitlist may apply, specific neighborhoods only',
          isGrant: false,
          calcAmount: (price) => price * 0.30,
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 10,
          category: 'affordable-housing',
          isAffordableHousing: true,
          programType: 'Community Land Trust'
        },
        {
          id: 'habitat-humanity',
          name: 'Habitat for Humanity Colorado',
          amount: '0% interest mortgage + sweat equity',
          description: 'Affordable homes with 0% interest loans. Requires sweat equity hours building homes.',
          requirements: ['Income 30-60% AMI', 'Able to pay affordable mortgage', '200-400 sweat equity hours', 'Housing need demonstrated'],
          counties: ['all'],
          incomeLimit: 64000,
          pros: 'Zero interest mortgage, very low monthly payments, new construction, community building',
          cons: 'Significant time commitment (sweat equity), long waitlists, limited availability',
          isGrant: false,
          calcAmount: (price) => price * 0.40, // Represents combined savings
          rateAdder: -0.065, // Effectively 0% rate
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 52, // Long process
          category: 'affordable-housing',
          isAffordableHousing: true,
          programType: 'Nonprofit Homeownership'
        },
        {
          id: 'denver-shared-equity',
          name: 'Denver Shared Equity Program',
          amount: 'Up to $50,000 + below-market homes',
          description: 'City program combining DPA with deed-restricted affordable homes in Denver.',
          requirements: ['Income at or below 80% AMI', 'First-time buyer', 'Denver resident or worker', 'Homebuyer education'],
          counties: ['Denver'],
          incomeLimit: 85000,
          pros: 'Combines DPA with affordable pricing, city-backed program, multiple neighborhoods',
          cons: 'Resale price restrictions, must remain primary residence, limited inventory',
          isGrant: false,
          calcAmount: (price) => 50000,
          rateAdder: 0,
          yearsToForgiveness: 15,
          isDeferred: true,
          processingWeeks: 8,
          category: 'affordable-housing',
          isAffordableHousing: true,
          programType: 'Shared Equity'
        },
        {
          id: 'chac-affordable',
          name: 'CHAC Affordable Housing Program',
          amount: 'Below-market homes + down payment help',
          description: 'Colorado Housing Assistance Corp offers affordable homes with financing assistance.',
          requirements: ['Income limits apply', 'Homebuyer counseling required', 'First-time buyer', 'Credit score 620+'],
          counties: ['Denver', 'Adams', 'Arapahoe', 'Jefferson'],
          incomeLimit: 100000,
          pros: 'Full-service support from counseling to closing, affordable inventory, flexible financing',
          cons: 'Limited home selection, specific neighborhoods, deed restrictions',
          isGrant: false,
          calcAmount: (price) => price * 0.15,
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 6,
          category: 'affordable-housing',
          isAffordableHousing: true,
          programType: 'Nonprofit Housing'
        },
        {
          id: 'rmnp-workforce',
          name: 'Rocky Mountain Workforce Housing',
          amount: 'Deed-restricted affordable homes',
          description: 'Affordable workforce housing in mountain communities for local workers.',
          requirements: ['Work in local community 30+ hrs/week', 'Income limits by AMI', 'Primary residence required'],
          counties: ['Eagle', 'Summit', 'Pitkin', 'Routt', 'Grand'],
          incomeLimit: 150000,
          pros: 'Access to mountain communities otherwise unaffordable, stable housing for workers',
          cons: 'Deed restrictions, must maintain local employment, limited appreciation',
          isGrant: false,
          calcAmount: (price) => price * 0.25,
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 8,
          category: 'affordable-housing',
          isAffordableHousing: true,
          programType: 'Workforce Housing'
        },
        // ============================================
        // COUNTY-SPECIFIC WORKFORCE HOUSING
        // ============================================
        {
          id: 'summit-workforce',
          name: 'Summit County Workforce Housing',
          amount: 'Up to $50,000 deferred loan',
          description: 'Down payment assistance for Summit County workers',
          requirements: ['Work in Summit County 30+ hrs/week', 'Income limits', 'Deed-restricted property'],
          counties: ['Summit'],
          incomeLimit: 184000,
          pros: 'Substantial assistance in expensive market',
          cons: 'Deed-restricted housing, limited resale',
          isGrant: false,
          calcAmount: (price) => Math.min(50000, price * 0.15),
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 8,
          category: 'county-workforce'
        },
        {
          id: 'eagle-workforce',
          name: 'Eagle County Housing Assistance',
          amount: 'Up to $40,000 deferred loan',
          description: 'Workforce housing assistance for Eagle County (Vail area)',
          requirements: ['Work in Eagle County', 'Income limits', 'Purchase deed-restricted unit'],
          counties: ['Eagle'],
          incomeLimit: 172000,
          pros: 'Significant help in expensive Vail Valley',
          cons: 'Must purchase deed-restricted property',
          isGrant: false,
          calcAmount: (price) => Math.min(40000, price * 0.10),
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 8,
          category: 'county-workforce'
        },
        {
          id: 'pitkin-workforce',
          name: 'Pitkin County APCHA Program',
          amount: 'Subsidized deed-restricted homes',
          description: 'Aspen/Pitkin affordable housing lottery system',
          requirements: ['Work in Pitkin County 4+ years', 'Income/asset limits', 'Lottery selection'],
          counties: ['Pitkin'],
          incomeLimit: 226000,
          pros: 'Only way to afford Aspen area on regular income',
          cons: 'Long waitlists, lottery system, resale restrictions',
          isGrant: false,
          calcAmount: (price) => 0, // Subsidized housing, not cash DPA
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 12,
          category: 'county-workforce',
          isAffordableHousing: true,
          programType: 'Deed-Restricted Housing'
        },
        {
          id: 'routt-yampa',
          name: 'Routt County Housing Authority',
          amount: 'Up to $50,000 deferred',
          description: 'Steamboat Springs area workforce housing assistance',
          requirements: ['Routt County resident/worker', 'Income limits', 'Primary residence'],
          counties: ['Routt'],
          incomeLimit: 150000,
          pros: 'Help in expensive ski resort area',
          cons: 'Limited inventory',
          isGrant: false,
          calcAmount: (price) => Math.min(50000, price * 0.10),
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: true,
          processingWeeks: 6,
          category: 'county-workforce'
        },
        // ============================================
        // SPECIALTY PROGRAMS
        // ============================================
        {
          id: 'disability-housing',
          name: 'Disability Housing Assistance',
          amount: 'Up to $15,000 grant',
          description: 'Down payment and modification assistance for buyers with disabilities',
          requirements: ['Documented disability', 'Income limits', 'May include home modification funds'],
          counties: ['all'],
          incomeLimit: 100000,
          pros: 'Grant + potential modification funding',
          cons: 'Limited funding availability',
          isGrant: true,
          calcAmount: (price) => 15000,
          rateAdder: 0,
          yearsToForgiveness: 0,
          isDeferred: false,
          processingWeeks: 6,
          category: 'specialty'
        },
        {
          id: 'energy-efficient',
          name: 'Energy Efficient Mortgage (EEM)',
          amount: 'Finance energy improvements',
          description: 'Roll energy efficiency upgrades into your mortgage',
          requirements: ['Home energy assessment', 'Cost-effective improvements', 'FHA or conventional loan'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'Finance solar, insulation, HVAC upgrades',
          cons: 'Requires home energy audit',
          isGrant: false,
          calcAmount: (price) => Math.min(price * 0.05, 15000),
          rateAdder: 0,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 3,
          category: 'specialty'
        },
        {
          id: 'refugee-homeownership',
          name: 'Refugee Homeownership Program',
          amount: 'Up to $10,000 grant + counseling',
          description: 'Specialized program for refugees and asylees',
          requirements: ['Refugee or asylee status', 'Completed homebuyer education', 'Income limits'],
          counties: ['Denver', 'Arapahoe', 'Adams', 'Jefferson'],
          incomeLimit: 95000,
          pros: 'Culturally competent counseling included',
          cons: 'Limited to specific counties',
          isGrant: true,
          calcAmount: (price) => 10000,
          rateAdder: 0,
          yearsToForgiveness: 0,
          isDeferred: false,
          processingWeeks: 5,
          category: 'specialty'
        },
        {
          id: 'fha-203k',
          name: 'FHA 203(k) Renovation Loan',
          amount: 'Finance repairs into mortgage',
          description: 'Buy fixer-upper and finance renovations in one loan',
          requirements: ['FHA eligible', 'HUD consultant for repairs over $35K', 'Licensed contractors'],
          counties: ['all'],
          incomeLimit: 999999,
          pros: 'Buy homes that need work, one loan for purchase + repairs',
          cons: 'Complex process, longer timeline',
          isGrant: false,
          calcAmount: (price) => Math.min(price * 0.10, 35000),
          rateAdder: 0.001,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 8,
          category: 'specialty'
        },
        {
          id: 'second-chance',
          name: 'Second Chance Homebuyer',
          amount: 'Standard DPA with counseling',
          description: 'Program for buyers recovering from foreclosure/bankruptcy',
          requirements: ['3+ years since foreclosure/bankruptcy', 'Completed credit counseling', 'Rebuilt credit'],
          counties: ['all'],
          incomeLimit: 120000,
          pros: 'Path back to homeownership after hardship',
          cons: 'Requires extensive counseling and documentation',
          isGrant: false,
          calcAmount: (price) => Math.min(price * 0.03, 15000),
          rateAdder: 0.002,
          yearsToForgiveness: 5,
          isDeferred: true,
          processingWeeks: 6,
          category: 'specialty'
        },
        // ============================================
        // ADDITIONAL OCCUPATION PROGRAMS
        // ============================================
        {
          id: 'healthcare-heroes',
          name: 'Healthcare Worker Housing',
          amount: 'Up to $5,000 grant',
          description: 'Down payment assistance for nurses, doctors, and healthcare workers',
          requirements: ['Healthcare professional', 'Full-time employment', 'First-time or repeat buyer'],
          counties: ['all'],
          incomeLimit: 180000,
          pros: 'Available to both first-time and repeat buyers',
          cons: 'Must verify healthcare employment',
          isGrant: true,
          calcAmount: (price) => 5000,
          rateAdder: 0,
          yearsToForgiveness: 0,
          isDeferred: false,
          processingWeeks: 3,
          occupation: 'healthcare',
          category: 'occupation'
        },
        {
          id: 'nonprofit-employee',
          name: 'Nonprofit Employee DPA',
          amount: 'Up to $8,000 forgivable',
          description: 'Assistance for 501(c)(3) nonprofit employees',
          requirements: ['501(c)(3) employee 1+ year', 'Income limits', 'First-time buyer'],
          counties: ['Denver', 'Boulder', 'Larimer', 'El Paso'],
          incomeLimit: 100000,
          pros: 'Forgiven after 3 years of ownership',
          cons: 'Must remain in nonprofit employment',
          isGrant: false,
          calcAmount: (price) => 8000,
          rateAdder: 0,
          yearsToForgiveness: 3,
          isDeferred: false,
          processingWeeks: 4,
          occupation: 'nonprofit',
          category: 'occupation'
        },
        {
          id: 'farmer-rancher',
          name: 'Beginning Farmer/Rancher Loan',
          amount: 'Up to 95% financing',
          description: 'FSA direct/guaranteed loans for farmers and ranchers',
          requirements: ['Beginning farmer/rancher', 'Farm operation plan', 'USDA FSA approval'],
          counties: ['Weld', 'Morgan', 'Logan', 'Yuma', 'Kit Carson', 'Prowers', 'Baca'],
          incomeLimit: 999999,
          pros: 'Low rates, flexible terms for agricultural buyers',
          cons: 'Must have viable farm operation plan',
          isGrant: false,
          calcAmount: (price) => price * 0.05,
          rateAdder: -0.003,
          yearsToForgiveness: null,
          isDeferred: false,
          processingWeeks: 8,
          occupation: 'farmer',
          category: 'occupation'
        }
      ];

      // ============================================
      // SAMPLE HOME LISTINGS DATABASE
      // ============================================
      const sampleListings = [
        // DENVER COUNTY - Market Rate
        {
          id: 'den-001',
          address: '1234 Maple Street',
          neighborhood: 'Montbello',
          city: 'Denver',
          county: 'Denver',
          price: 385000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1450,
          propertyType: 'Single Family',
          yearBuilt: 1978,
          photo: 'https://images.unsplash.com/photo-1568605114967-8130f3a36994?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 12,
          description: 'Updated ranch with new kitchen, fenced yard, detached garage.',
          features: ['Updated Kitchen', 'Fenced Yard', 'Garage']
        },
        {
          id: 'den-002',
          address: '5678 Oak Avenue #205',
          neighborhood: 'Globeville',
          city: 'Denver',
          county: 'Denver',
          price: 295000,
          bedrooms: 2,
          bathrooms: 1,
          sqft: 950,
          propertyType: 'Condo',
          yearBuilt: 2015,
          photo: 'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 28,
          description: 'Modern condo with mountain views, HOA includes utilities.',
          features: ['Mountain Views', 'Modern Finishes', 'Covered Parking']
        },
        {
          id: 'den-003',
          address: '910 Pine Drive',
          neighborhood: 'Green Valley Ranch',
          city: 'Denver',
          county: 'Denver',
          price: 425000,
          bedrooms: 4,
          bathrooms: 2.5,
          sqft: 1850,
          propertyType: 'Single Family',
          yearBuilt: 2005,
          photo: 'https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 7,
          description: 'Spacious two-story with finished basement, close to DIA.',
          features: ['Finished Basement', 'Near Airport', 'Large Lot']
        },
        // DENVER - Income Restricted / CLT
        {
          id: 'den-clt-001',
          address: '222 Affordable Way',
          neighborhood: 'Westwood',
          city: 'Denver',
          county: 'Denver',
          price: 275000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1200,
          propertyType: 'Townhome',
          yearBuilt: 2020,
          photo: 'https://images.unsplash.com/photo-1605276374104-dee2a0ed3cd6?w=400&h=300&fit=crop',
          listingType: 'income-restricted',
          restrictionType: 'Elevation CLT',
          daysOnMarket: 5,
          description: 'New construction CLT home. Deed-restricted for long-term affordability.',
          features: ['New Construction', 'Energy Efficient', 'No Land Cost'],
          maxIncome: 80,
          restrictions: 'Community Land Trust - you own the home, not the land. Resale price limited to 25% of appreciation.'
        },
        {
          id: 'den-clt-002',
          address: '456 Community Lane',
          neighborhood: 'Sun Valley',
          city: 'Denver',
          county: 'Denver',
          price: 225000,
          bedrooms: 2,
          bathrooms: 1.5,
          sqft: 1050,
          propertyType: 'Townhome',
          yearBuilt: 2018,
          photo: 'https://images.unsplash.com/photo-1600607687939-ce8a6c25118c?w=400&h=300&fit=crop',
          listingType: 'income-restricted',
          restrictionType: 'Habitat for Humanity',
          daysOnMarket: 0,
          description: 'Habitat home with sweat equity opportunity. Apply now for upcoming build.',
          features: ['Sweat Equity', 'Below Market', 'New Construction'],
          maxIncome: 60,
          restrictions: 'Requires 200-400 hours of sweat equity. 0% interest mortgage available.'
        },
        // BOULDER COUNTY
        {
          id: 'bou-001',
          address: '789 Baseline Road',
          neighborhood: 'South Boulder',
          city: 'Boulder',
          county: 'Boulder',
          price: 525000,
          bedrooms: 2,
          bathrooms: 2,
          sqft: 1100,
          propertyType: 'Condo',
          yearBuilt: 1990,
          photo: 'https://images.unsplash.com/photo-1460317442991-0ec209397118?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 45,
          description: 'Rare affordable option in South Boulder. Walk to trails.',
          features: ['Trail Access', 'Mountain Views', 'Updated']
        },
        {
          id: 'bou-clt-001',
          address: '321 Thistle Court',
          neighborhood: 'Gunbarrel',
          city: 'Boulder',
          county: 'Boulder',
          price: 325000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1350,
          propertyType: 'Single Family',
          yearBuilt: 2015,
          photo: 'https://images.unsplash.com/photo-1572120360610-d971b9d7767c?w=400&h=300&fit=crop',
          listingType: 'income-restricted',
          restrictionType: 'Thistle Communities',
          daysOnMarket: 14,
          description: 'Thistle CLT home in desirable Gunbarrel. Permanently affordable.',
          features: ['Community Land Trust', 'Solar Panels', 'Garden Space'],
          maxIncome: 100,
          restrictions: 'Thistle CLT ownership. Limited appreciation on resale.'
        },
        {
          id: 'bou-002',
          address: '555 Main Street',
          neighborhood: 'Downtown Longmont',
          city: 'Longmont',
          county: 'Boulder',
          price: 395000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1400,
          propertyType: 'Single Family',
          yearBuilt: 1965,
          photo: 'https://images.unsplash.com/photo-1518780664697-55e3ad937233?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 21,
          description: 'Charming bungalow in walkable downtown Longmont.',
          features: ['Walkable', 'Character Home', 'Large Yard']
        },
        // ADAMS COUNTY
        {
          id: 'ada-001',
          address: '1111 Commerce City Blvd',
          neighborhood: 'Commerce City',
          city: 'Commerce City',
          county: 'Adams',
          price: 365000,
          bedrooms: 4,
          bathrooms: 2,
          sqft: 1600,
          propertyType: 'Single Family',
          yearBuilt: 2010,
          photo: 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 18,
          description: 'Spacious family home near Dick\'s Sporting Goods Park.',
          features: ['Open Floor Plan', 'Near Stadium', 'Good Schools']
        },
        {
          id: 'ada-002',
          address: '2222 Westminster Way',
          neighborhood: 'Westminster',
          city: 'Westminster',
          county: 'Adams',
          price: 415000,
          bedrooms: 3,
          bathrooms: 2.5,
          sqft: 1550,
          propertyType: 'Townhome',
          yearBuilt: 2018,
          photo: 'https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 9,
          description: 'Modern townhome with rooftop deck near downtown Westminster.',
          features: ['Rooftop Deck', 'Modern', 'Low Maintenance']
        },
        {
          id: 'ada-003',
          address: '333 Thornton Terrace',
          neighborhood: 'Thornton',
          city: 'Thornton',
          county: 'Adams',
          price: 345000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1350,
          propertyType: 'Single Family',
          yearBuilt: 1998,
          photo: 'https://images.unsplash.com/photo-1598228723793-52759bba239c?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 32,
          description: 'Well-maintained home in established Thornton neighborhood.',
          features: ['Established Area', 'Updated', 'Near Parks']
        },
        // JEFFERSON COUNTY
        {
          id: 'jef-001',
          address: '3333 Lakewood Lane',
          neighborhood: 'Lakewood',
          city: 'Lakewood',
          county: 'Jefferson',
          price: 445000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1500,
          propertyType: 'Single Family',
          yearBuilt: 1972,
          photo: 'https://images.unsplash.com/photo-1564013799919-ab600027ffc6?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 30,
          description: 'Updated mid-century home near Belmar shopping district.',
          features: ['Updated', 'Near Shopping', 'Large Lot']
        },
        {
          id: 'jef-002',
          address: '4444 Wheat Ridge Road',
          neighborhood: 'Wheat Ridge',
          city: 'Wheat Ridge',
          county: 'Jefferson',
          price: 375000,
          bedrooms: 2,
          bathrooms: 1,
          sqft: 1100,
          propertyType: 'Single Family',
          yearBuilt: 1955,
          photo: 'https://images.unsplash.com/photo-1449844908441-8829872d2607?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 60,
          description: 'Cozy cottage with expansion potential. Great starter home.',
          features: ['Starter Home', 'Expansion Potential', 'Mature Trees']
        },
        {
          id: 'jef-003',
          address: '5555 Arvada Avenue',
          neighborhood: 'Arvada',
          city: 'Arvada',
          county: 'Jefferson',
          price: 425000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1450,
          propertyType: 'Single Family',
          yearBuilt: 1985,
          photo: 'https://images.unsplash.com/photo-1583608205776-bfd35f0d9f83?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 15,
          description: 'Ranch-style home near Olde Town Arvada.',
          features: ['Near Olde Town', 'Ranch Style', 'Updated Kitchen']
        },
        // ARAPAHOE COUNTY
        {
          id: 'ara-001',
          address: '5555 Aurora Avenue',
          neighborhood: 'Aurora',
          city: 'Aurora',
          county: 'Arapahoe',
          price: 355000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1350,
          propertyType: 'Single Family',
          yearBuilt: 1985,
          photo: 'https://images.unsplash.com/photo-1570129477492-45c003edd2be?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 25,
          description: 'Well-maintained home in established Aurora neighborhood.',
          features: ['Established Neighborhood', 'Good Schools', 'Parks Nearby']
        },
        {
          id: 'ara-002',
          address: '6666 Centennial Circle',
          neighborhood: 'Centennial',
          city: 'Centennial',
          county: 'Arapahoe',
          price: 485000,
          bedrooms: 4,
          bathrooms: 2.5,
          sqft: 1800,
          propertyType: 'Single Family',
          yearBuilt: 1995,
          photo: 'https://images.unsplash.com/photo-1599427303058-f04cbcf4756f?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 8,
          description: 'Spacious home in desirable Cherry Creek school district.',
          features: ['Cherry Creek Schools', 'Spacious', 'Updated']
        },
        // LARIMER COUNTY
        {
          id: 'lar-001',
          address: '6666 Fort Collins Court',
          neighborhood: 'Fort Collins',
          city: 'Fort Collins',
          county: 'Larimer',
          price: 475000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1400,
          propertyType: 'Single Family',
          yearBuilt: 2000,
          photo: 'https://images.unsplash.com/photo-1600047509807-ba8f99d2cdde?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 14,
          description: 'Popular floor plan near CSU campus and Old Town.',
          features: ['Near CSU', 'Walkable', 'Updated']
        },
        {
          id: 'lar-clt-001',
          address: '7777 Elevation Drive',
          neighborhood: 'Loveland',
          city: 'Loveland',
          county: 'Larimer',
          price: 285000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1250,
          propertyType: 'Townhome',
          yearBuilt: 2022,
          photo: 'https://images.unsplash.com/photo-1600566753086-00f18fb6b3ea?w=400&h=300&fit=crop',
          listingType: 'income-restricted',
          restrictionType: 'Elevation CLT',
          daysOnMarket: 3,
          description: 'Brand new CLT townhome in growing Loveland community.',
          features: ['New Construction', 'Energy Star', 'Community Garden'],
          maxIncome: 100,
          restrictions: 'Community Land Trust. Equity limited to 25% of appreciation.'
        },
        {
          id: 'lar-002',
          address: '8888 Wellington Way',
          neighborhood: 'Wellington',
          city: 'Wellington',
          county: 'Larimer',
          price: 385000,
          bedrooms: 4,
          bathrooms: 2,
          sqft: 1650,
          propertyType: 'Single Family',
          yearBuilt: 2015,
          photo: 'https://images.unsplash.com/photo-1600573472550-8090b5e0745e?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 20,
          description: 'Newer home in growing Wellington community north of Fort Collins.',
          features: ['Newer Construction', 'Open Floor Plan', 'Mountain Views']
        },
        // EL PASO COUNTY
        {
          id: 'elp-001',
          address: '8888 Springs Street',
          neighborhood: 'Southeast',
          city: 'Colorado Springs',
          county: 'El Paso',
          price: 325000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1450,
          propertyType: 'Single Family',
          yearBuilt: 1995,
          photo: 'https://images.unsplash.com/photo-1600585154526-990dced4db0d?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 22,
          description: 'Mountain views, great value in Colorado Springs.',
          features: ['Mountain Views', 'Great Value', 'Quiet Street']
        },
        {
          id: 'elp-002',
          address: '9999 Military Lane',
          neighborhood: 'Fountain',
          city: 'Fountain',
          county: 'El Paso',
          price: 295000,
          bedrooms: 4,
          bathrooms: 2,
          sqft: 1650,
          propertyType: 'Single Family',
          yearBuilt: 2008,
          photo: 'https://images.unsplash.com/photo-1600566753190-17f0baa2a6c3?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 35,
          description: 'Spacious home near Fort Carson. Popular with military families.',
          features: ['Near Fort Carson', 'Spacious', 'Family Friendly']
        },
        {
          id: 'elp-003',
          address: '1010 Westside Way',
          neighborhood: 'Westside',
          city: 'Colorado Springs',
          county: 'El Paso',
          price: 345000,
          bedrooms: 3,
          bathrooms: 1.5,
          sqft: 1300,
          propertyType: 'Single Family',
          yearBuilt: 1960,
          photo: 'https://images.unsplash.com/photo-1600563438938-a9a27216b4f5?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 40,
          description: 'Character home with views of Pikes Peak.',
          features: ['Pikes Peak Views', 'Character Home', 'Updated']
        },
        // DOUGLAS COUNTY
        {
          id: 'dou-001',
          address: '1212 Parker Place',
          neighborhood: 'Parker',
          city: 'Parker',
          county: 'Douglas',
          price: 465000,
          bedrooms: 3,
          bathrooms: 2.5,
          sqft: 1600,
          propertyType: 'Townhome',
          yearBuilt: 2012,
          photo: 'https://images.unsplash.com/photo-1600607687644-c7171b42498f?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 12,
          description: 'Modern townhome in downtown Parker near restaurants and shops.',
          features: ['Downtown Location', 'Modern', 'Low Maintenance']
        },
        // BROOMFIELD
        {
          id: 'bro-001',
          address: '1313 Broomfield Blvd',
          neighborhood: 'Broomfield',
          city: 'Broomfield',
          county: 'Broomfield',
          price: 435000,
          bedrooms: 3,
          bathrooms: 2,
          sqft: 1450,
          propertyType: 'Single Family',
          yearBuilt: 1998,
          photo: 'https://images.unsplash.com/photo-1600585154363-67eb9e2e2099?w=400&h=300&fit=crop',
          listingType: 'market',
          daysOnMarket: 18,
          description: 'Well-maintained home near Flatiron Crossing mall.',
          features: ['Near Shopping', 'Good Schools', 'Updated']
        }
      ];

      // Neighborhood options by county
      const getNeighborhoodsForCounty = (county) => {
        const neighborhoods = {
          'Denver': ['Montbello', 'Green Valley Ranch', 'Globeville', 'Westwood', 'Sun Valley', 'Elyria-Swansea', 'Northeast Park Hill', 'Hampden South', 'Barnum'],
          'Boulder': ['Gunbarrel', 'South Boulder', 'North Boulder', 'Downtown Longmont', 'Lafayette', 'Louisville', 'Erie'],
          'Jefferson': ['Lakewood', 'Wheat Ridge', 'Golden', 'Arvada', 'Evergreen', 'Edgewater'],
          'Adams': ['Commerce City', 'Westminster', 'Thornton', 'Northglenn', 'Federal Heights', 'Brighton'],
          'Arapahoe': ['Aurora', 'Centennial', 'Englewood', 'Littleton', 'Sheridan'],
          'Douglas': ['Parker', 'Castle Rock', 'Highlands Ranch', 'Lone Tree'],
          'Larimer': ['Fort Collins', 'Loveland', 'Wellington', 'Timnath', 'Berthoud'],
          'El Paso': ['Southeast', 'Fountain', 'Security-Widefield', 'Northeast', 'Westside', 'Old Colorado City'],
          'Broomfield': ['Broomfield']
        };
        return neighborhoods[county] || [];
      };

      // Get Area Median Income for county (2024 estimates)
      const getAMI = (county) => {
        const amiByCounty = {
          'Denver': 106700,
          'Boulder': 115000,
          'Jefferson': 106700,
          'Adams': 106700,
          'Arapahoe': 106700,
          'Douglas': 106700,
          'Broomfield': 106700,
          'Larimer': 95000,
          'El Paso': 85000,
          'Weld': 90000
        };
        return amiByCounty[county] || 100000;
      };

      // Rate update tracking
      const RATE_UPDATE_DATE = '2025-01-27';

      const lenders = [
        // CREDIT UNIONS (Often best for DPA)
        {
          name: 'Elevations Credit Union',
          programs: ['chfa-grant', 'chfa-second', 'idf-boulder', 'boulder-h2o', 'metro-dpa', 'chac-loan'],
          specialties: ['Stacked financing', 'Complex DPA cases', 'Excellent member service'],
          rating: 4.8,
          avgDays: 42,
          phone: '(303) 443-4672',
          counties: ['Boulder', 'Denver', 'Jefferson', 'Larimer'],
          notes: 'Highly recommended by Boulder County housing counselors'
        },
        {
          name: 'Premier Members Credit Union',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa', 'chac-loan'],
          specialties: ['Metro DPA expert', 'Fast processing', 'First-time buyer focus'],
          rating: 4.7,
          avgDays: 38,
          phone: '(303) 657-8500',
          counties: ['Denver', 'Adams', 'Arapahoe', 'Jefferson'],
          notes: 'Specializes in MetroDPA and CHFA programs'
        },
        {
          name: 'Ent Credit Union',
          programs: ['chfa-grant', 'chfa-second', 'chac-loan', 'va-loan', 'usda-rural'],
          specialties: ['Military-friendly', 'Strong in Southern Colorado', 'VA Loan Expert'],
          rating: 4.6,
          avgDays: 45,
          phone: '(719) 574-1100',
          counties: ['El Paso', 'Pueblo', 'Denver'],
          notes: 'Strong presence in Colorado Springs area, excellent for veterans'
        },
        {
          name: 'Bellco Credit Union',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa'],
          specialties: ['Large statewide presence', 'Member education programs'],
          rating: 4.5,
          avgDays: 44,
          phone: '(303) 795-5000',
          counties: ['all'],
          notes: 'Offices throughout Colorado'
        },
        {
          name: 'Canvas Credit Union',
          programs: ['chfa-grant', 'chfa-second', 'chac-loan'],
          specialties: ['Northern Colorado focus', 'Homebuyer education'],
          rating: 4.6,
          avgDays: 43,
          phone: '(303) 295-5190',
          counties: ['Larimer', 'Boulder', 'Weld'],
          notes: 'Strong in Fort Collins/Greeley area'
        },
        // COMMUNITY BANKS
        {
          name: 'FirstBank',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa'],
          specialties: ['Colorado-based', 'Relationship banking'],
          rating: 4.4,
          avgDays: 47,
          phone: '(303) 761-1600',
          counties: ['all'],
          notes: 'Colorado-headquartered community bank'
        },
        {
          name: 'Bank of Colorado',
          programs: ['chfa-grant', 'chfa-second', 'usda-rural', 'farmer-rancher'],
          specialties: ['Rural Colorado expert', 'Agricultural lending', 'USDA Loans'],
          rating: 4.3,
          avgDays: 50,
          phone: '(970) 243-7070',
          counties: ['all'],
          notes: 'Strong in Western Slope communities, best for rural properties'
        },
        {
          name: 'NBH Bank',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa', 'chac-loan'],
          specialties: ['Bilingual services', 'Diverse communities'],
          rating: 4.5,
          avgDays: 46,
          phone: '(303) 256-3500',
          counties: ['Denver', 'Adams', 'Jefferson'],
          notes: 'Spanish-language services available'
        },
        // MORTGAGE COMPANIES / BROKERS
        {
          name: 'Citywide Home Loans',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa', 'chac-loan', 'idf-boulder', 'fha-203k', 'second-chance', 'refugee-homeownership'],
          specialties: ['DPA specialists', 'Bilingual loan officers', 'Fast closings', 'Second Chance programs'],
          rating: 4.6,
          avgDays: 40,
          phone: '(303) 285-2100',
          counties: ['all'],
          notes: 'One of the largest DPA originators in Colorado, works with credit-challenged buyers'
        },
        {
          name: 'Fairway Independent Mortgage',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa', 'va-loan', 'fha-203k', 'homes-for-heroes'],
          specialties: ['Technology-enabled process', 'Fast approvals', 'Homes for Heroes partner'],
          rating: 4.4,
          avgDays: 42,
          phone: '(720) 428-4000',
          counties: ['all'],
          notes: 'Multiple branch locations statewide, Homes for Heroes affiliate'
        },
        {
          name: 'Academy Mortgage',
          programs: ['chfa-grant', 'chfa-second', 'chac-loan'],
          specialties: ['Competitive rates', 'Purchase focus'],
          rating: 4.3,
          avgDays: 45,
          phone: '(720) 257-8130',
          counties: ['all'],
          notes: 'National lender with strong Colorado presence'
        },
        {
          name: 'Colorado Mortgage Company',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa', 'idf-boulder'],
          specialties: ['Colorado-only focus', 'Complex financing'],
          rating: 4.7,
          avgDays: 41,
          phone: '(303) 862-5626',
          counties: ['all'],
          notes: 'Exclusively serves Colorado borrowers'
        },
        {
          name: 'Guaranteed Rate',
          programs: ['chfa-grant', 'chfa-second'],
          specialties: ['Digital mortgage process', 'Rate transparency'],
          rating: 4.2,
          avgDays: 44,
          phone: '(720) 446-8786',
          counties: ['all'],
          notes: 'Tech-forward mortgage experience'
        },
        {
          name: 'Movement Mortgage',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa'],
          specialties: ['Fast closings', 'Purchase specialists'],
          rating: 4.3,
          avgDays: 40,
          phone: '(720) 372-4000',
          counties: ['Denver', 'Boulder', 'El Paso'],
          notes: 'Known for quick purchase transactions'
        },
        {
          name: 'Cherry Creek Mortgage',
          programs: ['chfa-grant', 'chfa-second', 'idf-boulder', 'metro-dpa', 'chac-loan'],
          specialties: ['Full-service broker', 'Stacked financing expert'],
          rating: 4.8,
          avgDays: 43,
          phone: '(303) 813-3100',
          counties: ['all'],
          notes: 'Highly rated for complex DPA scenarios'
        },
        // NATIONAL LENDERS WITH COLORADO PRESENCE
        {
          name: 'Guild Mortgage',
          programs: ['chfa-grant', 'chfa-second', 'va-loan', 'usda-rural', 'fha-203k', 'section-184'],
          specialties: ['National reach', 'Government loan expert', 'VA/FHA Specialist'],
          rating: 4.2,
          avgDays: 48,
          phone: '(720) 515-5900',
          counties: ['all'],
          notes: 'Strong FHA/VA expertise, Section 184 approved'
        },
        {
          name: 'Caliber Home Loans',
          programs: ['chfa-grant', 'chfa-second', 'metro-dpa'],
          specialties: ['Large volume lender', 'Streamlined process'],
          rating: 4.1,
          avgDays: 46,
          phone: '(720) 482-7000',
          counties: ['all'],
          notes: 'High-volume DPA originator'
        },
        {
          name: 'Union Home Mortgage',
          programs: ['chfa-grant', 'chfa-second'],
          specialties: ['Personalized service', 'Local decision making'],
          rating: 4.3,
          avgDays: 47,
          phone: '(720) 748-3200',
          counties: ['Denver', 'Boulder', 'Jefferson'],
          notes: 'Boutique experience with local underwriting'
        },
        // REGIONAL SPECIALISTS
        {
          name: 'Pinnacle Bank Mortgage',
          programs: ['chfa-grant', 'chfa-second'],
          specialties: ['Western Slope expert', 'Rural properties'],
          rating: 4.4,
          avgDays: 50,
          phone: '(970) 241-1600',
          counties: ['Mesa', 'Montrose', 'Delta', 'Garfield'],
          notes: 'Best for Grand Junction area'
        },
        {
          name: 'Security Service Federal Credit Union',
          programs: ['chfa-grant', 'chfa-second', 'chac-loan'],
          specialties: ['Military focus', 'Southern Colorado'],
          rating: 4.5,
          avgDays: 44,
          phone: '(719) 380-4000',
          counties: ['El Paso', 'Pueblo'],
          notes: 'Especially strong with military families'
        },
        // ITIN SPECIALISTS
        {
          name: 'New American Funding',
          programs: ['itin-loan'],
          specialties: ['ITIN loans', 'Non-QM lending', 'Bilingual services'],
          rating: 4.4,
          avgDays: 50,
          phone: '(800) 450-2010',
          counties: ['all'],
          notes: 'One of the largest ITIN loan originators nationally. Bilingual loan officers available.'
        },
        {
          name: 'Alterra Home Loans',
          programs: ['itin-loan'],
          specialties: ['ITIN specialist', 'Non-traditional income', 'Spanish-speaking staff'],
          rating: 4.3,
          avgDays: 52,
          phone: '(303) 371-0000',
          counties: ['Denver', 'Adams', 'Arapahoe', 'Jefferson'],
          notes: 'Colorado-focused ITIN lender with flexible documentation requirements'
        }
      ];

      // Recommended realtors by county (DPA-experienced agents)
      const realtors = [
        {
          name: 'Maria Santos',
          brokerage: 'Keller Williams Realty',
          phone: '(303) 555-0123',
          specialties: ['First-time buyers', 'DPA programs', 'Spanish-speaking'],
          counties: ['Denver', 'Adams', 'Arapahoe'],
          rating: 4.9
        },
        {
          name: 'James Mitchell',
          brokerage: 'RE/MAX Alliance',
          phone: '(303) 555-0456',
          specialties: ['First-time buyers', 'Affordable housing', 'CLT properties'],
          counties: ['Boulder', 'Broomfield', 'Jefferson'],
          rating: 4.8
        },
        {
          name: 'Sarah Johnson',
          brokerage: 'Compass Colorado',
          phone: '(720) 555-0789',
          specialties: ['DPA transactions', 'New construction', 'Condos'],
          counties: ['Denver', 'Jefferson', 'Douglas'],
          rating: 4.7
        },
        {
          name: 'Michael Chen',
          brokerage: 'eXp Realty',
          phone: '(303) 555-0147',
          specialties: ['First-time buyers', 'Investment properties', 'Multilingual'],
          counties: ['Denver', 'Arapahoe', 'Adams'],
          rating: 4.8
        },
        {
          name: 'Lisa Martinez',
          brokerage: 'The Group Real Estate',
          phone: '(970) 555-0258',
          specialties: ['Northern Colorado', 'First-time buyers', 'Rural properties'],
          counties: ['Larimer', 'Weld'],
          rating: 4.9
        },
        {
          name: 'David Thompson',
          brokerage: 'Coldwell Banker',
          phone: '(719) 555-0369',
          specialties: ['Southern Colorado', 'DPA programs', 'Military families'],
          counties: ['El Paso', 'Pueblo'],
          rating: 4.7
        },
        {
          name: 'Jennifer Williams',
          brokerage: 'LIV Sotheby\'s',
          phone: '(970) 555-0471',
          specialties: ['Mountain communities', 'Deed-restricted housing', 'Workforce housing'],
          counties: ['Summit', 'Eagle', 'Pitkin', 'Routt'],
          rating: 4.8
        }
      ];

      // Get realtors for a county
      const getRealtorsForCounty = (county) => {
        return realtors.filter(r => r.counties.includes(county) || r.counties.includes('all'));
      };

      // Calculate estimated interest rate based on programs, credit score, and down payment
      const calculateEstimatedRate = (programIds, creditScore, downPaymentPercent) => {
        // Base market rate (update this periodically with RATE_UPDATE_DATE)
        let baseRate = 0.065; // 6.5% - representative mid-2025 rate

        // Adjust for program type
        const hasCHFAGrant = programIds.includes('chfa-grant');
        const hasCHFASecond = programIds.includes('chfa-second');
        const hasMetroDPA = programIds.includes('metro-dpa');

        if (hasCHFAGrant) {
          baseRate += 0.004; // Grant typically adds ~0.4% to rate
        }
        if (hasMetroDPA) {
          baseRate += 0.002; // MetroDPA adds ~0.2%
        }
        // CHFA Second Mortgage typically doesn't add to rate

        // Adjust for credit score
        const scoreNum = parseInt(creditScore) || 700;
        if (scoreNum >= 760) {
          baseRate -= 0.0025; // Excellent credit: -0.25%
        } else if (scoreNum >= 700) {
          baseRate += 0.0; // Good credit: no adjustment
        } else if (scoreNum >= 650) {
          baseRate += 0.0025; // Fair credit: +0.25%
        } else if (scoreNum >= 620) {
          baseRate += 0.005; // Minimum credit: +0.5%
        } else {
          baseRate += 0.0075; // Below minimum: +0.75%
        }

        // Adjust for LTV (down payment %)
        if (downPaymentPercent >= 20) {
          baseRate -= 0.001; // 20%+ down: -0.1%
        } else if (downPaymentPercent < 10) {
          baseRate += 0.002; // <10% down: +0.2%
        }

        // Return as range (Â± 0.25%)
        const lowRate = baseRate - 0.0025;
        const highRate = baseRate + 0.0025;

        return {
          low: lowRate,
          high: highRate,
          mid: baseRate,
          lowPercent: (lowRate * 100).toFixed(2),
          highPercent: (highRate * 100).toFixed(2),
          midPercent: (baseRate * 100).toFixed(2)
        };
      };

      // Find best lender(s) for a program combination
      const getLenderMatch = (programIds) => {
        if (!programIds || programIds.length === 0) return null;

        // Filter lenders who can handle ALL programs in the package
        const compatibleLenders = lenders.filter(lender =>
          programIds.every(pid => lender.programs.includes(pid))
        );

        const isComplex = programIds.length >= 2;

        // Sort by rating (desc), specialty match, then avgDays (asc)
        const sortedLenders = compatibleLenders.sort((a, b) => {
          // Primary: rating
          if (b.rating !== a.rating) return b.rating - a.rating;
          // Secondary: specialty match for complex packages
          if (isComplex) {
            const aHasStacked = a.specialties.some(s => s.toLowerCase().includes('stacked') || s.toLowerCase().includes('complex'));
            const bHasStacked = b.specialties.some(s => s.toLowerCase().includes('stacked') || s.toLowerCase().includes('complex'));
            if (bHasStacked && !aHasStacked) return 1;
            if (aHasStacked && !bHasStacked) return -1;
          }
          // Tertiary: avgDays (lower is better)
          return a.avgDays - b.avgDays;
        });

        if (sortedLenders.length === 0) {
          // No single lender can handle all programs - need multiple lenders
          const lenderCoverage = [];
          programIds.forEach(pid => {
            const matchingLenders = lenders.filter(l => l.programs.includes(pid));
            if (matchingLenders.length > 0) {
              // Find best lender for this specific program
              const bestForProgram = matchingLenders.sort((a, b) => b.rating - a.rating)[0];
              const existing = lenderCoverage.find(lc => lc.lender.name === bestForProgram.name);
              if (existing) {
                existing.programs.push(pid);
              } else {
                lenderCoverage.push({ lender: bestForProgram, programs: [pid] });
              }
            }
          });
          return {
            type: 'multiple',
            lenders: lenderCoverage,
            needsCoordination: true
          };
        }

        // Check for ties (same rating, similar days)
        const topRating = sortedLenders[0].rating;
        const topDays = sortedLenders[0].avgDays;
        const tied = sortedLenders.filter(l =>
          l.rating === topRating && Math.abs(l.avgDays - topDays) <= 5
        );

        if (tied.length > 1 && programIds.length > 1) {
          return {
            type: 'tied',
            lenders: tied.slice(0, 2),
            needsCoordination: false
          };
        }

        // Simple package with single program - show top 3
        if (programIds.length === 1 && sortedLenders.length >= 2) {
          return {
            type: 'simple',
            lenders: sortedLenders.slice(0, 3),
            needsCoordination: false
          };
        }

        // Single best lender
        return {
          type: 'single',
          lender: sortedLenders[0],
          needsCoordination: false
        };
      };

      // Housing counseling agencies for fallback
      const housingCounselors = [
        { name: 'Impact Development Fund', phone: '(970) 494-2021' },
        { name: 'CHAC', phone: '(303) 572-9445' },
        { name: 'Brothers Redevelopment', phone: '(303) 202-6340' }
      ];

      // ============================================
      // HOME-FIRST FLOW HELPER FUNCTIONS
      // ============================================

      // Calculate maximum assistance available for this user
      const calculateMaxAssistance = () => {
        const eligible = getEligiblePrograms();
        let maxTotal = 0;
        eligible.forEach(p => {
          if (p.calcAmount) {
            maxTotal += p.calcAmount(500000); // Use 500k as reference
          }
        });
        return Math.min(maxTotal, 75000); // Cap for display
      };

      // Calculate assistance available for a specific home
      const calculateAssistanceForHome = (listing) => {
        const eligible = getEligiblePrograms();
        const validCombos = generateCombinations(eligible);

        if (validCombos.length === 0) {
          return {
            total: 0,
            programs: [],
            yourDownPayment: Math.max(0, listing.price * 0.035)
          };
        }

        // Score and sort combinations
        const scored = validCombos.map(combo => {
          const metrics = calculateCombinationMetrics(combo, listing.price, parseInt(formData.downPaymentSaved) || 0, formData.creditScore);
          return { combo, metrics };
        }).sort((a, b) => b.metrics.totalAssistance - a.metrics.totalAssistance);

        const best = scored[0];
        const userSavings = parseInt(formData.downPaymentSaved) || 0;
        const minDown = listing.price * 0.035;
        const totalDown = userSavings + best.metrics.totalAssistance;
        const yourDownPayment = Math.max(0, minDown - best.metrics.totalAssistance);

        return {
          total: best.metrics.totalAssistance,
          programs: best.combo.map(id => programs.find(p => p.id === id)),
          yourDownPayment: Math.round(yourDownPayment)
        };
      };

      // Calculate monthly payment for a home with assistance
      const calculateMonthlyPayment = (listing, assistance) => {
        const userSavings = parseInt(formData.downPaymentSaved) || 0;
        const totalDown = userSavings + assistance.total;
        const loanAmount = Math.max(0, listing.price - totalDown);
        const rate = 0.065; // Base rate estimate
        const monthlyRate = rate / 12;
        const numPayments = 360;

        let payment = 0;
        if (loanAmount > 0) {
          payment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                    (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        // Add estimated taxes and insurance
        const taxes = (listing.price * 0.007) / 12; // ~0.7% annual
        const insurance = 150; // Estimate
        const pmi = loanAmount > listing.price * 0.80 ? (loanAmount * 0.005) / 12 : 0;

        const total = payment + taxes + insurance + pmi;

        return {
          low: Math.round(total - 75),
          high: Math.round(total + 75)
        };
      };

      // Filter listings based on user criteria
      const getFilteredListings = () => {
        return sampleListings.filter(listing => {
          // County match
          if (listing.county !== formData.location) return false;

          // Listing type preference
          if (formData.listingType !== 'all' && listing.listingType !== formData.listingType) return false;

          // Bedrooms
          if (formData.bedrooms !== 'any') {
            const minBeds = formData.bedrooms === '4' ? 4 : parseInt(formData.bedrooms);
            if (listing.bedrooms < minBeds) return false;
          }

          // Bathrooms
          if (formData.bathrooms !== 'any') {
            const minBaths = parseFloat(formData.bathrooms);
            if (listing.bathrooms < minBaths) return false;
          }

          // Property type
          if (formData.propertyType !== 'Any' && listing.propertyType !== formData.propertyType) return false;

          // Neighborhood preference (if selected)
          if (formData.neighborhoods?.length > 0 && !formData.neighborhoods.includes(listing.neighborhood)) return false;

          // Income restriction check
          if (listing.maxIncome) {
            const userAMIPercent = (parseInt(formData.income) / getAMI(listing.county)) * 100;
            if (userAMIPercent > listing.maxIncome) return false;
          }

          return true;
        });
      };

      // Toggle home selection
      const toggleHomeSelection = (homeId) => {
        const current = formData.selectedHomes || [];
        if (current.includes(homeId)) {
          setFormData({...formData, selectedHomes: current.filter(id => id !== homeId)});
        } else {
          setFormData({...formData, selectedHomes: [...current, homeId]});
        }
      };

      // Calculate all assistance packages for a specific home
      const calculatePackagesForHome = (home) => {
        const eligible = getEligiblePrograms();
        const validCombos = generateCombinations(eligible);

        const packages = validCombos.map(combo => {
          const metrics = calculateCombinationMetrics(combo, home.price, parseInt(formData.downPaymentSaved) || 0, formData.creditScore);
          const lenderMatch = getLenderMatch(combo);
          const monthlyPayment = calculateMonthlyPayment(home, { total: metrics.totalAssistance });
          const userSavings = parseInt(formData.downPaymentSaved) || 0;
          const minDown = home.price * 0.035;

          return {
            programs: combo.map(id => {
              const p = programs.find(pr => pr.id === id);
              return {
                id: p.id,
                name: p.name,
                amount: p.calcAmount ? p.calcAmount(home.price) : 0
              };
            }),
            totalAssistance: metrics.totalAssistance,
            monthlyPayment: monthlyPayment.low,
            yourDownPayment: Math.max(0, Math.round(minDown - metrics.totalAssistance)),
            recommendedLender: lenderMatch,
            metrics
          };
        });

        // Sort by total assistance (descending) but ensure variety
        const sorted = packages.sort((a, b) => b.totalAssistance - a.totalAssistance);

        // Ensure we show both CHFA and non-CHFA options if available
        const hasCHFA = pkg => pkg.programs.some(p => p.id === 'chfa-grant' || p.id === 'chfa-second');
        const hasMetroDPA = pkg => pkg.programs.some(p => p.id === 'metro-dpa');

        const chfaPackages = sorted.filter(hasCHFA);
        const metroDPAPackages = sorted.filter(hasMetroDPA);
        const otherPackages = sorted.filter(pkg => !hasCHFA(pkg) && !hasMetroDPA(pkg));

        // Build result: top packages plus ensure CHFA representation
        const result = [];
        const seen = new Set();

        // Add top 3 overall
        sorted.slice(0, 3).forEach(pkg => {
          const key = pkg.programs.map(p => p.id).sort().join(',');
          if (!seen.has(key)) {
            seen.add(key);
            result.push(pkg);
          }
        });

        // Ensure at least one CHFA option if available and not already included
        if (chfaPackages.length > 0 && !result.some(hasCHFA)) {
          const key = chfaPackages[0].programs.map(p => p.id).sort().join(',');
          if (!seen.has(key)) {
            seen.add(key);
            result.push(chfaPackages[0]);
          }
        }

        // Ensure at least one MetroDPA option if available and not already included
        if (metroDPAPackages.length > 0 && !result.some(hasMetroDPA)) {
          const key = metroDPAPackages[0].programs.map(p => p.id).sort().join(',');
          if (!seen.has(key)) {
            seen.add(key);
            result.push(metroDPAPackages[0]);
          }
        }

        // Fill remaining slots up to 5
        for (const pkg of sorted) {
          if (result.length >= 5) break;
          const key = pkg.programs.map(p => p.id).sort().join(',');
          if (!seen.has(key)) {
            seen.add(key);
            result.push(pkg);
          }
        }

        // Re-sort by total assistance
        return result.sort((a, b) => b.totalAssistance - a.totalAssistance);
      };

      // Select a package for a home and move to roadmap
      const selectPackageForHome = (homeId, pkg) => {
        const home = sampleListings.find(l => l.id === homeId);
        setFormData({
          ...formData,
          purchasePrice: home.price.toString(),
          selectedPrograms: pkg.programs.map(p => p.id),
          recommendedLender: pkg.recommendedLender
        });
        setStep(3); // Go to Prepare
      };

      // Generate lender package for a specific home
      const generateLenderPackageForHome = (home, pkg) => {
        // Set form data to this home/package, then call generateLenderPackage
        setFormData({
          ...formData,
          purchasePrice: home.price.toString(),
          selectedPrograms: pkg.programs.map(p => p.id),
          recommendedLender: pkg.recommendedLender
        });
        // Small delay to let state update
        setTimeout(() => generateLenderPackage(), 100);
      };

      // Generate printable lender package HTML document
      const generateLenderPackage = () => {
        const purchasePrice = parseInt(formData.purchasePrice) || 450000;
        const downPaymentSaved = parseInt(formData.downPaymentSaved) || 0;
        const creditAssessment = assessCreditReadiness(formData.creditScore);

        // Calculate total assistance from selected programs
        let totalAssistance = 0;
        let programBreakdown = [];

        formData.selectedPrograms.forEach(id => {
          const program = programs.find(p => p.id === id);
          if (program && program.calcAmount) {
            const amount = program.calcAmount(purchasePrice);
            totalAssistance += amount;
            const terms = getRepaymentTerms(id, amount);
            programBreakdown.push({
              name: program.name,
              amount: amount,
              terms: terms
            });
          }
        });

        const totalDownPayment = downPaymentSaved + totalAssistance;
        const loanAmount = purchasePrice - totalDownPayment;

        // Get lender info
        const lender = formData.recommendedLender;
        const lenderName = lender ? (lender.matchType === 'multiple' ? 'Multiple Lenders Required' : lender.name) : 'To be determined';
        const lenderPhone = lender && lender.matchType !== 'multiple' ? lender.phone : '';

        // Get credit score display
        const getCreditScoreDisplay = () => {
          if (!formData.creditScore) return 'Not provided';
          return formData.creditScore;
        };

        // Format date
        const today = new Date();
        const formattedDate = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

        // Build program details section
        const programDetailsHtml = programBreakdown.map(p => `
          <tr>
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${p.name}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb; text-align: right;">${formatCurrency(p.amount)}</td>
            <td style="padding: 12px; border-bottom: 1px solid #e5e7eb;">${p.terms.shortDesc}</td>
          </tr>
        `).join('');

        // Build lender section
        let lenderSectionHtml = '';
        if (lender && lender.matchType === 'multiple') {
          lenderSectionHtml = `
            <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
              <h3 style="color: #92400e; margin: 0 0 12px 0; font-size: 16px;">âš ï¸ Multiple Lenders Required</h3>
              <p style="color: #78350f; margin: 0 0 12px 0; font-size: 14px;">This program combination requires coordination between lenders:</p>
              <ul style="margin: 0; padding-left: 20px; color: #78350f;">
                ${lender.lenders.map(lc => `
                  <li style="margin-bottom: 8px;">
                    <strong>${lc.lender.name}</strong> (${lc.lender.phone})<br>
                    <span style="font-size: 13px;">For: ${lc.programs.map(pid => programs.find(p => p.id === pid)?.name).join(', ')}</span>
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        } else if (lender) {
          lenderSectionHtml = `
            <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
              <h3 style="color: #1e40af; margin: 0 0 8px 0; font-size: 16px;">ðŸ“ž Recommended Lender</h3>
              <p style="color: #1e3a8a; margin: 0; font-size: 18px; font-weight: bold;">${lender.name}</p>
              ${lenderPhone ? `<p style="color: #1e40af; margin: 4px 0 0 0;">${lenderPhone}</p>` : ''}
              ${lender.specialties ? `<p style="color: #3b82f6; margin: 8px 0 0 0; font-size: 13px;">Specializes in: ${lender.specialties.join(', ')}</p>` : ''}
              ${lender.avgDays ? `<p style="color: #3b82f6; margin: 4px 0 0 0; font-size: 13px;">Average processing: ${lender.avgDays} days</p>` : ''}
            </div>
          `;
        }

        // Credit readiness section
        const creditColorMap = {
          'green': { bg: '#dcfce7', border: '#22c55e', text: '#166534' },
          'yellow': { bg: '#fef9c3', border: '#eab308', text: '#854d0e' },
          'orange': { bg: '#fed7aa', border: '#f97316', text: '#9a3412' },
          'red': { bg: '#fecaca', border: '#ef4444', text: '#991b1b' },
          'gray': { bg: '#f3f4f6', border: '#9ca3af', text: '#4b5563' }
        };
        const creditColors = creditColorMap[creditAssessment.color] || creditColorMap.gray;

        const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lender Package - ${formattedDate}</title>
  <style>
    @media print {
      body { margin: 0; }
      .no-print { display: none !important; }
      .page-break { page-break-after: always; }
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.5;
      color: #1f2937;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; background: #f3f4f6; padding: 12px; }
  </style>
</head>
<body>
  <div class="no-print" style="background: #dbeafe; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
    <p style="margin: 0; color: #1e40af;">
      <strong>ðŸ“„ Lender Package</strong> - Print this page (Ctrl/Cmd + P) or save as PDF to bring to your lender appointment.
    </p>
    <button onclick="window.print()" style="margin-top: 12px; background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
      ðŸ–¨ï¸ Print / Save as PDF
    </button>
  </div>

  <!-- Header -->
  <div style="border-bottom: 3px solid #2563eb; padding-bottom: 20px; margin-bottom: 24px;">
    <h1 style="margin: 0 0 4px 0; color: #1e40af; font-size: 24px;">Colorado Homebuyer Assistance Package</h1>
    <p style="margin: 0; color: #6b7280; font-size: 14px;">Generated ${formattedDate} via Gary Community Ventures Navigator</p>
  </div>

  <!-- Applicant Profile -->
  <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
    <h2 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">ðŸ‘¤ Applicant Profile</h2>
    <table>
      <tr>
        <td style="padding: 8px 0; color: #6b7280; width: 40%;">County/Location</td>
        <td style="padding: 8px 0; font-weight: 500;">${formData.location || 'Not specified'}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #6b7280;">Household Income</td>
        <td style="padding: 8px 0; font-weight: 500;">${formData.income ? formatCurrency(parseInt(formData.income)) : 'Not specified'}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #6b7280;">Household Size</td>
        <td style="padding: 8px 0; font-weight: 500;">${formData.householdSize} person(s)</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #6b7280;">First-Time Homebuyer</td>
        <td style="padding: 8px 0; font-weight: 500;">${formData.firstTimeBuyer ? 'Yes' : 'No'}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #6b7280;">Credit Score Range</td>
        <td style="padding: 8px 0; font-weight: 500;">${getCreditScoreDisplay()}</td>
      </tr>
      ${formData.occupation ? `
      <tr>
        <td style="padding: 8px 0; color: #6b7280;">Occupation</td>
        <td style="padding: 8px 0; font-weight: 500;">${formData.occupation.replace('-', ' ').replace(/\b\w/g, c => c.toUpperCase())}</td>
      </tr>
      ` : ''}
      ${formData.veteranStatus ? `
      <tr>
        <td style="padding: 8px 0; color: #6b7280;">Veteran Status</td>
        <td style="padding: 8px 0; font-weight: 500;">Yes</td>
      </tr>
      ` : ''}
    </table>
  </div>

  <!-- Credit Assessment -->
  <div style="background: ${creditColors.bg}; border: 1px solid ${creditColors.border}; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
    <h3 style="margin: 0 0 8px 0; color: ${creditColors.text}; font-size: 16px;">ðŸ“Š Credit Readiness Assessment</h3>
    <p style="margin: 0; color: ${creditColors.text}; font-size: 14px;">
      <strong>Status:</strong> ${creditAssessment.message}
    </p>
    <p style="margin: 8px 0 0 0; color: ${creditColors.text}; font-size: 14px;">
      <strong>Estimated Approval Rate:</strong> ${creditAssessment.approvalRate}%
    </p>
  </div>

  <!-- Selected Programs -->
  <div style="margin-bottom: 24px;">
    <h2 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">ðŸ“‹ Selected Assistance Programs</h2>
    <table style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
      <thead>
        <tr style="background: #f3f4f6;">
          <th style="padding: 12px; text-align: left;">Program</th>
          <th style="padding: 12px; text-align: right;">Amount</th>
          <th style="padding: 12px; text-align: left;">Repayment Terms</th>
        </tr>
      </thead>
      <tbody>
        ${programDetailsHtml}
        <tr style="background: #f0fdf4;">
          <td style="padding: 12px; font-weight: bold;">Total Program Assistance</td>
          <td style="padding: 12px; text-align: right; font-weight: bold; color: #166534;">${formatCurrency(totalAssistance)}</td>
          <td style="padding: 12px;"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Financial Summary -->
  <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
    <h2 style="margin: 0 0 16px 0; color: #166534; font-size: 18px;">ðŸ’° Financial Summary</h2>
    <table>
      <tr>
        <td style="padding: 8px 0; color: #166534;">Target Purchase Price</td>
        <td style="padding: 8px 0; font-weight: 500; text-align: right;">${formatCurrency(purchasePrice)}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #166534;">Personal Savings for Down Payment</td>
        <td style="padding: 8px 0; font-weight: 500; text-align: right;">${formatCurrency(downPaymentSaved)}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #166534;">Program Assistance</td>
        <td style="padding: 8px 0; font-weight: 500; text-align: right;">${formatCurrency(totalAssistance)}</td>
      </tr>
      <tr style="border-top: 2px solid #22c55e;">
        <td style="padding: 12px 0 8px 0; color: #166534; font-weight: bold;">Total Down Payment</td>
        <td style="padding: 12px 0 8px 0; font-weight: bold; text-align: right; font-size: 18px;">${formatCurrency(totalDownPayment)}</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #166534;">Down Payment Percentage</td>
        <td style="padding: 8px 0; font-weight: 500; text-align: right;">${((totalDownPayment / purchasePrice) * 100).toFixed(1)}%</td>
      </tr>
      <tr>
        <td style="padding: 8px 0; color: #166534;">Estimated Loan Amount</td>
        <td style="padding: 8px 0; font-weight: 500; text-align: right;">${formatCurrency(loanAmount)}</td>
      </tr>
    </table>
  </div>

  <!-- Recommended Lender -->
  ${lenderSectionHtml}

  <!-- Required Documentation Checklist -->
  <div style="margin-bottom: 24px;">
    <h2 style="margin: 0 0 16px 0; color: #374151; font-size: 18px;">ðŸ“ Required Documentation</h2>
    <p style="color: #6b7280; margin: 0 0 12px 0; font-size: 14px;">Gather these documents before your lender appointment:</p>
    <table style="border: 1px solid #e5e7eb; border-radius: 8px;">
      <tr>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">â˜</td>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;"><strong>Photo ID</strong> - Driver's license or passport</td>
      </tr>
      <tr>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">â˜</td>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;"><strong>Income Verification</strong> - Last 2 years W-2s or tax returns</td>
      </tr>
      <tr>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">â˜</td>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;"><strong>Pay Stubs</strong> - Most recent 30 days</td>
      </tr>
      <tr>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">â˜</td>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;"><strong>Bank Statements</strong> - Last 2 months, all pages</td>
      </tr>
      <tr>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">â˜</td>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;"><strong>Employment Verification</strong> - HR contact info or employer letter</td>
      </tr>
      <tr>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;">â˜</td>
        <td style="padding: 10px; border-bottom: 1px solid #e5e7eb;"><strong>Homebuyer Education Certificate</strong> - If required by selected programs</td>
      </tr>
      <tr>
        <td style="padding: 10px;">â˜</td>
        <td style="padding: 10px;"><strong>Gift Letter</strong> - If receiving gift funds (if applicable)</td>
      </tr>
    </table>
  </div>

  <!-- Timeline -->
  <div style="background: #faf5ff; border: 1px solid #a855f7; border-radius: 8px; padding: 20px; margin-bottom: 24px;">
    <h2 style="margin: 0 0 16px 0; color: #7c3aed; font-size: 18px;">ðŸ“… Suggested Timeline</h2>
    <ol style="margin: 0; padding-left: 20px; color: #6b21a8;">
      <li style="margin-bottom: 8px;"><strong>Week 1:</strong> Complete homebuyer education course (if not done)</li>
      <li style="margin-bottom: 8px;"><strong>Week 2:</strong> Gather all required documentation</li>
      <li style="margin-bottom: 8px;"><strong>Week 3:</strong> Contact recommended lender, schedule pre-approval meeting</li>
      <li style="margin-bottom: 8px;"><strong>Week 4-6:</strong> Obtain pre-approval letter</li>
      <li style="margin-bottom: 8px;"><strong>Week 6+:</strong> Begin house hunting with real estate agent</li>
    </ol>
  </div>

  <!-- Important Notes -->
  <div style="background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
    <h3 style="margin: 0 0 12px 0; color: #92400e; font-size: 16px;">âš ï¸ Important Notes</h3>
    <ul style="margin: 0; padding-left: 20px; color: #78350f; font-size: 14px;">
      <li style="margin-bottom: 6px;">Program eligibility and funding availability may change. Verify current requirements with your lender.</li>
      <li style="margin-bottom: 6px;">Interest rates and assistance amounts shown are estimates only.</li>
      <li style="margin-bottom: 6px;">Some programs require specific lenders. Your lender will confirm which programs you can use together.</li>
      <li>This package is for informational purposes only and does not guarantee loan approval.</li>
    </ul>
  </div>

  <!-- Footer -->
  <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 24px;">
    <p style="margin: 0; color: #9ca3af; font-size: 12px; text-align: center;">
      Generated by Colorado Homebuyer Navigator â€¢ Gary Community Ventures<br>
      Questions? Contact a HUD-approved housing counseling agency for free assistance.
    </p>
  </div>
</body>
</html>
        `;

        // Create blob and download
        const blob = new Blob([htmlContent], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `lender-package-${today.toISOString().split('T')[0]}.html`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      };

      // Check eligibility
      const getEligiblePrograms = () => {
        const income = parseInt(formData.income) || 0;
        const county = formData.location;
        const occupation = formData.occupation;
        const isVeteran = formData.veteranStatus;
        const hasDisability = formData.hasDisability;
        const interestedInRenovation = formData.interestedInRenovation;
        const isNativeAmerican = formData.isNativeAmerican;
        const hasSSN = formData.hasSSN;

        return programs.filter(program => {
          // Income check
          if (income > program.incomeLimit) return false;

          // County check
          if (!program.counties.includes('all') && !program.counties.includes(county)) return false;

          // First-time buyer check
          if (program.requirements.includes('First-time buyer') && !formData.firstTimeBuyer) return false;

          // Disability-specific programs - only show if user selected disability option
          if (program.id === 'disability-housing' && !hasDisability) return false;

          // Renovation/fixer-upper programs - only show if user interested in renovation
          if ((program.id === 'fha-203k' || program.id === 'energy-efficient') && !interestedInRenovation) return false;

          // Native American loan - only show if user is enrolled tribal member
          if (program.id === 'section-184' && !isNativeAmerican) return false;

          // SSN requirement - most programs require SSN, only ITIN-friendly programs work without
          if (!hasSSN && !program.itinFriendly) return false;

          // Occupation-specific program check
          if (program.occupation) {
            // VA loan requires veteran status
            if (program.id === 'va-loan' && !isVeteran) return false;

            // Other occupation programs require matching occupation
            if (program.id !== 'va-loan') {
              const requiredOccupations = Array.isArray(program.occupation) ? program.occupation : [program.occupation];
              if (!occupation || !requiredOccupations.includes(occupation)) return false;
            }
          }

          // Veteran-only program (VA loan) - already handled above
          // Farmer-rancher needs farmer occupation
          if (program.id === 'farmer-rancher' && occupation !== 'farmer') return false;

          return true;
        });
      };

      // Check if a combination of programs is valid (no conflicts)
      const isValidCombination = (programIds) => {
        const hasCHFAGrant = programIds.includes('chfa-grant');
        const hasCHFASecond = programIds.includes('chfa-second');
        const hasMetroDPA = programIds.includes('metro-dpa');

        // CHFA Grant and CHFA Second are mutually exclusive
        if (hasCHFAGrant && hasCHFASecond) return false;

        // CHFA (either) and MetroDPA are mutually exclusive
        if ((hasCHFAGrant || hasCHFASecond) && hasMetroDPA) return false;

        // Boulder DPA programs are mutually exclusive (can't stack idf-boulder + boulder-h2o)
        const boulderDPAPrograms = ['idf-boulder', 'boulder-h2o'];
        const boulderDPACount = programIds.filter(id => boulderDPAPrograms.includes(id)).length;
        if (boulderDPACount > 1) return false;

        // County/city-specific DPA programs shouldn't stack with each other
        // User can have one state program (CHFA) + one local program, but not multiple local programs
        const localDPAPrograms = ['idf-boulder', 'boulder-h2o', 'metro-dpa'];
        const localDPACount = programIds.filter(id => localDPAPrograms.includes(id)).length;
        if (localDPACount > 1) return false;

        // Workforce housing programs are mutually exclusive (county-specific)
        const workforcePrograms = ['summit-workforce', 'eagle-workforce', 'pitkin-workforce', 'routt-yampa'];
        const workforceCount = programIds.filter(id => workforcePrograms.includes(id)).length;
        if (workforceCount > 1) return false;

        // Affordable housing program combination rules
        // CLTs can combine with some DPA (you still need down payment for CLT homes)
        // Habitat and Denver Shared Equity have their own financing - standalone only
        const standaloneAffordable = ['habitat-humanity', 'denver-shared-equity'];
        const combinableAffordable = ['elevation-clt', 'thistle-clt', 'chac-affordable', 'rmnp-workforce'];

        const hasStandaloneAffordable = programIds.some(id => standaloneAffordable.includes(id));
        const hasCombinableAffordable = programIds.some(id => combinableAffordable.includes(id));
        const affordableCount = programIds.filter(id => [...standaloneAffordable, ...combinableAffordable].includes(id)).length;

        // Standalone affordable programs (Habitat, Denver Shared Equity) can't combine with anything
        if (hasStandaloneAffordable && programIds.length > 1) return false;

        // Can't combine multiple affordable housing programs together
        if (affordableCount > 1) return false;

        // Combinable affordable housing (CLTs, CHAC, workforce) can pair with DPA programs
        // But not with occupation-specific or federal loan programs (VA, USDA)
        if (hasCombinableAffordable) {
          const federalLoanIds = ['va-loan', 'usda-rural', 'section-184', 'itin-loan'];
          const hasFederalLoan = programIds.some(id => federalLoanIds.includes(id));
          if (hasFederalLoan) return false;
        }

        return true;
      };

      // Generate all valid program combinations
      const generateCombinations = (eligibleProgramsList) => {
        const combinations = [];
        const ids = eligibleProgramsList.map(p => p.id);

        // Generate all subsets up to 3 programs
        for (let i = 0; i < ids.length; i++) {
          // Single program
          if (isValidCombination([ids[i]])) {
            combinations.push([ids[i]]);
          }

          for (let j = i + 1; j < ids.length; j++) {
            // Two programs
            if (isValidCombination([ids[i], ids[j]])) {
              combinations.push([ids[i], ids[j]]);
            }

            for (let k = j + 1; k < ids.length; k++) {
              // Three programs
              if (isValidCombination([ids[i], ids[j], ids[k]])) {
                combinations.push([ids[i], ids[j], ids[k]]);
              }
            }
          }
        }

        return combinations;
      };

      // Calculate metrics for a program combination
      const calculateCombinationMetrics = (programIds, purchasePrice, downPaymentSaved, creditScore) => {
        const selectedPrograms = programIds.map(id => programs.find(p => p.id === id));

        let totalAssistance = 0; // Only actual DPA (not affordable housing discounts)
        let totalGrants = 0;
        let totalDeferred = 0;
        let rateAdder = 0;
        let minForgiveness = null;
        let maxProcessingWeeks = 0;
        let needsEducation = false;
        let hasAffordableHousing = false;

        // Per-program breakdown for accurate repayment display
        const programBreakdown = [];

        selectedPrograms.forEach(program => {
          const amount = program.calcAmount(purchasePrice);

          // Only count actual DPA programs in totalAssistance, not affordable housing discounts
          if (!program.isAffordableHousing) {
            totalAssistance += amount;
          } else {
            hasAffordableHousing = true;
          }

          // Get repayment terms for this specific program
          const repaymentTerms = getRepaymentTerms(program.id, amount);

          // Add to breakdown
          programBreakdown.push({
            id: program.id,
            name: program.name,
            amount: amount,
            repayment: repaymentTerms
          });

          if (program.isGrant) {
            totalGrants += amount;
          } else if (program.isDeferred) {
            totalDeferred += amount;
          } else if (program.yearsToForgiveness !== null) {
            // Forgivable loan (like MetroDPA) - counts as grant after forgiveness period
            totalDeferred += amount; // Still owed until forgiven
          }

          rateAdder += program.rateAdder;

          if (program.yearsToForgiveness !== null) {
            if (minForgiveness === null || program.yearsToForgiveness < minForgiveness) {
              minForgiveness = program.yearsToForgiveness;
            }
          }

          maxProcessingWeeks = Math.max(maxProcessingWeeks, program.processingWeeks);

          if (program.requirements.some(r => r.toLowerCase().includes('education'))) {
            needsEducation = true;
          }
        });

        // Calculate what's owed at different time points
        const owedBefore3Years = programBreakdown.reduce((sum, p) => sum + p.repayment.owedAtSale(1), 0);
        const owedAfter3Years = programBreakdown.reduce((sum, p) => sum + p.repayment.owedAtSale(5), 0);

        // Calculate loan amount
        const effectiveDownPayment = downPaymentSaved + totalAssistance;
        const loanAmount = Math.max(0, purchasePrice - effectiveDownPayment);

        // Calculate down payment percentage for rate calculation
        const downPaymentPercent = (effectiveDownPayment / purchasePrice) * 100;

        // Get estimated rate range
        const estimatedRates = calculateEstimatedRate(programIds, creditScore, downPaymentPercent);

        // Calculate monthly payment with rate range
        const numPayments = 360;

        let monthlyPaymentLow = 0;
        let monthlyPaymentHigh = 0;
        let monthlyPaymentMid = 0;

        if (loanAmount > 0) {
          // Low payment (low rate)
          const lowMonthlyRate = estimatedRates.low / 12;
          monthlyPaymentLow = loanAmount * (lowMonthlyRate * Math.pow(1 + lowMonthlyRate, numPayments)) /
                              (Math.pow(1 + lowMonthlyRate, numPayments) - 1);

          // High payment (high rate)
          const highMonthlyRate = estimatedRates.high / 12;
          monthlyPaymentHigh = loanAmount * (highMonthlyRate * Math.pow(1 + highMonthlyRate, numPayments)) /
                               (Math.pow(1 + highMonthlyRate, numPayments) - 1);

          // Mid payment (for sorting/scoring)
          const midMonthlyRate = estimatedRates.mid / 12;
          monthlyPaymentMid = loanAmount * (midMonthlyRate * Math.pow(1 + midMonthlyRate, numPayments)) /
                              (Math.pow(1 + midMonthlyRate, numPayments) - 1);
        }

        // Check if needs multiple lenders
        const needsMultipleLenders = !lenders.some(lender =>
          programIds.every(id => lender.programs.includes(id))
        );

        // Complexity score
        const complexityScore =
          programIds.length +
          (needsEducation ? 1 : 0) +
          (needsMultipleLenders ? 2 : 0);

        // Down payment needed from buyer
        const downPaymentNeeded = Math.max(0, purchasePrice * 0.035 - totalAssistance); // 3.5% FHA minimum

        return {
          programIds,
          programNames: selectedPrograms.map(p => p.name),
          totalAssistance, // Only actual DPA, not affordable housing discounts
          totalGrants,
          totalDeferred,
          hasAffordableHousing,
          loanAmount,
          monthlyPayment: monthlyPaymentMid, // Keep for backward compatibility / scoring
          monthlyPaymentLow,
          monthlyPaymentHigh,
          monthlyPaymentMid,
          estimatedRates,
          yearsToForgiveness: minForgiveness,
          processingWeeks: maxProcessingWeeks,
          needsEducation,
          needsMultipleLenders,
          complexityScore,
          downPaymentNeeded,
          numApplications: programIds.length,
          // Per-program repayment breakdown
          programBreakdown,
          owedBefore3Years,
          owedAfter3Years
        };
      };

      // Score for a single priority
      const getScoreForPriority = (metrics, priority) => {
        switch (priority) {
          case 'max-assistance':
            return metrics.totalAssistance / 1000; // Normalize to reasonable range

          case 'low-payment':
            return metrics.monthlyPayment > 0 ? 10000 / metrics.monthlyPayment : 0;

          case 'fast-forgiveness':
            if (metrics.totalGrants > 0 && metrics.yearsToForgiveness === 0) return 100;
            if (metrics.yearsToForgiveness === 3) return 50;
            if (metrics.yearsToForgiveness !== null) return 10 / metrics.yearsToForgiveness;
            return 1;

          case 'simple':
            return 10 / metrics.complexityScore;

          default:
            return 0;
        }
      };

      // Score combination using weighted priorities (1st = 4x, 2nd = 2x, 3rd = 1.5x, 4th = 1x)
      const scoreCombination = (metrics, priorities, stayYears) => {
        if (!priorities || priorities.length === 0) {
          // Balanced default: total assistance minus deferred debt
          return metrics.totalAssistance - (metrics.totalDeferred * 0.3);
        }

        const weights = [4, 2, 1.5, 1];
        let totalScore = 0;

        priorities.forEach((priority, index) => {
          const weight = weights[index] || 1;
          const score = getScoreForPriority(metrics, priority);
          totalScore += score * weight;
        });

        return totalScore;
      };

      // Get stay duration in years
      const getStayYears = () => {
        switch (formData.stayDuration) {
          case '<3': return 2;
          case '3-5': return 4;
          case '5-10': return 7;
          case '10+': return 12;
          default: return 5;
        }
      };

      // Calculate recommendations
      const calculateRecommendations = useMemo(() => {
        const eligibleProgramsList = getEligiblePrograms();
        const purchasePrice = parseInt(formData.purchasePrice) || 0;
        const downPaymentSaved = parseInt(formData.downPaymentSaved) || 0;
        const creditScore = formData.creditScore || '700'; // Default to 700 if not provided
        const stayYears = getStayYears();

        if (purchasePrice <= 0 || eligibleProgramsList.length === 0) {
          return { recommendations: [], allCombinations: [] };
        }

        const combinations = generateCombinations(eligibleProgramsList);

        const scoredCombinations = combinations.map(combo => {
          const metrics = calculateCombinationMetrics(combo, purchasePrice, downPaymentSaved, creditScore);
          const score = scoreCombination(metrics, formData.priorities, stayYears);
          return { ...metrics, score };
        });

        // Sort by score descending
        scoredCombinations.sort((a, b) => b.score - a.score);

        return {
          recommendations: scoredCombinations.slice(0, 3),
          allCombinations: scoredCombinations
        };
      }, [formData.location, formData.income, formData.firstTimeBuyer, formData.downPaymentSaved, formData.priorities, formData.stayDuration, formData.creditScore]);

      // Get reason why recommendation is best
      const getRecommendationReason = (rec, priority) => {
        const reasons = [];
        const tradeoffs = [];

        switch (priority) {
          case 'max-assistance':
            reasons.push(`Provides ${formatCurrency(rec.totalAssistance)} in total assistance`);
            if (rec.totalGrants > 0) reasons.push(`${formatCurrency(rec.totalGrants)} is a grant you never repay`);
            if (rec.totalDeferred > 0) tradeoffs.push(`${formatCurrency(rec.totalDeferred)} is deferred and owed when you sell`);
            break;
          case 'low-payment':
            reasons.push(`Lowest estimated monthly payment at ${formatCurrency(rec.monthlyPayment)}`);
            reasons.push(`${formatCurrency(rec.totalAssistance)} reduces your loan amount`);
            if (rec.rate > 0.0625) tradeoffs.push(`Interest rate is ${(rec.rate * 100).toFixed(2)}% (slightly higher than conventional)`);
            break;
          case 'fast-forgiveness':
            if (rec.yearsToForgiveness === 0) {
              reasons.push(`${formatCurrency(rec.totalGrants)} is an immediate grant - no repayment ever`);
            } else if (rec.yearsToForgiveness === 3) {
              reasons.push(`Loan forgiven after just 3 years of ownership`);
            }
            if (rec.totalDeferred > 0) tradeoffs.push(`${formatCurrency(rec.totalDeferred)} remains as deferred debt`);
            break;
          case 'simple':
            reasons.push(`Only ${rec.numApplications} application${rec.numApplications > 1 ? 's' : ''} needed`);
            if (!rec.needsMultipleLenders) reasons.push('Single lender can handle everything');
            if (!rec.needsEducation) reasons.push('No homebuyer education required');
            else tradeoffs.push('Requires 8-hour homebuyer education course');
            break;
          default:
            reasons.push(`${formatCurrency(rec.totalAssistance)} total assistance`);
            reasons.push(`Estimated ${formatCurrency(rec.monthlyPayment)}/month payment`);
        }

        if (rec.needsMultipleLenders) tradeoffs.push('May need to work with multiple lenders');
        if (rec.processingWeeks > 4) tradeoffs.push(`Processing takes ${rec.processingWeeks}+ weeks`);

        return { reasons, tradeoffs };
      };

      // Get matching lenders
      const getMatchingLenders = () => {
        if (formData.selectedPrograms.length === 0) return [];

        return lenders.filter(lender => {
          return formData.selectedPrograms.every(programId =>
            lender.programs.includes(programId)
          );
        }).sort((a, b) => b.rating - a.rating);
      };

      // Generate checklist
      const generateChecklist = () => {
        const selectedProgramObjs = programs.filter(p => formData.selectedPrograms.includes(p.id));
        const needsEducation = selectedProgramObjs.some(p =>
          p.requirements.some(r => r.toLowerCase().includes('education'))
        );
        const hasBoulderH2O = formData.selectedPrograms.includes('boulder-h2o');
        const hasCHAC = formData.selectedPrograms.includes('chac-loan');
        const hasIDF = formData.selectedPrograms.some(id => id.startsWith('idf-'));

        return {
          now: [
            needsEducation && {
              task: 'Complete CHFA Homebuyer Education Class',
              time: '8 hours (self-paced online available)',
              cost: '$75 (eHome America) or Free (Neighbor to Neighbor)',
              why: hasBoulderH2O
                ? 'REQUIRED BEFORE making an offer for Boulder H2O'
                : 'Required for most DPA programs',
              urgent: hasBoulderH2O
            },
            {
              task: 'Gather Required Documents',
              time: '2-3 hours',
              cost: 'Free',
              why: 'You\'ll need these for every application'
            },
            {
              task: 'Check Your Credit Score',
              time: '30 minutes',
              cost: 'Free (annualcreditreport.com)',
              why: 'Most programs require 620+ credit score'
            },
            hasCHAC && {
              task: 'Schedule CHAC Borrower Counseling',
              time: '1 hour session',
              cost: 'Free',
              why: 'Required in addition to general homebuyer education',
              note: 'Schedule 2 weeks in advance'
            }
          ].filter(Boolean),
          searching: [
            {
              task: 'Get Pre-Approved with Participating Lender',
              time: '1-2 weeks',
              why: 'Required before applying to most programs',
              note: 'Use lenders from our recommended list'
            },
            hasIDF && {
              task: 'Submit IDF Application',
              time: '4-6 weeks processing',
              why: 'Long processing time - start early',
              urgent: true
            },
            {
              task: 'Start House Hunting',
              why: 'Know your budget after pre-approval'
            }
          ].filter(Boolean),
          offer: [
            {
              task: 'Verify Program Funding Status',
              why: 'Programs can run out of money',
              note: 'Call each program to confirm funds available'
            },
            {
              task: 'Submit Final DPA Applications',
              time: '1-2 weeks',
              why: 'After offer accepted, before closing'
            },
            {
              task: 'Schedule Closing',
              time: '45-60 days typical with DPA',
              why: 'DPA processing adds time vs. conventional loan'
            }
          ]
        };
      };

      const documents = [
        { id: 'tax-returns', name: '2 years tax returns (1040 + all schedules)', programs: 'All programs', category: 'income' },
        { id: 'pay-stubs', name: 'Last 30 days pay stubs', programs: 'All programs', category: 'income' },
        { id: 'bank-statements', name: '2 months bank statements', programs: 'All programs', category: 'assets' },
        { id: 'photo-id', name: 'Photo ID (driver\'s license)', programs: 'All programs', category: 'identity' },
        { id: 'ssn-card', name: 'Social Security card', programs: 'All programs', category: 'identity' },
        { id: 'homebuyer-cert', name: 'Homebuyer education certificate', programs: 'Most DPA programs', optional: 'Complete education first', category: 'program' },
        { id: 'pre-approval', name: 'Pre-approval letter (Form 1003)', programs: 'Required for applications', category: 'program' },
        { id: 'first-gen-proof', name: 'Proof of first-generation homebuyer status', programs: 'CHFA enhanced assistance', optional: 'If applicable', category: 'program' }
      ];

      // Handle document upload
      const handleDocumentUpload = (documentId, files) => {
        if (!files || files.length === 0) return;

        const newUploads = Array.from(files).map(file => ({
          id: `${documentId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          documentId: documentId,
          fileName: file.name,
          fileSize: file.size,
          fileType: file.type,
          uploadedAt: new Date().toISOString(),
          // In a real app, you'd upload to a server and store the URL
          // For this prototype, we'll store a local object URL
          previewUrl: URL.createObjectURL(file)
        }));

        setUploadedDocuments(prev => [...prev, ...newUploads]);
      };

      // Remove uploaded document
      const removeDocument = (uploadId) => {
        setUploadedDocuments(prev => {
          const doc = prev.find(d => d.id === uploadId);
          if (doc?.previewUrl) {
            URL.revokeObjectURL(doc.previewUrl);
          }
          return prev.filter(d => d.id !== uploadId);
        });
      };

      // Get uploads for a specific document type
      const getUploadsForDocument = (documentId) => {
        return uploadedDocuments.filter(u => u.documentId === documentId);
      };

      // Format file size
      const formatFileSize = (bytes) => {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      };

      const steps = [
        'Your Profile',
        'What You Qualify For',
        'Assistance Packages',
        'Prepare',
        'Select Realtor',
        'Get Pre-Approved',
        'Apply for DPA',
        'Feedback'
      ];

      const eligiblePrograms = getEligiblePrograms();
      const matchingLenders = getMatchingLenders();
      const checklist = formData.selectedPrograms.length > 0 ? generateChecklist() : null;
      const purchasePrice = parseInt(formData.purchasePrice) || 0;
      const downPaymentSaved = parseInt(formData.downPaymentSaved) || 0;

      // Handle selecting a recommendation
      const selectRecommendation = (rec, lenderMatch = null) => {
        // Determine the primary recommended lender
        let recommendedLender = null;
        if (lenderMatch) {
          if (lenderMatch.type === 'single') {
            recommendedLender = {
              ...lenderMatch.lender,
              matchType: 'single'
            };
          } else if (lenderMatch.type === 'tied' && lenderMatch.lenders.length > 0) {
            recommendedLender = {
              ...lenderMatch.lenders[0],
              matchType: 'tied',
              alternatives: lenderMatch.lenders.slice(1)
            };
          } else if (lenderMatch.type === 'simple' && lenderMatch.lenders.length > 0) {
            recommendedLender = {
              ...lenderMatch.lenders[0],
              matchType: 'simple',
              alternatives: lenderMatch.lenders.slice(1)
            };
          } else if (lenderMatch.type === 'multiple') {
            recommendedLender = {
              name: 'Multiple Lenders Required',
              matchType: 'multiple',
              lenders: lenderMatch.lenders
            };
          }
        }

        setFormData({
          ...formData,
          selectedPrograms: rec.programIds,
          recommendedLender: recommendedLender
        });
        setPickedOwnPrograms(false);
        setStep(3); // Go to Prepare
      };

      // Determine actual step to show (skip recommendation if only 1 program or picking own)
      const getActualStep = () => {
        if (step === 2 && eligiblePrograms.length <= 1) {
          return 3; // Skip to select programs if only 1 eligible
        }
        if (step === 3 && !pickedOwnPrograms && formData.selectedPrograms.length > 0) {
          return 4; // Skip manual selection if they chose a recommendation
        }
        return step;
      };

      // Get credit assessment
      const creditAssessment = assessCreditReadiness(formData.creditScore);

      // Navigation logic (Home-First Flow)
      const handleNext = () => {
        // Check credit score when leaving step 0
        if (step === 0) {
          const assessment = assessCreditReadiness(formData.creditScore);
          if ((assessment.status === 'not-ready' || assessment.status === 'challenging') && !creditWarningAcknowledged) {
            setShowCreditWarning(true);
            return;
          }
        }

        setStep(Math.min(steps.length - 1, step + 1));
      };

      // Handle credit warning acknowledgment
      const handleCreditWarningContinue = () => {
        setCreditWarningAcknowledged(true);
        setShowCreditWarning(false);
        setStep(1); // Go to Affordability
      };

      const handleCreditWarningBack = () => {
        setShowCreditWarning(false);
      };

      const handleBack = () => {
        setStep(Math.max(0, step - 1));
      };

      // Check if can proceed
      const canProceed = () => {
        if (step === 0) return formData.location && formData.income && formData.creditScore; // Profile
        if (step === 1) return true; // What You Qualify For - can proceed
        if (step === 2) return true; // Assistance Packages - can proceed
        if (step === 3) return true; // Prepare - can proceed even if not complete
        if (step === 4) return true; // Select Realtor - optional
        if (step === 5) return true; // Get Pre-Approved - can proceed to DPA
        if (step === 6) return true; // Apply for DPA
        if (step === steps.length - 1) return false; // Feedback - final step
        return true;
      };

      // Priority labels
      const priorityLabels = {
        'max-assistance': 'maximum down payment assistance',
        'low-payment': 'lowest monthly payment',
        'fast-forgiveness': 'fastest path to ownership',
        'simple': 'simplest process'
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
          {/* Header */}
          <div className="bg-gradient-to-r from-blue-600 via-blue-700 to-indigo-700 text-white shadow-lg">
            <div className="max-w-5xl mx-auto px-6 py-8">
              <div className="flex items-center gap-4 mb-3">
                <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                  <Icon name="Home" className="w-7 h-7 text-white" />
                </div>
                <div>
                  <h1 className="text-2xl md:text-3xl font-bold tracking-tight">Colorado Homebuyer Navigator</h1>
                  <p className="text-blue-100 text-sm md:text-base">Your personalized path to homeownership</p>
                </div>
              </div>

              {/* Progress Steps - Clickable */}
              <div className="mt-6">
                {/* Container with fixed height for circles */}
                <div className="relative h-10">
                  {/* Progress Line - centered vertically */}
                  <div className="absolute top-1/2 left-0 right-0 h-0.5 bg-white/30 -translate-y-1/2" style={{ left: '10%', right: '10%' }}>
                    <div
                      className="h-full bg-green-400 transition-all duration-500"
                      style={{ width: `${(step / (steps.length - 1)) * 100}%` }}
                    />
                  </div>
                  {/* Step circles */}
                  <div className="absolute inset-0 flex items-center justify-between" style={{ left: '5%', right: '5%', position: 'absolute' }}>
                    {steps.map((stepName, idx) => {
                      const isClickable = idx < step;
                      return (
                        <button
                          key={idx}
                          onClick={() => isClickable && setStep(idx)}
                          disabled={!isClickable}
                          className={`relative z-10 transition-all ${
                            isClickable ? 'cursor-pointer hover:scale-110' : 'cursor-default'
                          }`}
                          title={isClickable ? `Go back to ${stepName}` : ''}
                        >
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center font-semibold text-sm transition-all duration-300 ${
                            idx < step ? 'bg-green-400 text-white hover:bg-green-300' :
                            idx === step ? 'bg-white text-blue-700 shadow-lg ring-4 ring-white/30' :
                            'bg-white/30 text-white/70'
                          }`}>
                            {idx < step ? <Icon name="Check" className="w-5 h-5" /> : idx + 1}
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>
                {/* Step labels - separate row */}
                <div className="hidden md:flex justify-between mt-3" style={{ paddingLeft: '5%', paddingRight: '5%' }}>
                  {steps.map((stepName, idx) => (
                    <span
                      key={idx}
                      className={`text-xs font-medium text-center w-16 ${
                        idx === step ? 'text-white' : 'text-blue-200'
                      }`}
                    >
                      {stepName}
                    </span>
                  ))}
                </div>
                <p className="text-center text-blue-100 text-sm mt-3 md:hidden">{steps[step]}</p>
              </div>
            </div>
          </div>

          {/* Main Content */}
          <div className="max-w-5xl mx-auto px-4 md:px-6 py-8">
            <div className="bg-white rounded-2xl shadow-xl border border-gray-100 p-6 md:p-8">

            {/* Step 0: Intake */}
            {step === 0 && (
              <div className="space-y-8">
                <div className="text-center mb-8">
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Tell us about your situation</h2>
                  <p className="text-gray-500 max-w-2xl mx-auto">Answer a few questions to discover programs you qualify for and create your personalized homebuying roadmap.</p>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="block text-sm font-semibold text-gray-700">
                      Where are you looking to buy?
                    </label>
                    <select
                      className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 text-gray-900"
                      value={formData.location}
                      onChange={(e) => setFormData({...formData, location: e.target.value})}
                    >
                      <option value="">Select a county...</option>
                      <option value="Denver">Denver County</option>
                      <option value="Boulder">Boulder County</option>
                      <option value="Jefferson">Jefferson County</option>
                      <option value="Adams">Adams County</option>
                      <option value="Arapahoe">Arapahoe County</option>
                      <option value="Larimer">Larimer County</option>
                      <option value="El Paso">El Paso County</option>
                    </select>
                  </div>

                  <div className="space-y-2">
                    <label className="block text-sm font-semibold text-gray-700">
                      Annual household income
                    </label>
                    <div className="relative">
                      <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                      <input
                        type="number"
                        className="w-full p-4 pl-8 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200"
                        placeholder="75,000"
                        value={formData.income}
                        onChange={(e) => setFormData({...formData, income: e.target.value})}
                      />
                    </div>
                    <p className="text-xs text-gray-500">Include all household income before taxes</p>
                  </div>

                  <div className="space-y-2">
                    <label className="block text-sm font-semibold text-gray-700">
                      Down payment already saved
                    </label>
                    <div className="relative">
                      <span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-medium">$</span>
                      <input
                        type="number"
                        className="w-full p-4 pl-8 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200"
                        placeholder="10,000"
                        value={formData.downPaymentSaved}
                        onChange={(e) => setFormData({...formData, downPaymentSaved: e.target.value})}
                      />
                    </div>
                  </div>

                  <div className="space-y-2">
                    <label className="block text-sm font-semibold text-gray-700">
                      Household size
                    </label>
                    <select
                      className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 text-gray-900"
                      value={formData.householdSize}
                      onChange={(e) => setFormData({...formData, householdSize: e.target.value})}
                    >
                      <option value="1">1 person</option>
                      <option value="2">2 people</option>
                      <option value="3">3 people</option>
                      <option value="4">4 people</option>
                      <option value="5">5+ people</option>
                    </select>
                  </div>
                </div>

                <div className="grid md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="block text-sm font-semibold text-gray-700">
                      Estimated credit score
                    </label>
                    <select
                      className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 text-gray-900"
                      value={formData.creditScore}
                      onChange={(e) => setFormData({...formData, creditScore: e.target.value})}
                    >
                      <option value="">Select your credit score range...</option>
                      <option value="780+">780+ (Excellent)</option>
                      <option value="740-779">740-779 (Very Good)</option>
                      <option value="700-739">700-739 (Good)</option>
                      <option value="660-699">660-699 (Fair)</option>
                      <option value="620-659">620-659 (Minimum)</option>
                      <option value="580-619">580-619 (Below minimum)</option>
                      <option value="<580">Below 580</option>
                    </select>
                    <p className="text-xs text-gray-500">
                      Don't know? <a href="https://www.annualcreditreport.com" target="_blank" className="text-blue-600 hover:underline">Get free report</a>
                    </p>
                  </div>

                  <div className="space-y-2">
                    <label className="block text-sm font-semibold text-gray-700">
                      How long do you plan to stay?
                    </label>
                    <select
                      className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 text-gray-900"
                      value={formData.stayDuration}
                      onChange={(e) => setFormData({...formData, stayDuration: e.target.value})}
                    >
                      <option value="">Select duration...</option>
                      <option value="<3">Less than 3 years</option>
                      <option value="3-5">3-5 years</option>
                      <option value="5-10">5-10 years</option>
                      <option value="10+">10+ years</option>
                      <option value="not-sure">Not sure</option>
                    </select>
                  </div>
                </div>

                <div className="bg-gradient-to-r from-gray-50 to-slate-50 rounded-2xl p-6 border border-gray-200">
                  <label className="block text-sm font-semibold text-gray-700 mb-2">
                    What matters most to you?
                  </label>
                  <p className="text-sm text-gray-500 mb-4">Click to rank in order of importance. Click again to remove.</p>
                  <div className="grid sm:grid-cols-2 gap-3">
                    {[
                      { id: 'max-assistance', title: 'Maximum assistance', desc: 'Get the most cash help possible', icon: 'DollarSign' },
                      { id: 'low-payment', title: 'Low monthly payment', desc: 'Keep payments affordable', icon: 'TrendingDown' },
                      { id: 'fast-forgiveness', title: 'Fast ownership', desc: 'Grants & quick forgiveness', icon: 'Zap' },
                      { id: 'simple', title: 'Simple process', desc: 'Fewer applications', icon: 'CheckCircle' }
                    ].map((option) => {
                      const rankIndex = formData.priorities.indexOf(option.id);
                      const isRanked = rankIndex !== -1;
                      const rank = rankIndex + 1;

                      return (
                        <button
                          key={option.id}
                          type="button"
                          onClick={() => {
                            if (isRanked) {
                              setFormData({
                                ...formData,
                                priorities: formData.priorities.filter(p => p !== option.id)
                              });
                            } else {
                              setFormData({
                                ...formData,
                                priorities: [...formData.priorities, option.id]
                              });
                            }
                          }}
                          className={`relative flex items-center gap-3 p-4 rounded-xl text-left transition-all duration-200 ${
                            isRanked
                              ? 'bg-blue-600 text-white shadow-lg scale-[1.02]'
                              : 'bg-white border-2 border-gray-200 hover:border-blue-300 hover:shadow-md'
                          }`}
                        >
                          {isRanked && (
                            <div className="absolute -top-2 -right-2 w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-md">
                              {rank}
                            </div>
                          )}
                          <div className={`w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0 ${
                            isRanked ? 'bg-white/20' : 'bg-blue-50'
                          }`}>
                            <Icon name={option.icon} className={`w-5 h-5 ${isRanked ? 'text-white' : 'text-blue-600'}`} />
                          </div>
                          <div>
                            <p className={`font-semibold ${isRanked ? 'text-white' : 'text-gray-900'}`}>{option.title}</p>
                            <p className={`text-xs ${isRanked ? 'text-blue-100' : 'text-gray-500'}`}>{option.desc}</p>
                          </div>
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* Quick toggles */}
                <div className="flex flex-wrap gap-3">
                  <label className={`flex items-center gap-3 px-4 py-3 rounded-xl cursor-pointer transition-all duration-200 ${
                    formData.firstTimeBuyer
                      ? 'bg-green-50 border-2 border-green-500 text-green-800'
                      : 'bg-gray-50 border-2 border-gray-200 text-gray-600 hover:border-gray-300'
                  }`}>
                    <input
                      type="checkbox"
                      className="sr-only"
                      checked={formData.firstTimeBuyer}
                      onChange={(e) => setFormData({...formData, firstTimeBuyer: e.target.checked})}
                    />
                    <div className={`w-5 h-5 rounded-md flex items-center justify-center ${
                      formData.firstTimeBuyer ? 'bg-green-500 text-white' : 'bg-gray-300'
                    }`}>
                      {formData.firstTimeBuyer && <Icon name="Check" className="w-3 h-3" />}
                    </div>
                    <span className="text-sm font-medium">First-time homebuyer</span>
                  </label>

                  <label className={`flex items-center gap-3 px-4 py-3 rounded-xl cursor-pointer transition-all duration-200 ${
                    formData.veteranStatus
                      ? 'bg-green-50 border-2 border-green-500 text-green-800'
                      : 'bg-gray-50 border-2 border-gray-200 text-gray-600 hover:border-gray-300'
                  }`}>
                    <input
                      type="checkbox"
                      className="sr-only"
                      checked={formData.veteranStatus}
                      onChange={(e) => setFormData({...formData, veteranStatus: e.target.checked})}
                    />
                    <div className={`w-5 h-5 rounded-md flex items-center justify-center ${
                      formData.veteranStatus ? 'bg-green-500 text-white' : 'bg-gray-300'
                    }`}>
                      {formData.veteranStatus && <Icon name="Check" className="w-3 h-3" />}
                    </div>
                    <span className="text-sm font-medium">Veteran / Active Military</span>
                  </label>
                </div>

                <div className="space-y-2">
                  <label className="block text-sm font-semibold text-gray-700">
                    Occupation (if applicable)
                  </label>
                  <select
                    className="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all duration-200 text-gray-900"
                    value={formData.occupation}
                    onChange={(e) => setFormData({...formData, occupation: e.target.value})}
                  >
                    <option value="">Not applicable / Other</option>
                    <option value="educator">Teacher / Educator</option>
                    <option value="first-responder">First Responder (Fire/EMT)</option>
                    <option value="law-enforcement">Law Enforcement</option>
                    <option value="healthcare">Healthcare Worker</option>
                    <option value="military">Military / Veteran</option>
                    <option value="farmer">Farmer / Rancher</option>
                    <option value="nonprofit">Nonprofit Employee</option>
                  </select>
                </div>

                {/* Special circumstances section */}
                <div className="bg-gray-50 rounded-2xl p-6 border border-gray-200">
                  <p className="text-sm font-semibold text-gray-700 mb-4">Additional circumstances</p>

                  <div className="grid sm:grid-cols-2 gap-3">
                    <label className={`flex items-start gap-3 p-4 rounded-xl cursor-pointer transition-all duration-200 ${
                      formData.hasDisability
                        ? 'bg-blue-50 border-2 border-blue-500'
                        : 'bg-white border-2 border-gray-200 hover:border-gray-300'
                    }`}>
                      <input
                        type="checkbox"
                        className="sr-only"
                        checked={formData.hasDisability}
                        onChange={(e) => setFormData({...formData, hasDisability: e.target.checked})}
                      />
                      <div className={`w-5 h-5 mt-0.5 rounded-md flex items-center justify-center flex-shrink-0 ${
                        formData.hasDisability ? 'bg-blue-500 text-white' : 'bg-gray-300'
                      }`}>
                        {formData.hasDisability && <Icon name="Check" className="w-3 h-3" />}
                      </div>
                      <div>
                        <span className="font-medium text-gray-900 text-sm">Household member with disability</span>
                        <span className="block text-xs text-gray-500 mt-0.5">Unlocks special assistance programs</span>
                      </div>
                    </label>

                    <label className={`flex items-start gap-3 p-4 rounded-xl cursor-pointer transition-all duration-200 ${
                      formData.interestedInRenovation
                        ? 'bg-blue-50 border-2 border-blue-500'
                        : 'bg-white border-2 border-gray-200 hover:border-gray-300'
                    }`}>
                      <input
                        type="checkbox"
                        className="sr-only"
                        checked={formData.interestedInRenovation}
                        onChange={(e) => setFormData({...formData, interestedInRenovation: e.target.checked})}
                      />
                      <div className={`w-5 h-5 mt-0.5 rounded-md flex items-center justify-center flex-shrink-0 ${
                        formData.interestedInRenovation ? 'bg-blue-500 text-white' : 'bg-gray-300'
                      }`}>
                        {formData.interestedInRenovation && <Icon name="Check" className="w-3 h-3" />}
                      </div>
                      <div>
                        <span className="font-medium text-gray-900 text-sm">Interested in fixer-upper</span>
                        <span className="block text-xs text-gray-500 mt-0.5">Shows renovation loan options</span>
                      </div>
                    </label>

                    <label className={`flex items-start gap-3 p-4 rounded-xl cursor-pointer transition-all duration-200 ${
                      formData.isNativeAmerican
                        ? 'bg-blue-50 border-2 border-blue-500'
                        : 'bg-white border-2 border-gray-200 hover:border-gray-300'
                    }`}>
                      <input
                        type="checkbox"
                        className="sr-only"
                        checked={formData.isNativeAmerican}
                        onChange={(e) => setFormData({...formData, isNativeAmerican: e.target.checked})}
                      />
                      <div className={`w-5 h-5 mt-0.5 rounded-md flex items-center justify-center flex-shrink-0 ${
                        formData.isNativeAmerican ? 'bg-blue-500 text-white' : 'bg-gray-300'
                      }`}>
                        {formData.isNativeAmerican && <Icon name="Check" className="w-3 h-3" />}
                      </div>
                      <div>
                        <span className="font-medium text-gray-900 text-sm">Enrolled tribal member</span>
                        <span className="block text-xs text-gray-500 mt-0.5">Section 184 loan eligibility</span>
                      </div>
                    </label>

                    <label className={`flex items-start gap-3 p-4 rounded-xl cursor-pointer transition-all duration-200 ${
                      !formData.hasSSN
                        ? 'bg-blue-50 border-2 border-blue-500'
                        : 'bg-white border-2 border-gray-200 hover:border-gray-300'
                    }`}>
                      <input
                        type="checkbox"
                        className="sr-only"
                        checked={!formData.hasSSN}
                        onChange={(e) => setFormData({...formData, hasSSN: !e.target.checked})}
                      />
                      <div className={`w-5 h-5 mt-0.5 rounded-md flex items-center justify-center flex-shrink-0 ${
                        !formData.hasSSN ? 'bg-blue-500 text-white' : 'bg-gray-300'
                      }`}>
                        {!formData.hasSSN && <Icon name="Check" className="w-3 h-3" />}
                      </div>
                      <div>
                        <span className="font-medium text-gray-900 text-sm">No SSN (ITIN only)</span>
                        <span className="block text-xs text-gray-500 mt-0.5">Shows ITIN-friendly options</span>
                      </div>
                    </label>
                  </div>
                </div>

                {/* ITIN notice when no SSN selected */}
                {!formData.hasSSN && (
                  <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div className="flex gap-3">
                      <Icon name="AlertCircle" className="w-5 h-5 text-amber-600 flex-shrink-0" />
                      <div>
                        <p className="font-medium text-amber-900">ITIN Mortgage Options</p>
                        <p className="text-sm text-amber-700 mt-1">
                          Without an SSN, most government down payment assistance programs (CHFA, MetroDPA, FHA) are not available.
                          However, some lenders offer ITIN loans that allow homeownership with an Individual Taxpayer Identification Number.
                        </p>
                        <p className="text-sm text-amber-700 mt-2">
                          <strong>ITIN loan requirements typically include:</strong>
                        </p>
                        <ul className="text-sm text-amber-700 mt-1 ml-4 list-disc">
                          <li>Valid ITIN number</li>
                          <li>2+ years of U.S. tax returns filed with ITIN</li>
                          <li>10-15% down payment (higher than conventional)</li>
                          <li>Proof of income and rental history</li>
                        </ul>
                        <p className="text-sm text-amber-700 mt-2">
                          Interest rates are typically 1-2% higher than conventional loans. We recommend connecting with an ITIN-specialized lender.
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {/* Edge case: Down payment already covers 20% */}
                {purchasePrice > 0 && downPaymentSaved >= purchasePrice * 0.20 && (
                  <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div className="flex gap-3">
                      <Icon name="CheckCircle" className="w-5 h-5 text-green-600 flex-shrink-0" />
                      <div>
                        <p className="font-medium text-green-900">Great news! You already have 20%+ saved</p>
                        <p className="text-sm text-green-700 mt-1">
                          With {formatCurrency(downPaymentSaved)} saved for a {formatCurrency(purchasePrice)} home, you can avoid PMI with a conventional loan.
                          You might still benefit from DPA programs to keep cash reserves for repairs, moving costs, or emergencies.
                        </p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Credit Warning Screen - shows as overlay when credit is concerning */}
            {showCreditWarning && creditAssessment.status === 'not-ready' && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div className="p-6 space-y-6">
                    <div className="bg-red-50 border-2 border-red-500 rounded-lg p-6">
                      <div className="flex items-start gap-4">
                        <Icon name="AlertCircle" className="w-8 h-8 text-red-600 flex-shrink-0" />
                        <div>
                          <h2 className="text-xl font-bold text-red-900 mb-2">
                            Credit Building Needed Before Homeownership
                          </h2>
                          <p className="text-red-800">
                            With a credit score below 620, most mortgage lenders and down payment
                            assistance programs will not approve your application. This doesn't mean
                            homeownership is impossible - it means you need to build your credit first.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div className="bg-white border border-gray-200 rounded-lg p-6">
                      <h3 className="font-bold text-gray-900 mb-4">Your Path to Homeownership</h3>

                      <div className="space-y-4">
                        <div className="flex items-start gap-3">
                          <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center flex-shrink-0 font-bold">1</div>
                          <div>
                            <p className="font-medium text-gray-900">Meet with a Housing Counselor (FREE)</p>
                            <p className="text-sm text-gray-600 mt-1">
                              They'll review your credit report, identify issues, and create a personalized
                              credit-building plan. Most people can reach 620+ in 12-18 months with guidance.
                            </p>
                            <div className="mt-2 space-y-1 text-sm">
                              <p><a href="tel:3032026340" className="text-blue-600 hover:underline">Brothers Redevelopment: (303) 202-6340</a></p>
                              <p><a href="tel:3035729445" className="text-blue-600 hover:underline">CHAC: (303) 572-9445</a></p>
                              <p><a href="tel:9704942021" className="text-blue-600 hover:underline">Impact Development Fund: (970) 494-2021</a></p>
                            </div>
                          </div>
                        </div>

                        <div className="flex items-start gap-3">
                          <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center flex-shrink-0 font-bold">2</div>
                          <div>
                            <p className="font-medium text-gray-900">Build Your Credit (12-18 months)</p>
                            <p className="text-sm text-gray-600 mt-1">
                              Focus on: paying all bills on time, reducing debt, disputing errors,
                              and establishing positive credit history.
                            </p>
                          </div>
                        </div>

                        <div className="flex items-start gap-3">
                          <div className="w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center flex-shrink-0 font-bold">3</div>
                          <div>
                            <p className="font-medium text-gray-900">Return When Ready</p>
                            <p className="text-sm text-gray-600 mt-1">
                              Once your credit reaches 620+, come back to this tool and we'll help you
                              find down payment assistance programs you'll actually qualify for.
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <p className="text-sm text-blue-900">
                        <strong>Good news:</strong> The credit-building process also helps you save for a
                        down payment. By the time your credit is ready, you'll be in a much stronger
                        position to buy.
                      </p>
                    </div>

                    <div className="flex justify-center">
                      <button
                        onClick={handleCreditWarningBack}
                        className="px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
                      >
                        Update My Information
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Credit Warning for Challenging Credit (620-659) */}
            {showCreditWarning && creditAssessment.status === 'challenging' && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                  <div className="p-6 space-y-6">
                    <div className="bg-orange-50 border-2 border-orange-500 rounded-lg p-6">
                      <div className="flex items-start gap-4">
                        <Icon name="AlertCircle" className="w-8 h-8 text-orange-600 flex-shrink-0" />
                        <div>
                          <h2 className="text-xl font-bold text-orange-900 mb-2">
                            Approval Will Be Challenging
                          </h2>
                          <p className="text-orange-800">
                            Your credit score (620-659) meets the minimum requirements, but your
                            <strong> estimated approval rate is only ~35%</strong>. Most applicants
                            in this range get denied unless they have exceptional strength in other areas.
                          </p>
                        </div>
                      </div>
                    </div>

                    <div className="grid md:grid-cols-2 gap-4">
                      <div className="bg-white border-2 border-green-500 rounded-lg p-5">
                        <h3 className="font-bold text-green-900 mb-3 flex items-center gap-2">
                          <span className="text-2xl">âœ“</span> Factors That Help Approval
                        </h3>
                        <ul className="space-y-2 text-sm text-gray-700">
                          <li>â€¢ No late payments in last 24 months</li>
                          <li>â€¢ Debt-to-income ratio below 40%</li>
                          <li>â€¢ Stable employment (2+ years)</li>
                          <li>â€¢ Substantial savings (6+ months reserves)</li>
                          <li>â€¢ Low credit utilization (&lt;30%)</li>
                          <li>â€¢ Clean rental payment history</li>
                        </ul>
                      </div>

                      <div className="bg-white border-2 border-red-500 rounded-lg p-5">
                        <h3 className="font-bold text-red-900 mb-3 flex items-center gap-2">
                          <span className="text-2xl">âœ—</span> Factors That Hurt Approval
                        </h3>
                        <ul className="space-y-2 text-sm text-gray-700">
                          <li>â€¢ Any late payments in last 12 months</li>
                          <li>â€¢ Debt-to-income ratio above 43%</li>
                          <li>â€¢ Job changes in last 2 years</li>
                          <li>â€¢ Collections or charge-offs</li>
                          <li>â€¢ High credit card balances</li>
                          <li>â€¢ Thin credit file (few accounts)</li>
                        </ul>
                      </div>
                    </div>

                    <div className="bg-white border border-gray-200 rounded-lg p-6">
                      <h3 className="font-bold text-gray-900 mb-4">You Have Two Options:</h3>

                      <div className="space-y-4">
                        <div className="flex items-start gap-3 pb-4 border-b">
                          <div className="w-10 h-10 rounded-full bg-yellow-100 text-yellow-800 flex items-center justify-center flex-shrink-0 font-bold">A</div>
                          <div className="flex-1">
                            <p className="font-medium text-gray-900 mb-2">Apply Now (Lower Success Rate)</p>
                            <p className="text-sm text-gray-600 mb-3">
                              You can proceed, but expect some denials. Work with 2-3 lenders to
                              maximize chances. If denied, you'll know exactly what to improve.
                            </p>
                            <button
                              onClick={handleCreditWarningContinue}
                              className="px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700"
                            >
                              Continue to Programs
                            </button>
                          </div>
                        </div>

                        <div className="flex items-start gap-3">
                          <div className="w-10 h-10 rounded-full bg-green-100 text-green-800 flex items-center justify-center flex-shrink-0 font-bold">B</div>
                          <div className="flex-1">
                            <p className="font-medium text-gray-900 mb-2">
                              Improve Credit First (Recommended - 75%+ Success Rate)
                            </p>
                            <p className="text-sm text-gray-600 mb-3">
                              Wait 6-12 months while building credit to 660+. This significantly
                              improves your approval odds and may get you better interest rates.
                            </p>
                            <p className="text-sm font-medium text-gray-900 mb-2">FREE Housing Counselors Can Help:</p>
                            <div className="space-y-1 text-sm text-blue-600 mb-3">
                              <p><a href="tel:3032026340" className="hover:underline">Brothers Redevelopment: (303) 202-6340</a></p>
                              <p><a href="tel:3035729445" className="hover:underline">CHAC: (303) 572-9445</a></p>
                              <p><a href="tel:9704942021" className="hover:underline">Impact Development Fund: (970) 494-2021</a></p>
                            </div>
                            <button
                              onClick={handleCreditWarningBack}
                              className="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700"
                            >
                              I'll Work on My Credit First
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* Step 1: What You Qualify For */}
            {step === 1 && (
              <div className="space-y-8">
                {(() => {
                  const income = parseInt(formData.income) || 0;
                  const creditScore = formData.creditScore;
                  const downPaymentSaved = parseInt(formData.downPaymentSaved) || 0;
                  const estimatedPrice = Math.min(income * 4.5, 600000);
                  const eligible = getEligiblePrograms().filter(p => !p.isAffordableHousing);
                  const validCombos = generateCombinations(eligible);

                  // Calculate monthly payment
                  const calculatePayment = (homePrice, assistanceAmount, rateAdder = 0) => {
                    const totalDown = downPaymentSaved + assistanceAmount;
                    const loanAmount = Math.max(0, homePrice - totalDown);
                    const rate = 0.0675 + rateAdder;
                    const monthlyRate = rate / 12;
                    const numPayments = 360;
                    let payment = 0;
                    if (loanAmount > 0) {
                      payment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                                (Math.pow(1 + monthlyRate, numPayments) - 1);
                    }
                    const taxes = (homePrice * 0.007) / 12;
                    const insurance = 150;
                    return Math.round(payment + taxes + insurance);
                  };

                  // Generate packages for max assistance calculation
                  const packages = validCombos.map(combo => {
                    const progs = combo.map(id => programs.find(pr => pr.id === id));
                    const totalAssistance = progs.reduce((sum, p) => sum + (p.calcAmount ? p.calcAmount(estimatedPrice) : 0), 0);
                    return { totalAssistance };
                  }).sort((a, b) => b.totalAssistance - a.totalAssistance);

                  const maxAssistance = packages[0]?.totalAssistance || 0;
                  const minDownPayment = Math.max(0, estimatedPrice * 0.035 - maxAssistance - downPaymentSaved);
                  const paymentWithAssistance = calculatePayment(estimatedPrice, maxAssistance);
                  const paymentWithoutAssistance = calculatePayment(estimatedPrice, 0);
                  const monthlyBenefit = paymentWithoutAssistance - paymentWithAssistance;

                  return (
                    <>
                      {/* Main Header */}
                      <div className="text-center">
                        <div className="inline-flex items-center gap-2 bg-emerald-100 text-emerald-700 px-4 py-2 rounded-full text-sm font-medium mb-4">
                          <Icon name="CheckCircle" className="w-4 h-4" />
                          Based on your profile
                        </div>
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">What You Qualify For</h1>
                        <p className="text-gray-600">Here's what your homebuying journey could look like</p>
                      </div>

                      {/* Big Numbers - Home Price */}
                      <div className="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-8 text-white text-center">
                        <p className="text-emerald-100 text-lg mb-2">Maximum Home Price</p>
                        <p className="text-5xl font-bold mb-4">${estimatedPrice.toLocaleString()}</p>
                        <p className="text-emerald-100 text-sm">Based on {income.toLocaleString()}/year income at 4.5x ratio</p>
                      </div>

                      {/* Two Column Stats */}
                      <div className="grid md:grid-cols-2 gap-6">
                        {/* Monthly Payment Card */}
                        <div className="bg-white border-2 border-gray-200 rounded-2xl p-6">
                          <div className="flex items-center gap-3 mb-4">
                            <div className="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                              <Icon name="Calendar" className="w-6 h-6 text-blue-600" />
                            </div>
                            <div>
                              <p className="text-sm text-gray-500">Estimated Monthly Payment</p>
                              <p className="text-3xl font-bold text-gray-900">${paymentWithAssistance.toLocaleString()}</p>
                            </div>
                          </div>
                          <div className="bg-green-50 rounded-lg p-3 flex items-center gap-2">
                            <Icon name="TrendingDown" className="w-5 h-5 text-green-600" />
                            <span className="text-sm text-green-700">
                              <strong>${monthlyBenefit.toLocaleString()}/mo less</strong> with DPA assistance
                            </span>
                          </div>
                          <p className="text-xs text-gray-500 mt-3">Includes principal, interest, taxes & insurance (PITI)</p>
                        </div>

                        {/* Down Payment Card */}
                        <div className="bg-white border-2 border-gray-200 rounded-2xl p-6">
                          <div className="flex items-center gap-3 mb-4">
                            <div className="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
                              <Icon name="PiggyBank" className="w-6 h-6 text-purple-600" />
                            </div>
                            <div>
                              <p className="text-sm text-gray-500">Your Out-of-Pocket</p>
                              <p className="text-3xl font-bold text-gray-900">${Math.round(minDownPayment).toLocaleString()}</p>
                            </div>
                          </div>
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-gray-600">Your savings:</span>
                              <span className="font-medium">${downPaymentSaved.toLocaleString()}</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-gray-600">Max DPA assistance:</span>
                              <span className="font-medium text-green-600">+${maxAssistance.toLocaleString()}</span>
                            </div>
                            <div className="flex justify-between border-t border-gray-100 pt-2">
                              <span className="text-gray-600">Still needed:</span>
                              <span className="font-bold">${Math.round(minDownPayment).toLocaleString()}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Assistance Highlight */}
                      <div className="bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-2xl p-6">
                        <div className="flex items-start gap-4">
                          <div className="w-14 h-14 bg-amber-100 rounded-xl flex items-center justify-center flex-shrink-0">
                            <Icon name="Gift" className="w-7 h-7 text-amber-600" />
                          </div>
                          <div>
                            <h3 className="text-xl font-bold text-gray-900 mb-1">Up to ${maxAssistance.toLocaleString()} in Assistance Available</h3>
                            <p className="text-gray-600">
                              Based on your location ({formData.location} County) and income, you may qualify for down payment assistance programs.
                              View your specific options on the next screen.
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Your Profile Summary */}
                      <div className="bg-gray-50 rounded-xl p-6">
                        <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                          <Icon name="User" className="w-5 h-5 text-gray-600" />
                          Your Profile Summary
                        </h3>
                        <div className="grid md:grid-cols-4 gap-4">
                          <div className="bg-white rounded-lg p-4 border border-gray-200">
                            <p className="text-xs text-gray-500 mb-1">Annual Income</p>
                            <p className="text-lg font-bold text-gray-900">${income.toLocaleString()}</p>
                          </div>
                          <div className="bg-white rounded-lg p-4 border border-gray-200">
                            <p className="text-xs text-gray-500 mb-1">Savings</p>
                            <p className="text-lg font-bold text-gray-900">${downPaymentSaved.toLocaleString()}</p>
                          </div>
                          <div className="bg-white rounded-lg p-4 border border-gray-200">
                            <p className="text-xs text-gray-500 mb-1">Credit Score</p>
                            <p className="text-lg font-bold text-gray-900">{creditScore}</p>
                          </div>
                          <div className="bg-white rounded-lg p-4 border border-gray-200">
                            <p className="text-xs text-gray-500 mb-1">County</p>
                            <p className="text-lg font-bold text-gray-900">{formData.location}</p>
                          </div>
                        </div>
                      </div>

                      {/* Info Note */}
                      <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 flex gap-3">
                        <Icon name="Info" className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                        <div>
                          <p className="font-medium text-blue-900">These are estimates based on current rates</p>
                          <p className="text-sm text-blue-800 mt-1">
                            Actual amounts depend on your specific situation, interest rates at time of purchase, and program availability.
                            Continue to see your specific assistance package options.
                          </p>
                        </div>
                      </div>
                    </>
                  );
                })()}
              </div>
            )}

            {/* Step 2: Assistance Packages */}
            {step === 2 && (
              <div className="space-y-6">
                {(() => {
                  const income = parseInt(formData.income) || 0;
                  const downPaymentSaved = parseInt(formData.downPaymentSaved) || 0;
                  const estimatedPrice = Math.min(income * 4.5, 600000);
                  const eligible = getEligiblePrograms().filter(p => !p.isAffordableHousing);
                  const validCombos = generateCombinations(eligible);

                  // Calculate monthly payment
                  const calculatePayment = (homePrice, assistanceAmount) => {
                    const totalDown = downPaymentSaved + assistanceAmount;
                    const loanAmount = Math.max(0, homePrice - totalDown);
                    const rate = 0.0675;
                    const monthlyRate = rate / 12;
                    const numPayments = 360;
                    let payment = 0;
                    if (loanAmount > 0) {
                      payment = loanAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) /
                                (Math.pow(1 + monthlyRate, numPayments) - 1);
                    }
                    const taxes = (homePrice * 0.007) / 12;
                    const insurance = 150;
                    return Math.round(payment + taxes + insurance);
                  };

                  // Generate packages
                  const packages = validCombos.map(combo => {
                    const progs = combo.map(id => {
                      const p = programs.find(pr => pr.id === id);
                      return {
                        id: p.id,
                        name: p.name,
                        amount: p.calcAmount ? p.calcAmount(estimatedPrice) : 0,
                        isGrant: p.isGrant,
                        description: p.description,
                        yearsToForgiveness: p.yearsToForgiveness
                      };
                    });
                    const totalAssistance = progs.reduce((sum, p) => sum + p.amount, 0);
                    const monthlyPayment = calculatePayment(estimatedPrice, totalAssistance);
                    const yourDownPayment = Math.max(0, Math.round(estimatedPrice * 0.035 - totalAssistance));

                    return {
                      programs: progs,
                      totalAssistance,
                      monthlyPayment,
                      yourDownPayment
                    };
                  }).sort((a, b) => b.totalAssistance - a.totalAssistance);

                  // Get top packages with variety
                  const hasCHFA = pkg => pkg.programs.some(p => p.id === 'chfa-grant' || p.id === 'chfa-second');
                  const hasMetroDPA = pkg => pkg.programs.some(p => p.id === 'metro-dpa');
                  const result = [];
                  const seen = new Set();

                  packages.slice(0, 3).forEach(pkg => {
                    const key = pkg.programs.map(p => p.id).sort().join(',');
                    if (!seen.has(key)) { seen.add(key); result.push(pkg); }
                  });

                  const chfaPkg = packages.find(p => hasCHFA(p) && !seen.has(p.programs.map(pr => pr.id).sort().join(',')));
                  if (chfaPkg && result.length < 6) {
                    seen.add(chfaPkg.programs.map(p => p.id).sort().join(','));
                    result.push(chfaPkg);
                  }

                  const metroPkg = packages.find(p => hasMetroDPA(p) && !seen.has(p.programs.map(pr => pr.id).sort().join(',')));
                  if (metroPkg && result.length < 6) {
                    seen.add(metroPkg.programs.map(p => p.id).sort().join(','));
                    result.push(metroPkg);
                  }

                  const finalPackages = result.slice(0, 4);
                  const affordablePrograms = getEligiblePrograms().filter(p => p.isAffordableHousing);

                  return (
                    <>
                      {/* Header */}
                      <div className="text-center mb-4">
                        <h1 className="text-3xl font-bold text-gray-900 mb-2">Your Assistance Options</h1>
                        <p className="text-gray-600">Two paths to homeownership based on your {formData.location} County profile</p>
                      </div>

                      {/* Two Paths Selection */}
                      <div className="mb-6">
                        <p className="text-center text-gray-600 mb-4">Select a path to explore your options</p>
                        <div className="grid md:grid-cols-2 gap-4">
                          {/* DPA Path - Clickable */}
                          <div
                            onClick={() => setSelectedPath('dpa')}
                            className={`rounded-xl p-5 cursor-pointer transition-all ${
                              selectedPath === 'dpa'
                                ? 'bg-gradient-to-br from-blue-600 to-indigo-600 text-white ring-4 ring-blue-300 shadow-xl scale-[1.02]'
                                : 'bg-gradient-to-br from-blue-500/80 to-indigo-500/80 text-white hover:from-blue-600 hover:to-indigo-600 hover:shadow-lg'
                            }`}
                          >
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-3">
                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${selectedPath === 'dpa' ? 'bg-white/30' : 'bg-white/20'}`}>
                                  <Icon name="DollarSign" className="w-6 h-6" />
                                </div>
                                <div>
                                  <p className="text-blue-100 text-sm">Path 1</p>
                                  <h3 className="text-xl font-bold">Down Payment Assistance</h3>
                                </div>
                              </div>
                              {selectedPath === 'dpa' && (
                                <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                                  <Icon name="Check" className="w-5 h-5 text-blue-600" />
                                </div>
                              )}
                            </div>
                            <p className="text-blue-100 text-sm mb-3">Get grants or loans to help cover your down payment on any eligible home you find on the market.</p>
                            <div className="bg-white/10 rounded-lg p-3">
                              <div className="flex justify-between items-center">
                                <span className="text-blue-100">Up to</span>
                                <span className="text-2xl font-bold">${(finalPackages[0]?.totalAssistance || 0).toLocaleString()}</span>
                              </div>
                              <p className="text-blue-200 text-xs mt-1">{finalPackages.length} package options available</p>
                            </div>
                            {selectedPath !== 'dpa' && (
                              <p className="text-center text-white/80 text-sm mt-3 font-medium">Click to select this path</p>
                            )}
                          </div>

                          {/* Affordable Housing Path - Clickable */}
                          <div
                            onClick={() => affordablePrograms.length > 0 && setSelectedPath('affordable')}
                            className={`rounded-xl p-5 transition-all ${
                              affordablePrograms.length === 0
                                ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                : selectedPath === 'affordable'
                                  ? 'bg-gradient-to-br from-purple-600 to-indigo-600 text-white ring-4 ring-purple-300 shadow-xl scale-[1.02] cursor-pointer'
                                  : 'bg-gradient-to-br from-purple-500/80 to-indigo-500/80 text-white hover:from-purple-600 hover:to-indigo-600 hover:shadow-lg cursor-pointer'
                            }`}
                          >
                            <div className="flex items-center justify-between mb-3">
                              <div className="flex items-center gap-3">
                                <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                                  affordablePrograms.length === 0 ? 'bg-gray-200' :
                                  selectedPath === 'affordable' ? 'bg-white/30' : 'bg-white/20'
                                }`}>
                                  <Icon name="Home" className="w-6 h-6" />
                                </div>
                                <div>
                                  <p className={affordablePrograms.length > 0 ? (selectedPath === 'affordable' ? 'text-purple-100' : 'text-purple-100') + ' text-sm' : 'text-gray-400 text-sm'}>Path 2</p>
                                  <h3 className="text-xl font-bold">Affordable Housing</h3>
                                </div>
                              </div>
                              {selectedPath === 'affordable' && (
                                <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                                  <Icon name="Check" className="w-5 h-5 text-purple-600" />
                                </div>
                              )}
                            </div>
                            <p className={`text-sm mb-3 ${affordablePrograms.length > 0 ? 'text-purple-100' : 'text-gray-400'}`}>
                              {affordablePrograms.length > 0
                                ? 'Purchase below-market-rate homes through community land trusts and affordable housing programs.'
                                : 'No affordable housing programs available for your area.'}
                            </p>
                            {affordablePrograms.length > 0 && (
                              <>
                                <div className="bg-white/10 rounded-lg p-3">
                                  <div className="flex justify-between items-center">
                                    <span className="text-purple-100">Programs</span>
                                    <span className="text-2xl font-bold">{affordablePrograms.length}</span>
                                  </div>
                                  <p className="text-purple-200 text-xs mt-1">Below-market pricing available</p>
                                </div>
                                {selectedPath !== 'affordable' && (
                                  <p className="text-center text-white/80 text-sm mt-3 font-medium">Click to select this path</p>
                                )}
                              </>
                            )}
                          </div>
                        </div>
                      </div>

                      {/* Quick Stats Bar - Show when path selected */}
                      {selectedPath && (
                        <div className="bg-gray-100 rounded-xl p-3 flex items-center justify-center gap-6 text-sm mb-4">
                          <div className="flex items-center gap-2">
                            <Icon name="Home" className="w-4 h-4 text-gray-500" />
                            <span className="text-gray-600">Est. price:</span>
                            <span className="font-bold">${estimatedPrice.toLocaleString()}</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <Icon name="Wallet" className="w-4 h-4 text-gray-500" />
                            <span className="text-gray-600">Savings:</span>
                            <span className="font-bold">${downPaymentSaved.toLocaleString()}</span>
                          </div>
                        </div>
                      )}

                      {/* Prompt to select if no path chosen */}
                      {!selectedPath && (
                        <div className="bg-blue-50 border-2 border-blue-200 border-dashed rounded-xl p-8 text-center">
                          <Icon name="MousePointer" className="w-10 h-10 text-blue-400 mx-auto mb-3" />
                          <h3 className="text-lg font-semibold text-blue-900 mb-2">Choose Your Path</h3>
                          <p className="text-blue-700">Select one of the paths above to see your available assistance options</p>
                        </div>
                      )}

                      {/* DPA Packages Section - Only show when Path 1 selected */}
                      {selectedPath === 'dpa' && (
                      <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-6 border border-blue-200 shadow-lg">
                        <div className="flex items-center gap-3 mb-5">
                          <div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                            <Icon name="DollarSign" className="w-6 h-6 text-white" />
                          </div>
                          <div>
                            <h2 className="text-2xl font-bold text-gray-900">Down Payment Assistance Programs</h2>
                            <p className="text-gray-600">Grants and loans to help you buy any eligible home</p>
                          </div>
                        </div>

                      {/* Package Cards - Larger format with pros/cons */}
                      {finalPackages.length > 0 ? (
                        <div className="grid md:grid-cols-2 gap-5">
                          {finalPackages.map((pkg, idx) => {
                            const isBest = idx === 0;
                            const isSelected = formData.selectedPrograms.length > 0 &&
                              pkg.programs.every(p => formData.selectedPrograms.includes(p.id)) &&
                              pkg.programs.length === formData.selectedPrograms.length;
                            const isExpanded = expandedPackages[`pkg-${idx}`];

                            // Get full program data with pros/cons
                            const fullPrograms = pkg.programs.map(p => {
                              const fullProg = programs.find(pr => pr.id === p.id);
                              return { ...p, pros: fullProg?.pros, cons: fullProg?.cons, description: fullProg?.description, requirements: fullProg?.requirements };
                            });

                            return (
                              <div
                                key={idx}
                                className={`bg-white border-2 rounded-xl overflow-hidden transition-all ${
                                  isSelected ? 'border-green-500 ring-4 ring-green-100 shadow-lg' :
                                  isBest ? 'border-green-400 shadow-md' : 'border-gray-200 hover:border-blue-300 hover:shadow-md'
                                }`}
                              >
                                {/* Package Header - Clickable to select */}
                                <div
                                  className={`px-5 py-4 cursor-pointer ${isBest ? 'bg-gradient-to-r from-green-600 to-emerald-600' : 'bg-gradient-to-r from-blue-600 to-indigo-600'}`}
                                  onClick={() => {
                                    setFormData({
                                      ...formData,
                                      purchasePrice: estimatedPrice.toString(),
                                      selectedPrograms: pkg.programs.map(p => p.id)
                                    });
                                  }}
                                >
                                  <div className="flex items-start justify-between">
                                    <div>
                                      {(isBest || isSelected) && (
                                        <span className={`inline-block text-xs font-bold px-2 py-0.5 rounded-full mb-2 ${isSelected ? 'bg-white text-green-600' : 'bg-white/20 text-white'}`}>
                                          {isSelected ? 'âœ“ SELECTED' : 'BEST VALUE'}
                                        </span>
                                      )}
                                      <p className="text-white text-3xl font-bold">${pkg.totalAssistance.toLocaleString()}</p>
                                      <p className="text-white/80 text-sm">total assistance</p>
                                    </div>
                                    <div className="text-right">
                                      <p className="text-white/80 text-xs">Est. Monthly</p>
                                      <p className="text-white text-2xl font-bold">${pkg.monthlyPayment.toLocaleString()}</p>
                                    </div>
                                  </div>
                                </div>

                                {/* Package Body */}
                                <div className="p-5">
                                  {/* Quick Stats Row */}
                                  <div className="flex items-center gap-4 mb-4 pb-4 border-b border-gray-100">
                                    <div className="flex-1 text-center">
                                      <p className="text-xs text-gray-500">Out-of-Pocket</p>
                                      <p className="font-bold text-gray-900">${pkg.yourDownPayment.toLocaleString()}</p>
                                    </div>
                                    <div className="w-px h-8 bg-gray-200" />
                                    <div className="flex-1 text-center">
                                      <p className="text-xs text-gray-500">Programs</p>
                                      <p className="font-bold text-gray-900">{pkg.programs.length}</p>
                                    </div>
                                    <div className="w-px h-8 bg-gray-200" />
                                    <div className="flex-1 text-center">
                                      <p className="text-xs text-gray-500">Type</p>
                                      <p className="font-bold text-gray-900">{pkg.programs.some(p => p.isGrant) ? 'Grant' : 'Loan'}</p>
                                    </div>
                                  </div>

                                  {/* Programs with Pros/Cons */}
                                  <div className="space-y-4">
                                    {fullPrograms.map((program, pIdx) => (
                                      <div key={pIdx} className="bg-gray-50 rounded-lg p-4">
                                        {/* Program Header */}
                                        <div className="flex items-center justify-between mb-3">
                                          <div className="flex items-center gap-2">
                                            <div className={`w-3 h-3 rounded-full ${program.isGrant ? 'bg-green-500' : 'bg-blue-500'}`} />
                                            <span className="font-semibold text-gray-900">{program.name}</span>
                                            {program.isGrant && (
                                              <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Grant</span>
                                            )}
                                          </div>
                                          <span className="font-bold text-lg text-gray-900">${program.amount.toLocaleString()}</span>
                                        </div>

                                        {/* Pros & Cons - Always Visible */}
                                        <div className="grid grid-cols-2 gap-3">
                                          {program.pros && (
                                            <div className="flex items-start gap-2">
                                              <Icon name="CheckCircle" className="w-4 h-4 text-green-500 mt-0.5 flex-shrink-0" />
                                              <p className="text-sm text-green-700">{program.pros}</p>
                                            </div>
                                          )}
                                          {program.cons && (
                                            <div className="flex items-start gap-2">
                                              <Icon name="AlertCircle" className="w-4 h-4 text-amber-500 mt-0.5 flex-shrink-0" />
                                              <p className="text-sm text-amber-700">{program.cons}</p>
                                            </div>
                                          )}
                                        </div>

                                        {/* Expanded Details */}
                                        {isExpanded && (
                                          <div className="mt-3 pt-3 border-t border-gray-200 space-y-2">
                                            {program.description && (
                                              <p className="text-sm text-gray-600">{program.description}</p>
                                            )}
                                            {program.requirements && program.requirements.length > 0 && (
                                              <div>
                                                <p className="text-xs font-medium text-gray-500 mb-1">Requirements:</p>
                                                <ul className="text-xs text-gray-600 space-y-1">
                                                  {program.requirements.map((req, rIdx) => (
                                                    <li key={rIdx} className="flex items-center gap-1">
                                                      <span className="w-1 h-1 bg-gray-400 rounded-full" />
                                                      {req}
                                                    </li>
                                                  ))}
                                                </ul>
                                              </div>
                                            )}
                                            {program.yearsToForgiveness > 0 && (
                                              <p className="text-xs text-blue-600">
                                                <Icon name="Clock" className="w-3 h-3 inline mr-1" />
                                                Forgiven after {program.yearsToForgiveness} years
                                              </p>
                                            )}
                                          </div>
                                        )}
                                      </div>
                                    ))}
                                  </div>

                                  {/* Expand/Collapse Button */}
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      setExpandedPackages(prev => ({
                                        ...prev,
                                        [`pkg-${idx}`]: !prev[`pkg-${idx}`]
                                      }));
                                    }}
                                    className="w-full mt-4 py-2 text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center justify-center gap-1 border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors"
                                  >
                                    {isExpanded ? (
                                      <>
                                        <Icon name="ChevronUp" className="w-4 h-4" />
                                        Show Less
                                      </>
                                    ) : (
                                      <>
                                        <Icon name="ChevronDown" className="w-4 h-4" />
                                        View Full Details
                                      </>
                                    )}
                                  </button>

                                  {/* Select Button */}
                                  <button
                                    onClick={() => {
                                      setFormData({
                                        ...formData,
                                        purchasePrice: estimatedPrice.toString(),
                                        selectedPrograms: pkg.programs.map(p => p.id)
                                      });
                                    }}
                                    className={`w-full mt-3 py-3 rounded-lg font-semibold transition-all ${
                                      isSelected
                                        ? 'bg-green-600 text-white'
                                        : 'bg-blue-600 text-white hover:bg-blue-700'
                                    }`}
                                  >
                                    {isSelected ? 'âœ“ Selected' : 'Select This Package'}
                                  </button>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      ) : (
                        <div className="bg-amber-50 border border-amber-200 rounded-xl p-6 text-center">
                          <Icon name="AlertTriangle" className="w-12 h-12 text-amber-500 mx-auto mb-3" />
                          <h3 className="text-lg font-bold text-amber-900 mb-2">No Matching DPA Programs</h3>
                          <p className="text-sm text-amber-700">Consider the affordable housing options below or consult with a housing counselor.</p>
                        </div>
                      )}
                      </div>
                      )}

                      {/* Affordable Housing Programs - Only show when Path 2 selected */}
                      {selectedPath === 'affordable' && affordablePrograms.length > 0 && (
                        <div className="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl p-6 border border-purple-200 shadow-lg">
                          <div className="flex items-center gap-3 mb-5">
                            <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center">
                              <Icon name="Home" className="w-6 h-6 text-white" />
                            </div>
                            <div>
                              <h2 className="text-2xl font-bold text-gray-900">Affordable Housing Programs</h2>
                              <p className="text-gray-600">Below-market-rate homes with income restrictions</p>
                            </div>
                          </div>

                          <div className="grid md:grid-cols-2 gap-5">
                            {affordablePrograms.slice(0, 4).map((program, idx) => {
                              const isExpanded = expandedPackages[`affordable-${idx}`];
                              return (
                                <div key={idx} className="bg-white border-2 border-purple-200 rounded-xl overflow-hidden hover:border-purple-400 hover:shadow-md transition-all">
                                  {/* Header */}
                                  <div className="bg-gradient-to-r from-purple-600 to-indigo-600 px-5 py-4">
                                    <div className="flex items-center gap-3">
                                      <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center flex-shrink-0">
                                        <Icon name="Home" className="w-6 h-6 text-white" />
                                      </div>
                                      <div className="flex-1">
                                        <p className="font-bold text-white text-lg">{program.name}</p>
                                        {program.programType && (
                                          <span className="text-xs bg-white/20 text-white px-2 py-0.5 rounded-full">{program.programType}</span>
                                        )}
                                      </div>
                                    </div>
                                    <p className="text-purple-100 text-xl font-bold mt-2">{program.amount}</p>
                                  </div>

                                  {/* Body */}
                                  <div className="p-5">
                                    <p className="text-sm text-gray-700 mb-4">{program.description}</p>

                                    {/* Pros & Cons - Always Visible */}
                                    <div className="space-y-3 mb-4">
                                      {program.pros && (
                                        <div className="flex items-start gap-2 bg-green-50 rounded-lg p-3">
                                          <Icon name="CheckCircle" className="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" />
                                          <div>
                                            <p className="text-xs font-medium text-green-800 mb-1">Pros</p>
                                            <p className="text-sm text-green-700">{program.pros}</p>
                                          </div>
                                        </div>
                                      )}
                                      {program.cons && (
                                        <div className="flex items-start gap-2 bg-amber-50 rounded-lg p-3">
                                          <Icon name="AlertCircle" className="w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0" />
                                          <div>
                                            <p className="text-xs font-medium text-amber-800 mb-1">Cons</p>
                                            <p className="text-sm text-amber-700">{program.cons}</p>
                                          </div>
                                        </div>
                                      )}
                                    </div>

                                    {/* Expanded Details */}
                                    {isExpanded && (
                                      <div className="pt-4 border-t border-gray-200 space-y-3">
                                        {program.requirements && program.requirements.length > 0 && (
                                          <div>
                                            <p className="text-sm font-semibold text-gray-700 mb-2">Requirements:</p>
                                            <ul className="space-y-1">
                                              {program.requirements.map((req, rIdx) => (
                                                <li key={rIdx} className="flex items-center gap-2 text-sm text-gray-600">
                                                  <div className="w-1.5 h-1.5 bg-purple-400 rounded-full" />
                                                  {req}
                                                </li>
                                              ))}
                                            </ul>
                                          </div>
                                        )}
                                        {program.incomeLimit && program.incomeLimit < 999999 && (
                                          <div className="flex items-center gap-2 text-sm">
                                            <Icon name="DollarSign" className="w-4 h-4 text-purple-500" />
                                            <span className="text-gray-600">Income limit: <strong>${program.incomeLimit.toLocaleString()}</strong></span>
                                          </div>
                                        )}
                                        {program.processingWeeks && (
                                          <div className="flex items-center gap-2 text-sm">
                                            <Icon name="Clock" className="w-4 h-4 text-purple-500" />
                                            <span className="text-gray-600">Processing time: <strong>{program.processingWeeks} weeks</strong></span>
                                          </div>
                                        )}
                                        {program.counties && !program.counties.includes('all') && (
                                          <div className="flex items-start gap-2 text-sm">
                                            <Icon name="MapPin" className="w-4 h-4 text-purple-500 mt-0.5" />
                                            <span className="text-gray-600">Available in: <strong>{program.counties.join(', ')}</strong></span>
                                          </div>
                                        )}
                                      </div>
                                    )}

                                    {/* Expand/Collapse Button */}
                                    <button
                                      onClick={() => {
                                        setExpandedPackages(prev => ({
                                          ...prev,
                                          [`affordable-${idx}`]: !prev[`affordable-${idx}`]
                                        }));
                                      }}
                                      className="w-full mt-4 py-2 text-sm text-purple-600 hover:text-purple-800 font-medium flex items-center justify-center gap-1 border border-purple-200 rounded-lg hover:bg-purple-50 transition-colors"
                                    >
                                      {isExpanded ? (
                                        <>
                                          <Icon name="ChevronUp" className="w-4 h-4" />
                                          Show Less
                                        </>
                                      ) : (
                                        <>
                                          <Icon name="ChevronDown" className="w-4 h-4" />
                                          View Full Details
                                        </>
                                      )}
                                    </button>
                                  </div>
                                </div>
                              );
                            })}
                          </div>

                          <div className="mt-5 bg-purple-100/50 rounded-lg p-4 flex items-start gap-3">
                            <Icon name="Info" className="w-5 h-5 text-purple-600 mt-0.5 flex-shrink-0" />
                            <p className="text-sm text-purple-800">
                              <strong>Note:</strong> Affordable housing programs offer below-market prices but may have deed restrictions, income limits, or residency requirements. Contact programs directly to check availability and waitlists.
                            </p>
                          </div>
                        </div>
                      )}

                      {/* Selection Summary & Continue - Only show when a path is selected */}
                      {selectedPath && (
                        <div className="mt-8 pt-6 border-t border-gray-200">
                          {selectedPath === 'dpa' && formData.selectedPrograms.length > 0 ? (
                            <div className="bg-green-50 border-2 border-green-200 rounded-xl p-5 mb-4">
                              <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center">
                                  <Icon name="CheckCircle" className="w-6 h-6 text-green-600" />
                                </div>
                                <div className="flex-1">
                                  <p className="font-bold text-green-900">DPA Package Selected!</p>
                                  <p className="text-sm text-green-700">
                                    {formData.selectedPrograms.length} program{formData.selectedPrograms.length > 1 ? 's' : ''} selected - You're ready to continue
                                  </p>
                                </div>
                              </div>
                            </div>
                          ) : selectedPath === 'dpa' ? (
                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-5 mb-4">
                              <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                  <Icon name="Info" className="w-5 h-5 text-blue-500" />
                                </div>
                                <div>
                                  <p className="font-medium text-blue-800">Select a DPA package above</p>
                                  <p className="text-sm text-blue-600">Choose a package to see your estimated assistance and monthly payment</p>
                                </div>
                              </div>
                            </div>
                          ) : (
                            <div className="bg-purple-50 border border-purple-200 rounded-xl p-5 mb-4">
                              <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                                  <Icon name="Home" className="w-5 h-5 text-purple-500" />
                                </div>
                                <div>
                                  <p className="font-medium text-purple-800">Affordable Housing Path Selected</p>
                                  <p className="text-sm text-purple-600">Review the programs above and continue when ready</p>
                                </div>
                              </div>
                            </div>
                          )}

                          <div className="flex gap-3">
                            <button
                              onClick={() => setSelectedPath(null)}
                              className="px-6 py-4 border-2 border-gray-300 text-gray-700 rounded-xl font-semibold hover:bg-gray-50 transition-all flex items-center justify-center gap-2"
                            >
                              <Icon name="ArrowLeft" className="w-5 h-5" />
                              Change Path
                            </button>
                            <button
                              onClick={() => setStep(3)}
                              className="flex-1 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-semibold text-lg hover:from-blue-700 hover:to-indigo-700 transition-all flex items-center justify-center gap-2 shadow-lg hover:shadow-xl"
                            >
                              Continue to Next Step
                              <Icon name="ArrowRight" className="w-5 h-5" />
                            </button>
                          </div>
                        </div>
                      )}
                    </>
                  );
                })()}
              </div>
            )}

            {/* Step 3: Prepare */}
            {step === 3 && (
              <div className="space-y-6">
                {/* Header with You Are Here */}
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="MapPin" className="w-5 h-5" />
                    </div>
                    <div>
                      <p className="text-blue-100 text-sm font-medium">You are here</p>
                      <h2 className="text-2xl font-bold">Prepare for Homeownership</h2>
                    </div>
                  </div>
                  <p className="text-blue-100 mt-2">Complete these requirements before meeting with realtors and lenders.</p>

                  {/* Progress Summary */}
                  <div className="mt-4 flex items-center gap-4">
                    <div className="flex-1 h-2 bg-white/20 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-green-400 transition-all duration-500"
                        style={{ width: `${((prepareProgress.classesCompleted ? 1 : 0) + (uploadedDocuments.length >= 3 ? 1 : 0)) / 2 * 100}%` }}
                      />
                    </div>
                    <span className="text-sm font-medium">
                      {(prepareProgress.classesCompleted ? 1 : 0) + (uploadedDocuments.length >= 3 ? 1 : 0)}/2 Complete
                    </span>
                  </div>
                </div>

                {/* Homebuyer Education Classes */}
                <div className={`border-2 rounded-xl overflow-hidden transition-all ${prepareProgress.classesCompleted ? 'border-green-300 bg-green-50' : 'border-gray-200'}`}>
                  <div className="p-5">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex items-start gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${prepareProgress.classesCompleted ? 'bg-green-500' : 'bg-blue-100'}`}>
                          {prepareProgress.classesCompleted ? (
                            <Icon name="Check" className="w-5 h-5 text-white" />
                          ) : (
                            <Icon name="GraduationCap" className="w-5 h-5 text-blue-600" />
                          )}
                        </div>
                        <div>
                          <h3 className="font-bold text-gray-900 text-lg">Homebuyer Education Course</h3>
                          <p className="text-sm text-gray-600 mt-1">Required for most DPA programs. Complete a HUD-approved homebuyer education course.</p>
                        </div>
                      </div>
                      {prepareProgress.classesCompleted && (
                        <span className="bg-green-100 text-green-700 text-xs font-semibold px-3 py-1 rounded-full">Completed</span>
                      )}
                    </div>

                    {!prepareProgress.classesCompleted && (
                      <div className="mt-4 space-y-3">
                        <p className="text-sm font-medium text-gray-700">Recommended providers:</p>
                        <div className="grid gap-2">
                          {[
                            { name: 'eHome America', url: 'https://www.ehomeamerica.org', price: '$99', duration: '6-8 hours online' },
                            { name: 'Framework Homebuyer', url: 'https://www.frameworkhomebuyer.org', price: '$75', duration: '6 hours online' },
                            { name: 'Colorado Housing Connects', url: 'https://coloradohousingconnects.org', price: 'Free', duration: '8 hours (in-person/virtual)' }
                          ].map((course, idx) => (
                            <div key={idx} className="flex items-center justify-between bg-white rounded-lg p-3 border border-gray-200">
                              <div>
                                <p className="font-medium text-gray-900">{course.name}</p>
                                <p className="text-xs text-gray-500">{course.duration} â€¢ {course.price}</p>
                              </div>
                              <a href={course.url} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
                                Start <Icon name="ExternalLink" className="w-3 h-3" />
                              </a>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}

                    <div className="mt-4 pt-4 border-t border-gray-200">
                      <label className="flex items-center gap-3 cursor-pointer">
                        <input
                          type="checkbox"
                          checked={prepareProgress.classesCompleted}
                          onChange={(e) => setPrepareProgress({...prepareProgress, classesCompleted: e.target.checked})}
                          className="w-5 h-5 rounded border-gray-300 text-green-600 focus:ring-green-500"
                        />
                        <span className="text-sm font-medium text-gray-700">I have completed a homebuyer education course</span>
                      </label>
                    </div>
                  </div>
                </div>

                {/* Document Uploads */}
                <div className={`border-2 rounded-xl overflow-hidden transition-all ${uploadedDocuments.length >= 3 ? 'border-green-300 bg-green-50' : 'border-gray-200'}`}>
                  <div className="p-5">
                    <div className="flex items-start justify-between gap-4">
                      <div className="flex items-start gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${uploadedDocuments.length >= 3 ? 'bg-green-500' : 'bg-blue-100'}`}>
                          {uploadedDocuments.length >= 3 ? (
                            <Icon name="Check" className="w-5 h-5 text-white" />
                          ) : (
                            <Icon name="FolderOpen" className="w-5 h-5 text-blue-600" />
                          )}
                        </div>
                        <div>
                          <h3 className="font-bold text-gray-900 text-lg">Upload Required Documents</h3>
                          <p className="text-sm text-gray-600 mt-1">Gather and upload your documents now to speed up the application process.</p>
                        </div>
                      </div>
                      <span className={`text-xs font-semibold px-3 py-1 rounded-full ${
                        uploadedDocuments.length >= documents.length ? 'bg-green-100 text-green-700' :
                        uploadedDocuments.length > 0 ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600'
                      }`}>
                        {uploadedDocuments.length}/{documents.length} Uploaded
                      </span>
                    </div>

                    {/* Quick Document Status */}
                    <div className="mt-4 grid grid-cols-2 md:grid-cols-4 gap-2">
                      {documents.slice(0, 4).map((doc) => {
                        const hasUpload = getUploadsForDocument(doc.id).length > 0;
                        return (
                          <div key={doc.id} className={`p-2 rounded-lg text-center text-xs ${hasUpload ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                            <Icon name={hasUpload ? 'CheckCircle' : 'Circle'} className="w-4 h-4 mx-auto mb-1" />
                            <span className="line-clamp-1">{doc.name.split('(')[0].trim()}</span>
                          </div>
                        );
                      })}
                    </div>

                    <button
                      onClick={() => setShowDocumentUpload(true)}
                      className="mt-4 w-full bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold hover:bg-blue-700 transition-colors flex items-center justify-center gap-2"
                    >
                      <Icon name="Upload" className="w-5 h-5" />
                      Open Document Center
                    </button>
                  </div>
                </div>

                {/* Ready to Continue */}
                {prepareProgress.classesCompleted && uploadedDocuments.length >= 3 && (
                  <div className="bg-green-50 border border-green-200 rounded-xl p-5">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                        <Icon name="CheckCircle" className="w-6 h-6 text-white" />
                      </div>
                      <div>
                        <h3 className="font-bold text-green-900">You're Ready!</h3>
                        <p className="text-sm text-green-700">You've completed the preparation steps. Continue to select a realtor.</p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* Step 4: Select Realtor */}
            {step === 4 && (
              <div className="space-y-6">
                {/* Header */}
                <div className="bg-gradient-to-r from-amber-500 to-orange-500 rounded-xl p-6 text-white">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="Users" className="w-5 h-5" />
                    </div>
                    <div>
                      <p className="text-amber-100 text-sm font-medium">Step 4</p>
                      <h2 className="text-2xl font-bold">Select Your Realtor</h2>
                    </div>
                  </div>
                  <p className="text-amber-100 mt-2">Choose from our vetted realtors experienced with DPA programs and schedule a consultation.</p>
                </div>

                {/* Realtor Selection */}
                <div className="space-y-4">
                  <p className="text-sm text-gray-600">Select one or more realtors to schedule consultations. All realtors listed are experienced with down payment assistance programs in {formData.location} County.</p>

                  {getRealtorsForCounty(formData.location).length > 0 ? (
                    <div className="space-y-3">
                      {getRealtorsForCounty(formData.location).map((realtor, idx) => {
                        const isSelected = selectedRealtors.includes(realtor.name);
                        const hasScheduled = realtorConsultations[realtor.name];

                        return (
                          <div
                            key={idx}
                            className={`border-2 rounded-xl p-4 transition-all cursor-pointer ${
                              isSelected ? 'border-amber-400 bg-amber-50' : 'border-gray-200 hover:border-amber-200'
                            }`}
                            onClick={() => {
                              if (isSelected) {
                                setSelectedRealtors(selectedRealtors.filter(r => r !== realtor.name));
                                const newConsultations = {...realtorConsultations};
                                delete newConsultations[realtor.name];
                                setRealtorConsultations(newConsultations);
                              } else {
                                setSelectedRealtors([...selectedRealtors, realtor.name]);
                              }
                            }}
                          >
                            <div className="flex items-start gap-4">
                              <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-1 ${
                                isSelected ? 'border-amber-500 bg-amber-500' : 'border-gray-300'
                              }`}>
                                {isSelected && <Icon name="Check" className="w-4 h-4 text-white" />}
                              </div>

                              <div className="flex-1">
                                <div className="flex items-start justify-between">
                                  <div>
                                    <h3 className="font-bold text-gray-900">{realtor.name}</h3>
                                    <p className="text-sm text-gray-600">{realtor.brokerage}</p>
                                  </div>
                                  <div className="flex items-center gap-1 bg-amber-100 text-amber-700 px-2 py-1 rounded-full text-sm font-medium">
                                    <Icon name="Star" className="w-4 h-4 fill-current" />
                                    {realtor.rating}
                                  </div>
                                </div>

                                <div className="mt-2 flex flex-wrap gap-2">
                                  {realtor.specialties.map((spec, sIdx) => (
                                    <span key={sIdx} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
                                      {spec}
                                    </span>
                                  ))}
                                </div>

                                <p className="text-sm text-gray-500 mt-2">{realtor.phone}</p>

                                {/* Schedule Consultation (shown when selected) */}
                                {isSelected && (
                                  <div className="mt-4 pt-4 border-t border-amber-200" onClick={(e) => e.stopPropagation()}>
                                    <p className="text-sm font-medium text-gray-700 mb-2">Schedule consultation:</p>
                                    {hasScheduled ? (
                                      <div className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                                        <Icon name="CheckCircle" className="w-5 h-5 text-green-600" />
                                        <span className="text-sm text-green-800">
                                          Scheduled for {hasScheduled.date} at {hasScheduled.time}
                                        </span>
                                        <button
                                          onClick={() => {
                                            const newConsultations = {...realtorConsultations};
                                            delete newConsultations[realtor.name];
                                            setRealtorConsultations(newConsultations);
                                          }}
                                          className="ml-auto text-gray-400 hover:text-red-500"
                                        >
                                          <Icon name="X" className="w-4 h-4" />
                                        </button>
                                      </div>
                                    ) : (
                                      <div className="grid grid-cols-2 gap-2">
                                        {[
                                          { date: 'Tomorrow', times: ['10:00 AM', '2:00 PM'] },
                                          { date: 'Next Week', times: ['9:00 AM', '1:00 PM', '4:00 PM'] }
                                        ].map((slot) => (
                                          <div key={slot.date} className="space-y-1">
                                            <p className="text-xs font-medium text-gray-500">{slot.date}</p>
                                            {slot.times.map((time) => (
                                              <button
                                                key={time}
                                                onClick={() => setRealtorConsultations({
                                                  ...realtorConsultations,
                                                  [realtor.name]: { date: slot.date, time }
                                                })}
                                                className="w-full text-xs bg-white border border-gray-200 rounded px-2 py-1.5 hover:border-amber-400 hover:bg-amber-50 transition-colors"
                                              >
                                                {time}
                                              </button>
                                            ))}
                                          </div>
                                        ))}
                                      </div>
                                    )}
                                  </div>
                                )}
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  ) : (
                    <div className="bg-gray-50 rounded-xl p-6 text-center">
                      <Icon name="Users" className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                      <p className="text-gray-600">No realtors currently listed for {formData.location} County.</p>
                      <p className="text-sm text-gray-500 mt-1">Contact a HUD-approved housing counselor for realtor referrals.</p>
                    </div>
                  )}
                </div>

                {/* Selection Summary */}
                {selectedRealtors.length > 0 && (
                  <div className="bg-amber-50 border border-amber-200 rounded-xl p-4">
                    <h4 className="font-semibold text-amber-900 mb-2">Selected Realtors ({selectedRealtors.length})</h4>
                    <div className="space-y-2">
                      {selectedRealtors.map((name) => {
                        const consultation = realtorConsultations[name];
                        return (
                          <div key={name} className="flex items-center justify-between text-sm">
                            <span className="text-amber-800">{name}</span>
                            {consultation ? (
                              <span className="text-green-600 flex items-center gap-1">
                                <Icon name="Calendar" className="w-4 h-4" />
                                {consultation.date} at {consultation.time}
                              </span>
                            ) : (
                              <span className="text-amber-600">Select a time above</span>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>
                )}

                {/* Skip or Continue Note */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div className="flex gap-3">
                    <Icon name="Info" className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="font-medium text-blue-900">Working with a realtor</p>
                      <p className="text-sm text-blue-800 mt-1">
                        A realtor experienced with DPA programs can help you find eligible properties and navigate the process.
                        You can also continue without selecting a realtor and find one later.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* OLD Step 2 content moved - keeping package logic for DPA step */}
            {false && (
              <div>
                {(() => {
                  const income = parseInt(formData.income) || 0;
                  const estimatedPrice = Math.min(income * 4.5, 500000);
                  const purchasePrice = parseInt(formData.purchasePrice) || estimatedPrice;
                  const eligible = getEligiblePrograms();
                  const validCombos = generateCombinations(eligible);

                  // Helper function to render a compact package card
                  const renderPackageCard = (pkg, key, isBest, isExpanded, isAffordableSection) => {
                    const affordableProgram = pkg.programs.find(p => p.isAffordableHousing);
                    const dpaPrograms = pkg.programs.filter(p => !p.isAffordableHousing);
                    const isAffordableOnly = affordableProgram && dpaPrograms.length === 0;
                    const isCombo = affordableProgram && dpaPrograms.length > 0;
                    const dpaTotal = dpaPrograms.reduce((sum, p) => sum + (typeof p.amount === 'number' ? p.amount : 0), 0);

                    return (
                      <div
                        key={key}
                        className={`border-2 rounded-xl overflow-hidden ${
                          isAffordableSection ? 'border-purple-200' : (isBest ? 'border-green-500' : 'border-gray-200')
                        }`}
                      >
                        {/* Compact Package Header */}
                        {isCombo ? (
                          <div className="bg-gradient-to-r from-purple-600 to-blue-600 px-4 py-3">
                            <div className="flex justify-between items-center">
                              <div>
                                <span className="text-purple-100 text-xs font-medium uppercase">{affordableProgram?.programType} + DPA</span>
                                <p className="text-white text-lg font-bold">{affordableProgram?.amount}</p>
                              </div>
                              <div className="text-right bg-white/20 rounded px-2 py-1">
                                <p className="text-white/90 text-xs">+DPA</p>
                                <p className="text-white text-lg font-bold">${dpaTotal.toLocaleString()}</p>
                              </div>
                            </div>
                          </div>
                        ) : isAffordableOnly ? (
                          <div className="bg-purple-600 px-4 py-3">
                            <div className="flex justify-between items-center">
                              <div>
                                <span className="text-purple-100 text-xs font-medium uppercase">{affordableProgram?.programType || 'Affordable Housing'}</span>
                                <p className="text-white text-lg font-bold">{affordableProgram?.amount || 'Below Market'}</p>
                              </div>
                            </div>
                          </div>
                        ) : (
                          <div className={`px-4 py-3 ${isBest ? 'bg-green-600' : 'bg-blue-600'}`}>
                            <div className="flex justify-between items-center">
                              <div>
                                {isBest && <span className="text-green-100 text-xs font-medium uppercase">Best Option</span>}
                                <p className="text-white text-2xl font-bold">${pkg.totalAssistance.toLocaleString()}</p>
                              </div>
                              <div className="text-right">
                                <p className="text-white/80 text-xs">Monthly</p>
                                <p className="text-white text-lg font-bold">${pkg.monthlyPayment.toLocaleString()}</p>
                              </div>
                            </div>
                          </div>
                        )}

                        {/* Compact Package Body */}
                        <div className="p-3">
                          <p className="font-semibold text-gray-900 text-sm truncate" title={pkg.programs.map(p => p.name).join(' + ')}>
                            {pkg.programs.length === 1 ? pkg.programs[0].name : pkg.programs.map(p => p.name).join(' + ')}
                          </p>

                          {!isAffordableOnly && (
                            <div className="flex justify-between text-xs text-gray-500 mt-1">
                              <span>Out-of-pocket: ${pkg.yourDownPayment.toLocaleString()}</span>
                              <span>{((0.065 + (pkg.metrics?.rateAdder || 0)) * 100).toFixed(2)}% rate</span>
                            </div>
                          )}

                          {/* Expandable Details */}
                          <button
                            onClick={() => setExpandedPackages({...expandedPackages, [key]: !isExpanded})}
                            className={`flex items-center gap-1 mt-2 ${isAffordableSection ? 'text-purple-600' : 'text-blue-600'} text-xs font-medium`}
                          >
                            <Icon name={isExpanded ? 'ChevronUp' : 'ChevronDown'} className="w-3 h-3" />
                            {isExpanded ? 'Hide' : 'Details'}
                          </button>

                          {isExpanded && (
                            <div className="mt-2 space-y-2">
                              {pkg.programs.map((program, pIdx) => (
                                <div key={pIdx} className={`rounded-lg p-3 text-xs ${program.isAffordableHousing ? 'bg-purple-50 border border-purple-200' : 'bg-gray-50'}`}>
                                  <div className="flex justify-between items-start mb-1">
                                    <p className="font-semibold text-gray-900">{program.name}</p>
                                    <p className={`font-bold ${program.isAffordableHousing ? 'text-purple-600' : 'text-green-600'}`}>
                                      {program.isAffordableHousing ? program.amount : `$${program.amount.toLocaleString()}`}
                                    </p>
                                  </div>
                                  <p className="text-gray-600 mb-2">{program.description}</p>
                                  <div className="grid grid-cols-2 gap-2 pt-2 border-t border-gray-200">
                                    <div>
                                      <p className="font-medium text-green-700">âœ“ {program.pros}</p>
                                    </div>
                                    <div>
                                      <p className="font-medium text-amber-700">âš  {program.cons}</p>
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}

                          {/* Select Button */}
                          <button
                            onClick={() => {
                              setFormData({
                                ...formData,
                                purchasePrice: purchasePrice.toString(),
                                selectedPrograms: pkg.programs.map(p => p.id),
                                recommendedLender: pkg.recommendedLender
                              });
                              setStep(3);
                            }}
                            className={`w-full mt-3 py-2 px-3 rounded-lg font-semibold text-sm transition-all ${
                              isAffordableSection
                                ? 'bg-purple-600 text-white hover:bg-purple-700'
                                : (isBest ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-blue-600 text-white hover:bg-blue-700')
                            }`}
                          >
                            Select Package
                          </button>
                        </div>
                      </div>
                    );
                  };

                  // Calculate packages
                  const packages = validCombos.map(combo => {
                    const metrics = calculateCombinationMetrics(combo, purchasePrice, parseInt(formData.downPaymentSaved) || 0, formData.creditScore);
                    const lenderMatch = getLenderMatch(combo);
                    const loanAmount = purchasePrice - metrics.totalAssistance - (parseInt(formData.downPaymentSaved) || 0);
                    const monthlyPI = Math.round((Math.max(0, loanAmount) * 0.065 / 12) / (1 - Math.pow(1 + 0.065/12, -360)));
                    const monthlyTaxIns = Math.round(purchasePrice * 0.015 / 12);
                    const monthlyTotal = monthlyPI + monthlyTaxIns;
                    const minDown = purchasePrice * 0.035;

                    return {
                      programs: combo.map(id => {
                        const p = programs.find(pr => pr.id === id);
                        return {
                          id: p.id,
                          name: p.name,
                          amount: p.isAffordableHousing ? p.amount : (p.calcAmount ? p.calcAmount(purchasePrice) : 0),
                          description: p.description,
                          pros: p.pros,
                          cons: p.cons,
                          requirements: p.requirements,
                          isGrant: p.isGrant,
                          yearsToForgiveness: p.yearsToForgiveness,
                          isAffordableHousing: p.isAffordableHousing || false,
                          programType: p.programType || null
                        };
                      }),
                      totalAssistance: metrics.totalAssistance,
                      monthlyPayment: monthlyTotal,
                      yourDownPayment: Math.max(0, Math.round(minDown - metrics.totalAssistance)),
                      recommendedLender: lenderMatch,
                      metrics
                    };
                  });

                  // Sort and ensure variety
                  const sorted = packages.sort((a, b) => b.totalAssistance - a.totalAssistance);
                  const hasCHFA = pkg => pkg.programs.some(p => p.id === 'chfa-grant' || p.id === 'chfa-second');
                  const hasMetroDPA = pkg => pkg.programs.some(p => p.id === 'metro-dpa');
                  const hasAffordableHousing = pkg => pkg.programs.some(p => p.isAffordableHousing);
                  const chfaPackages = sorted.filter(hasCHFA);
                  const metroDPAPackages = sorted.filter(hasMetroDPA);
                  const affordablePackages = sorted.filter(hasAffordableHousing);

                  const result = [];
                  const seen = new Set();
                  // Start with top 2 by total assistance (usually DPA packages)
                  sorted.slice(0, 2).forEach(pkg => {
                    const key = pkg.programs.map(p => p.id).sort().join(',');
                    if (!seen.has(key)) { seen.add(key); result.push(pkg); }
                  });
                  // Ensure at least one CHFA option
                  if (chfaPackages.length > 0 && !result.some(hasCHFA)) {
                    const key = chfaPackages[0].programs.map(p => p.id).sort().join(',');
                    if (!seen.has(key)) { seen.add(key); result.push(chfaPackages[0]); }
                  }
                  // Ensure at least one MetroDPA option
                  if (metroDPAPackages.length > 0 && !result.some(hasMetroDPA)) {
                    const key = metroDPAPackages[0].programs.map(p => p.id).sort().join(',');
                    if (!seen.has(key)) { seen.add(key); result.push(metroDPAPackages[0]); }
                  }
                  // Ensure at least one affordable housing option (if available)
                  if (affordablePackages.length > 0 && !result.some(hasAffordableHousing)) {
                    const key = affordablePackages[0].programs.map(p => p.id).sort().join(',');
                    if (!seen.has(key)) { seen.add(key); result.push(affordablePackages[0]); }
                  }
                  // Fill remaining slots
                  for (const pkg of sorted) {
                    if (result.length >= 6) break;
                    const key = pkg.programs.map(p => p.id).sort().join(',');
                    if (!seen.has(key)) { seen.add(key); result.push(pkg); }
                  }
                  // Sort final list: DPA packages first by amount, then affordable housing
                  const finalPackages = result.sort((a, b) => {
                    const aIsAffordable = a.programs.some(p => p.isAffordableHousing);
                    const bIsAffordable = b.programs.some(p => p.isAffordableHousing);
                    // Put affordable housing at the end so DPA options show first
                    if (aIsAffordable && !bIsAffordable) return 1;
                    if (!aIsAffordable && bIsAffordable) return -1;
                    return b.totalAssistance - a.totalAssistance;
                  });

                  return (
                    <div className="space-y-4">
                      {/* Price context */}
                      <div className="bg-gray-50 rounded-lg p-4 flex justify-between items-center">
                        <div>
                          <p className="text-sm text-gray-600">Calculating for estimated home price:</p>
                          <p className="text-xl font-bold text-gray-900">${purchasePrice.toLocaleString()}</p>
                        </div>
                        <div className="text-right">
                          <p className="text-sm text-gray-600">Programs you qualify for:</p>
                          <p className="text-xl font-bold text-blue-600">{eligible.length}</p>
                        </div>
                      </div>

                      {/* Two-column grid layout for packages */}
                      {(() => {
                        const dpaPackages = finalPackages.filter(pkg => !pkg.programs.some(p => p.isAffordableHousing));
                        const affordablePackages = finalPackages.filter(pkg => pkg.programs.some(p => p.isAffordableHousing));

                        return (
                          <div className="grid md:grid-cols-2 gap-6">
                            {/* Down Payment Assistance Column */}
                            <div>
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                  <Icon name="DollarSign" className="w-4 h-4 text-blue-600" />
                                </div>
                                <div>
                                  <h3 className="text-base font-bold text-gray-900">Down Payment Assistance</h3>
                                  <p className="text-xs text-gray-500">Cash to help with down payment</p>
                                </div>
                              </div>
                              {dpaPackages.length > 0 ? (
                                <div className="space-y-3">
                                  {dpaPackages.slice(0, 3).map((pkg, idx) => {
                                    const isBest = idx === 0;
                                    const isExpanded = expandedPackages[`dpa-${idx}`] || false;
                                    return renderPackageCard(pkg, `dpa-${idx}`, isBest, isExpanded, false);
                                  })}
                                </div>
                              ) : (
                                <div className="bg-gray-50 rounded-lg p-4 text-center text-gray-500 text-sm">
                                  No DPA programs match your profile
                                </div>
                              )}
                            </div>

                            {/* Affordable Housing Column */}
                            <div>
                              <div className="flex items-center gap-2 mb-3">
                                <div className="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                  <Icon name="Home" className="w-4 h-4 text-purple-600" />
                                </div>
                                <div>
                                  <h3 className="text-base font-bold text-gray-900">Affordable Housing Programs</h3>
                                  <p className="text-xs text-gray-500">Below-market home purchases</p>
                                </div>
                              </div>
                              {affordablePackages.length > 0 ? (
                                <div className="space-y-3">
                                  {affordablePackages.slice(0, 3).map((pkg, idx) => {
                                    const isExpanded = expandedPackages[`ah-${idx}`] || false;
                                    return renderPackageCard(pkg, `ah-${idx}`, false, isExpanded, true);
                                  })}
                                </div>
                              ) : (
                                <div className="bg-gray-50 rounded-lg p-4 text-center text-gray-500 text-sm">
                                  No affordable housing programs in your area
                                </div>
                              )}
                            </div>
                          </div>
                        );
                      })()}

                      {finalPackages.length === 0 && (
                        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                          <Icon name="AlertCircle" className="w-8 h-8 text-yellow-600 mx-auto mb-3" />
                          <p className="text-gray-900 font-medium">No assistance packages available</p>
                          <p className="text-gray-600 text-sm mt-1">Based on your income and location, you may not qualify for current DPA programs. Consider contacting a HUD-approved housing counselor for guidance.</p>
                        </div>
                      )}

                      {/* Help Note */}
                      <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div className="flex gap-3">
                          <Icon name="Info" className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                          <div>
                            <p className="font-medium text-blue-900">Not sure which to choose?</p>
                            <p className="text-sm text-blue-800 mt-1">
                              The "Best Option" gives you the most assistance, but consider your priorities:
                              grants don't need to be repaid, while forgivable loans require you to stay in the home.
                              Click "Show program details" to learn more about each option.
                            </p>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
                })()}
              </div>
            )}

            {/* Step 5: Get Pre-Approved */}
            {step === 5 && (
              <div className="space-y-6">
                {/* Header */}
                <div className="bg-gradient-to-r from-green-600 to-emerald-600 rounded-xl p-6 text-white">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="Building" className="w-5 h-5" />
                    </div>
                    <div>
                      <p className="text-green-100 text-sm font-medium">Step 5</p>
                      <h2 className="text-2xl font-bold">Get Pre-Approved</h2>
                    </div>
                  </div>
                  <p className="text-green-100 mt-2">Select lenders and submit your pre-approval application using your uploaded documents.</p>
                </div>

                {/* Lender Selection */}
                <div className="space-y-4">
                  <h3 className="font-bold text-gray-900">Select Lenders for Pre-Approval</h3>
                  <p className="text-sm text-gray-600">Choose one or more lenders experienced with DPA programs. Your uploaded documents will be used for the application.</p>

                  <div className="space-y-3">
                    {lenders.filter(l => l.counties.includes('all') || l.counties.includes(formData.location)).slice(0, 5).map((lender, idx) => {
                      const isSelected = selectedLenders.includes(lender.name);

                      return (
                        <div
                          key={idx}
                          className={`border-2 rounded-xl p-4 transition-all cursor-pointer ${
                            isSelected ? 'border-green-400 bg-green-50' : 'border-gray-200 hover:border-green-200'
                          }`}
                          onClick={() => {
                            if (isSelected) {
                              setSelectedLenders(selectedLenders.filter(l => l !== lender.name));
                            } else {
                              setSelectedLenders([...selectedLenders, lender.name]);
                            }
                          }}
                        >
                          <div className="flex items-start gap-4">
                            <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center flex-shrink-0 mt-1 ${
                              isSelected ? 'border-green-500 bg-green-500' : 'border-gray-300'
                            }`}>
                              {isSelected && <Icon name="Check" className="w-4 h-4 text-white" />}
                            </div>

                            <div className="flex-1">
                              <div className="flex items-start justify-between">
                                <div>
                                  <h4 className="font-bold text-gray-900">{lender.name}</h4>
                                  <div className="flex flex-wrap gap-2 mt-1">
                                    {lender.specialties.slice(0, 2).map((spec, sIdx) => (
                                      <span key={sIdx} className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
                                        {spec}
                                      </span>
                                    ))}
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="flex items-center gap-1 text-amber-600">
                                    <Icon name="Star" className="w-4 h-4 fill-current" />
                                    <span className="font-medium">{lender.rating}</span>
                                  </div>
                                  <p className="text-xs text-gray-500">Avg {lender.avgDays} days</p>
                                </div>
                              </div>
                              <p className="text-sm text-gray-500 mt-2">{lender.phone}</p>
                              {lender.notes && <p className="text-xs text-gray-400 mt-1">{lender.notes}</p>}
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>

                {/* Pre-Approval Application Form */}
                {selectedLenders.length > 0 && (
                  <div className="border-2 border-green-200 rounded-xl overflow-hidden">
                    <div className="bg-green-50 px-5 py-4 border-b border-green-200">
                      <h3 className="font-bold text-gray-900 flex items-center gap-2">
                        <Icon name="FileText" className="w-5 h-5 text-green-600" />
                        Pre-Approval Application
                      </h3>
                      <p className="text-sm text-gray-600 mt-1">Applying to: {selectedLenders.join(', ')}</p>
                    </div>

                    {preApprovalData.submitted ? (
                      <div className="p-6 text-center">
                        <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                          <Icon name="CheckCircle" className="w-8 h-8 text-green-600" />
                        </div>
                        <h4 className="text-xl font-bold text-gray-900 mb-2">Pre-Approval Submitted!</h4>
                        <p className="text-gray-600 mb-4">Your application has been sent to {selectedLenders.length} lender{selectedLenders.length > 1 ? 's' : ''}.</p>
                        <div className="bg-gray-50 rounded-lg p-4 text-left max-w-md mx-auto">
                          <p className="text-sm text-gray-600"><strong>What's next:</strong></p>
                          <ul className="text-sm text-gray-600 mt-2 space-y-1">
                            <li>â€¢ Lenders will review your application within 1-3 business days</li>
                            <li>â€¢ You'll receive pre-approval letters via email</li>
                            <li>â€¢ Continue to the DPA application in the next step</li>
                          </ul>
                        </div>
                      </div>
                    ) : (
                      <div className="p-5 space-y-4">
                        {/* Attached Documents */}
                        <div className="bg-gray-50 rounded-lg p-4">
                          <div className="flex items-center justify-between mb-2">
                            <p className="font-medium text-gray-700 flex items-center gap-2">
                              <Icon name="Paperclip" className="w-4 h-4" />
                              Attached Documents ({uploadedDocuments.length})
                            </p>
                            <button
                              onClick={() => setShowDocumentUpload(true)}
                              className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                            >
                              + Add More
                            </button>
                          </div>
                          {uploadedDocuments.length > 0 ? (
                            <div className="flex flex-wrap gap-2">
                              {uploadedDocuments.slice(0, 4).map((doc) => (
                                <span key={doc.id} className="text-xs bg-white border border-gray-200 rounded px-2 py-1 flex items-center gap-1">
                                  <Icon name="File" className="w-3 h-3 text-green-600" />
                                  {doc.fileName.substring(0, 20)}...
                                </span>
                              ))}
                              {uploadedDocuments.length > 4 && (
                                <span className="text-xs text-gray-500">+{uploadedDocuments.length - 4} more</span>
                              )}
                            </div>
                          ) : (
                            <p className="text-sm text-amber-600">No documents uploaded yet - upload documents to strengthen your application</p>
                          )}
                        </div>

                        {/* Additional Info */}
                        <div className="space-y-3">
                          <p className="font-medium text-gray-700">Additional Information</p>

                          <div className="grid md:grid-cols-2 gap-3">
                            <div>
                              <label className="block text-sm text-gray-600 mb-1">Employer Name</label>
                              <input
                                type="text"
                                value={preApprovalData.employerName}
                                onChange={(e) => setPreApprovalData({...preApprovalData, employerName: e.target.value})}
                                className="w-full p-3 border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100"
                                placeholder="Company name"
                              />
                            </div>
                            <div>
                              <label className="block text-sm text-gray-600 mb-1">Employer Phone</label>
                              <input
                                type="tel"
                                value={preApprovalData.employerPhone}
                                onChange={(e) => setPreApprovalData({...preApprovalData, employerPhone: e.target.value})}
                                className="w-full p-3 border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100"
                                placeholder="(xxx) xxx-xxxx"
                              />
                            </div>
                          </div>

                          <div className="grid md:grid-cols-2 gap-3">
                            <div>
                              <label className="block text-sm text-gray-600 mb-1">Years at Current Job</label>
                              <select
                                value={preApprovalData.yearsAtJob}
                                onChange={(e) => setPreApprovalData({...preApprovalData, yearsAtJob: e.target.value})}
                                className="w-full p-3 border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100"
                              >
                                <option value="">Select...</option>
                                <option value="less-than-1">Less than 1 year</option>
                                <option value="1-2">1-2 years</option>
                                <option value="2-5">2-5 years</option>
                                <option value="5+">5+ years</option>
                              </select>
                            </div>
                            <div>
                              <label className="block text-sm text-gray-600 mb-1">Monthly Debt Payments</label>
                              <input
                                type="text"
                                value={preApprovalData.monthlyDebts}
                                onChange={(e) => setPreApprovalData({...preApprovalData, monthlyDebts: e.target.value})}
                                className="w-full p-3 border border-gray-200 rounded-lg focus:border-green-500 focus:ring-2 focus:ring-green-100"
                                placeholder="$0"
                              />
                            </div>
                          </div>

                          <div>
                            <label className="block text-sm text-gray-600 mb-1">Bankruptcy in last 7 years?</label>
                            <div className="flex gap-4">
                              <label className="flex items-center gap-2">
                                <input
                                  type="radio"
                                  name="bankruptcy"
                                  value="no"
                                  checked={preApprovalData.bankruptcyHistory === 'no'}
                                  onChange={(e) => setPreApprovalData({...preApprovalData, bankruptcyHistory: e.target.value})}
                                  className="text-green-600"
                                />
                                <span className="text-sm">No</span>
                              </label>
                              <label className="flex items-center gap-2">
                                <input
                                  type="radio"
                                  name="bankruptcy"
                                  value="yes"
                                  checked={preApprovalData.bankruptcyHistory === 'yes'}
                                  onChange={(e) => setPreApprovalData({...preApprovalData, bankruptcyHistory: e.target.value})}
                                  className="text-green-600"
                                />
                                <span className="text-sm">Yes</span>
                              </label>
                            </div>
                          </div>
                        </div>

                        {/* Submit Button */}
                        <button
                          onClick={() => setPreApprovalData({...preApprovalData, submitted: true, submittedAt: new Date().toISOString()})}
                          className="w-full bg-green-600 text-white py-3 rounded-xl font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
                        >
                          <Icon name="Send" className="w-5 h-5" />
                          Submit Pre-Approval Application
                        </button>
                      </div>
                    )}
                  </div>
                )}

                {/* Info Note */}
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div className="flex gap-3">
                    <Icon name="Info" className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="font-medium text-blue-900">Why get pre-approved?</p>
                      <p className="text-sm text-blue-800 mt-1">
                        Pre-approval shows sellers you're a serious buyer and helps you understand exactly how much home you can afford.
                        Most DPA programs require a pre-approval letter from a participating lender.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* OLD Step 3 - Keeping for reference */}
            {false && checklist && (
              <div className="space-y-8">
                {/* Header */}
                <div className="text-center">
                  <h2 className="text-2xl md:text-3xl font-bold text-gray-900 mb-2">Your Homebuying Roadmap</h2>
                  <p className="text-gray-500 max-w-2xl mx-auto">Follow these three phases to successfully purchase your home with assistance programs.</p>
                </div>

                {/* OLD Selected Programs Summary */}
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-6 text-white">
                  <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                      <p className="text-blue-100 text-sm font-medium mb-2">Your Selected Programs</p>
                      <div className="flex flex-wrap gap-2">
                        {formData.selectedPrograms.map(id => {
                          const program = programs.find(p => p.id === id);
                          return (
                            <span key={id} className="bg-white/20 backdrop-blur-sm px-3 py-1.5 rounded-full text-sm font-medium">
                              {program?.name}
                            </span>
                          );
                        })}
                      </div>
                    </div>
                    {formData.recommendedLender && formData.recommendedLender.matchType !== 'multiple' && (
                      <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4">
                        <p className="text-blue-100 text-xs font-medium mb-1">Recommended Lender</p>
                        <p className="font-semibold text-lg">{formData.recommendedLender.name}</p>
                        {formData.recommendedLender.phone && (
                          <a href={`tel:${formData.recommendedLender.phone.replace(/[^0-9]/g, '')}`}
                             className="text-blue-100 hover:text-white text-sm flex items-center gap-1 mt-1">
                            <Icon name="Phone" className="w-3 h-3" />
                            {formData.recommendedLender.phone}
                          </a>
                        )}
                      </div>
                    )}
                  </div>
                </div>

                {/* Horizontal Timeline */}
                <div className="hidden md:flex items-center justify-between px-8 py-4">
                  <div className="flex-1 flex items-center">
                    <div className="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center text-white font-bold shadow-lg">1</div>
                    <div className="flex-1 h-1 bg-gradient-to-r from-red-500 to-amber-500 mx-2"></div>
                  </div>
                  <div className="flex-1 flex items-center">
                    <div className="w-12 h-12 bg-amber-500 rounded-full flex items-center justify-center text-white font-bold shadow-lg">2</div>
                    <div className="flex-1 h-1 bg-gradient-to-r from-amber-500 to-green-500 mx-2"></div>
                  </div>
                  <div className="flex items-center">
                    <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center text-white font-bold shadow-lg">3</div>
                  </div>
                </div>

                {/* Phase Cards - Horizontal Layout on Desktop */}
                <div className="grid md:grid-cols-3 gap-6">
                  {/* Phase 1 */}
                  <div className="bg-gradient-to-br from-red-50 to-orange-50 rounded-2xl border border-red-100 overflow-hidden">
                    <div className="bg-gradient-to-r from-red-500 to-red-600 px-5 py-4 text-white">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center font-bold">1</div>
                        <div>
                          <h3 className="font-bold">Prepare</h3>
                          <p className="text-red-100 text-xs">Before house hunting</p>
                        </div>
                      </div>
                    </div>
                    <div className="p-5 space-y-3">
                      {checklist.now.map((item, idx) => (
                        <div key={idx} className="bg-white rounded-xl p-4 shadow-sm border border-red-100">
                          <div className="flex items-start gap-3">
                            <div className="w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                              {idx + 1}
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-gray-900 text-sm">{item.task}</p>
                              {item.time && <p className="text-xs text-gray-500 mt-1">{item.time}</p>}
                              {item.urgent && (
                                <span className="inline-block bg-red-100 text-red-700 text-xs px-2 py-0.5 rounded-full mt-2 font-medium">
                                  Priority
                                </span>
                              )}
                              {/* Document checklist with quick status */}
                              {item.task === 'Gather Required Documents' && (
                                <div className="mt-2">
                                  <div className="flex items-center gap-2 text-xs">
                                    <span className="text-green-600 font-medium">{uploadedDocuments.length} uploaded</span>
                                    <span className="text-gray-400">â€¢</span>
                                    <span className="text-gray-500">{documents.length - Math.min(uploadedDocuments.length, documents.length)} remaining</span>
                                  </div>
                                  <button
                                    onClick={() => setShowDocumentUpload(true)}
                                    className="mt-2 flex items-center gap-1 text-xs text-blue-600 hover:text-blue-800 font-medium"
                                  >
                                    <Icon name="Upload" className="w-3 h-3" />
                                    Open Document Center
                                  </button>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>
                      ))}

                      {/* Recommended Realtors Dropdown */}
                      <div className="bg-white rounded-xl p-3 shadow-sm border border-red-100">
                        <button
                          onClick={() => setShowRealtorsDropdown(!showRealtorsDropdown)}
                          className="w-full flex items-center justify-between text-left"
                        >
                          <div className="flex items-center gap-2">
                            <div className="w-6 h-6 bg-red-100 text-red-600 rounded-full flex items-center justify-center">
                              <Icon name="Users" className="w-3 h-3" />
                            </div>
                            <span className="font-semibold text-gray-900 text-sm">Recommended Realtors</span>
                          </div>
                          <Icon name={showRealtorsDropdown ? 'ChevronUp' : 'ChevronDown'} className="w-4 h-4 text-gray-400" />
                        </button>
                        {showRealtorsDropdown && (
                          <div className="mt-3 space-y-2">
                            <p className="text-xs text-gray-500 mb-2">DPA-experienced agents in {formData.location} County:</p>
                            {getRealtorsForCounty(formData.location).length > 0 ? (
                              getRealtorsForCounty(formData.location).slice(0, 3).map((realtor, idx) => (
                                <div key={idx} className="bg-red-50 rounded-lg p-2 text-xs">
                                  <div className="flex justify-between items-start">
                                    <div>
                                      <p className="font-semibold text-gray-900">{realtor.name}</p>
                                      <p className="text-gray-600">{realtor.brokerage}</p>
                                    </div>
                                    <span className="text-amber-600 font-medium">{realtor.rating} â˜…</span>
                                  </div>
                                  <p className="text-gray-500 mt-1">{realtor.specialties.join(' â€¢ ')}</p>
                                  <a href={`tel:${realtor.phone.replace(/[^0-9]/g, '')}`} className="inline-flex items-center gap-1 text-red-600 hover:text-red-800 mt-1 font-medium">
                                    <Icon name="Phone" className="w-3 h-3" />
                                    {realtor.phone}
                                  </a>
                                </div>
                              ))
                            ) : (
                              <p className="text-xs text-gray-500">Contact a HUD-approved housing counselor for realtor referrals.</p>
                            )}
                          </div>
                        )}
                      </div>

                      {/* Document Center Card */}
                      <button
                        onClick={() => setShowDocumentUpload(true)}
                        className="w-full bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-3 shadow-sm border border-blue-200 hover:border-blue-300 transition-all text-left group"
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-2">
                            <div className="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center group-hover:bg-blue-200 transition-colors">
                              <Icon name="FolderOpen" className="w-4 h-4" />
                            </div>
                            <div>
                              <span className="font-semibold text-gray-900 text-sm">Document Center</span>
                              <p className="text-xs text-gray-500">Upload required documents</p>
                            </div>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className={`text-xs font-medium px-2 py-1 rounded-full ${
                              uploadedDocuments.length > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'
                            }`}>
                              {uploadedDocuments.length}/{documents.length}
                            </span>
                            <Icon name="ArrowRight" className="w-4 h-4 text-gray-400 group-hover:text-blue-600 transition-colors" />
                          </div>
                        </div>
                      </button>
                    </div>
                  </div>

                  {/* Phase 2 */}
                  <div className="bg-gradient-to-br from-amber-50 to-yellow-50 rounded-2xl border border-amber-100 overflow-hidden">
                    <div className="bg-gradient-to-r from-amber-500 to-amber-600 px-5 py-4 text-white">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center font-bold">2</div>
                        <div>
                          <h3 className="font-bold">Search</h3>
                          <p className="text-amber-100 text-xs">While house hunting</p>
                        </div>
                      </div>
                    </div>
                    <div className="p-5 space-y-3">
                      {checklist.searching.map((item, idx) => (
                        <div key={idx} className="bg-white rounded-xl p-4 shadow-sm border border-amber-100">
                          <div className="flex items-start gap-3">
                            <div className="w-6 h-6 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                              {idx + 1}
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-gray-900 text-sm">{item.task}</p>
                              {item.time && <p className="text-xs text-gray-500 mt-1">{item.time}</p>}
                            </div>
                          </div>
                        </div>
                      ))}

                      {/* Recommended Lenders Dropdown */}
                      <div className="bg-white rounded-xl p-3 shadow-sm border border-amber-100">
                        <button
                          onClick={() => setShowLendersDropdown(!showLendersDropdown)}
                          className="w-full flex items-center justify-between text-left"
                        >
                          <div className="flex items-center gap-2">
                            <div className="w-6 h-6 bg-amber-100 text-amber-600 rounded-full flex items-center justify-center">
                              <Icon name="Building" className="w-3 h-3" />
                            </div>
                            <span className="font-semibold text-gray-900 text-sm">Recommended Lenders</span>
                          </div>
                          <Icon name={showLendersDropdown ? 'ChevronUp' : 'ChevronDown'} className="w-4 h-4 text-gray-400" />
                        </button>
                        {showLendersDropdown && (
                          <div className="mt-3 space-y-2">
                            <p className="text-xs text-gray-500 mb-2">Lenders experienced with your selected programs:</p>
                            {(() => {
                              const matchingLenders = lenders.filter(l =>
                                formData.selectedPrograms.some(p => l.programs.includes(p)) &&
                                (l.counties.includes('all') || l.counties.includes(formData.location))
                              ).slice(0, 4);
                              return matchingLenders.length > 0 ? (
                                matchingLenders.map((lender, idx) => (
                                  <div key={idx} className="bg-amber-50 rounded-lg p-2 text-xs">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <p className="font-semibold text-gray-900">{lender.name}</p>
                                        <p className="text-gray-600">{lender.specialties.slice(0, 2).join(' â€¢ ')}</p>
                                      </div>
                                      <span className="text-amber-600 font-medium">{lender.rating} â˜…</span>
                                    </div>
                                    <div className="flex items-center justify-between mt-1">
                                      <span className="text-gray-500">Avg close: {lender.avgDays} days</span>
                                      <a href={`tel:${lender.phone.replace(/[^0-9]/g, '')}`} className="inline-flex items-center gap-1 text-amber-600 hover:text-amber-800 font-medium">
                                        <Icon name="Phone" className="w-3 h-3" />
                                        {lender.phone}
                                      </a>
                                    </div>
                                  </div>
                                ))
                              ) : (
                                <p className="text-xs text-gray-500">Select a package first to see recommended lenders.</p>
                              );
                            })()}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Phase 3 */}
                  <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl border border-green-100 overflow-hidden">
                    <div className="bg-gradient-to-r from-green-500 to-green-600 px-5 py-4 text-white">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center font-bold">3</div>
                        <div>
                          <h3 className="font-bold">Close</h3>
                          <p className="text-green-100 text-xs">After offer accepted</p>
                        </div>
                      </div>
                    </div>
                    <div className="p-5 space-y-3">
                      {checklist.offer.map((item, idx) => (
                        <div key={idx} className="bg-white rounded-xl p-4 shadow-sm border border-green-100">
                          <div className="flex items-start gap-3">
                            <div className="w-6 h-6 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                              {idx + 1}
                            </div>
                            <div className="flex-1 min-w-0">
                              <p className="font-semibold text-gray-900 text-sm">{item.task}</p>
                              {item.time && <p className="text-xs text-gray-500 mt-1">{item.time}</p>}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Action CTAs */}
                <div className="grid md:grid-cols-2 gap-4">
                  {/* Download Package CTA */}
                  <div className="bg-gradient-to-r from-slate-700 to-slate-800 rounded-2xl p-6 text-white">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-10 h-10 bg-white/10 rounded-xl flex items-center justify-center">
                        <Icon name="FileText" className="w-5 h-5" />
                      </div>
                      <h3 className="font-bold text-lg">Download Lender Package</h3>
                    </div>
                    <p className="text-slate-300 text-sm mb-4">
                      Get your profile and checklist to bring to your lender appointment.
                    </p>
                    <button
                      onClick={generateLenderPackage}
                      className="w-full flex items-center justify-center gap-2 bg-white text-slate-900 px-6 py-3 rounded-xl font-semibold hover:bg-slate-100 transition-all"
                    >
                      <Icon name="Download" className="w-5 h-5" />
                      Download PDF
                    </button>
                  </div>

                  {/* Apply Now CTA */}
                  <div className="bg-gradient-to-r from-green-600 to-emerald-600 rounded-2xl p-6 text-white">
                    <div className="flex items-center gap-3 mb-3">
                      <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                        <Icon name="Send" className="w-5 h-5" />
                      </div>
                      <h3 className="font-bold text-lg">Ready to Apply?</h3>
                    </div>
                    <p className="text-green-100 text-sm mb-4">
                      Submit your unified application for all {formData.selectedPrograms.length} selected program{formData.selectedPrograms.length !== 1 ? 's' : ''}.
                    </p>
                    <button
                      onClick={() => setStep(6)}
                      className="w-full flex items-center justify-center gap-2 bg-white text-green-700 px-6 py-3 rounded-xl font-semibold hover:bg-green-50 transition-all"
                    >
                      <Icon name="ArrowRight" className="w-5 h-5" />
                      Apply Now
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Step 6: Apply for DPA */}
            {step === 6 && (
              <div className="space-y-6">
                {/* Header */}
                <div className="bg-gradient-to-r from-purple-600 to-indigo-600 rounded-xl p-6 text-white">
                  <div className="flex items-center gap-3 mb-2">
                    <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                      <Icon name="DollarSign" className="w-5 h-5" />
                    </div>
                    <div>
                      <p className="text-purple-100 text-sm font-medium">Step 6</p>
                      <h2 className="text-2xl font-bold">Apply for Down Payment Assistance</h2>
                    </div>
                  </div>
                  <p className="text-purple-100 mt-2">Select your programs and submit your unified application.</p>
                </div>

                {applicationData.submitted ? (
                  /* Success State */
                  <div className="text-center py-12">
                    <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                      <Icon name="CheckCircle" className="w-10 h-10 text-green-600" />
                    </div>
                    <h3 className="text-2xl font-bold text-gray-900 mb-2">Application Submitted!</h3>
                    <p className="text-gray-600 mb-6">Your application has been submitted for review.</p>
                    <div className="bg-green-50 border border-green-200 rounded-xl p-6 max-w-md mx-auto">
                      <p className="text-sm text-green-800 mb-2"><strong>Confirmation Number:</strong></p>
                      <p className="text-2xl font-mono font-bold text-green-700">DPA-{Date.now().toString(36).toUpperCase()}</p>
                      <p className="text-xs text-green-600 mt-3">Submitted on {new Date(applicationData.submittedAt).toLocaleString()}</p>
                    </div>
                    <div className="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-4 max-w-lg mx-auto">
                      <h4 className="font-semibold text-blue-900 mb-2">What happens next?</h4>
                      <ul className="text-sm text-blue-800 space-y-2 text-left">
                        <li className="flex items-start gap-2">
                          <Icon name="Clock" className="w-4 h-4 mt-0.5 flex-shrink-0" />
                          <span>Applications are typically reviewed within 5-10 business days</span>
                        </li>
                        <li className="flex items-start gap-2">
                          <Icon name="Mail" className="w-4 h-4 mt-0.5 flex-shrink-0" />
                          <span>You'll receive an email with next steps and any additional requirements</span>
                        </li>
                        <li className="flex items-start gap-2">
                          <Icon name="Phone" className="w-4 h-4 mt-0.5 flex-shrink-0" />
                          <span>A housing counselor may contact you to schedule a consultation</span>
                        </li>
                      </ul>
                    </div>
                  </div>
                ) : (
                  /* Application Form */
                  <>
                    {/* Program Selection */}
                    <div className="border-2 border-purple-200 rounded-xl overflow-hidden">
                      <div className="bg-purple-50 px-5 py-4 border-b border-purple-200">
                        <h3 className="font-bold text-gray-900 flex items-center gap-2">
                          <Icon name="CheckSquare" className="w-5 h-5 text-purple-600" />
                          Select DPA Programs to Apply For
                        </h3>
                        <p className="text-sm text-gray-600 mt-1">Based on your profile, you may qualify for these programs:</p>
                      </div>
                      <div className="p-4 space-y-2 max-h-80 overflow-y-auto">
                        {getEligiblePrograms().filter(p => !p.isAffordableHousing).slice(0, 6).map((program) => {
                          const isSelected = formData.selectedPrograms.includes(program.id);
                          const amount = program.calcAmount ? program.calcAmount(Math.min(parseInt(formData.income) * 4.5, 500000)) : 0;

                          return (
                            <div
                              key={program.id}
                              className={`border-2 rounded-lg p-3 cursor-pointer transition-all ${
                                isSelected ? 'border-purple-400 bg-purple-50' : 'border-gray-200 hover:border-purple-200'
                              }`}
                              onClick={() => {
                                if (isSelected) {
                                  setFormData({...formData, selectedPrograms: formData.selectedPrograms.filter(id => id !== program.id)});
                                } else {
                                  setFormData({...formData, selectedPrograms: [...formData.selectedPrograms, program.id]});
                                }
                              }}
                            >
                              <div className="flex items-start gap-3">
                                <div className={`w-5 h-5 rounded border-2 flex items-center justify-center flex-shrink-0 mt-0.5 ${
                                  isSelected ? 'border-purple-500 bg-purple-500' : 'border-gray-300'
                                }`}>
                                  {isSelected && <Icon name="Check" className="w-3 h-3 text-white" />}
                                </div>
                                <div className="flex-1">
                                  <div className="flex items-start justify-between">
                                    <div>
                                      <p className="font-medium text-gray-900">{program.name}</p>
                                      <p className="text-xs text-gray-500 mt-0.5">{program.description}</p>
                                    </div>
                                    <div className="text-right">
                                      <p className="font-bold text-purple-600">${amount.toLocaleString()}</p>
                                      <p className="text-xs text-gray-500">{program.isGrant ? 'Grant' : 'Loan'}</p>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                      {formData.selectedPrograms.length > 0 && (
                        <div className="bg-purple-100 px-5 py-3 border-t border-purple-200">
                          <div className="flex items-center justify-between">
                            <span className="font-medium text-purple-900">{formData.selectedPrograms.length} program{formData.selectedPrograms.length > 1 ? 's' : ''} selected</span>
                            <span className="font-bold text-purple-700">
                              Est. Total: ${formData.selectedPrograms.reduce((sum, id) => {
                                const prog = programs.find(p => p.id === id);
                                return sum + (prog?.calcAmount ? prog.calcAmount(Math.min(parseInt(formData.income) * 4.5, 500000)) : 0);
                              }, 0).toLocaleString()}
                            </span>
                          </div>
                        </div>
                      )}
                    </div>

                    {/* Show application form only if programs selected */}
                    {formData.selectedPrograms.length > 0 && (
                      <>
                        {/* Selected Programs Summary */}
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-5 border border-blue-200">
                          <h3 className="font-bold text-gray-900 mb-3 flex items-center gap-2">
                            <Icon name="FileText" className="w-5 h-5 text-blue-600" />
                            Programs You're Applying For
                          </h3>
                          <div className="space-y-2">
                            {formData.selectedPrograms.map(id => {
                              const program = programs.find(p => p.id === id);
                              return program ? (
                                <div key={id} className="flex items-center justify-between bg-white rounded-lg p-3 border border-blue-100">
                                  <div>
                                    <p className="font-medium text-gray-900">{program.name}</p>
                                    <p className="text-xs text-gray-500">{program.amount}</p>
                                  </div>
                                  <Icon name="Check" className="w-5 h-5 text-green-500" />
                                </div>
                              ) : null;
                            })}
                          </div>
                        </div>

                    {/* Uploaded Documents */}
                    <div className="bg-white rounded-xl p-5 border border-gray-200">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="font-bold text-gray-900 flex items-center gap-2">
                          <Icon name="FolderOpen" className="w-5 h-5 text-gray-600" />
                          Attached Documents ({uploadedDocuments.length})
                        </h3>
                        <button
                          onClick={() => setShowDocumentUpload(true)}
                          className="text-sm text-blue-600 hover:text-blue-800 font-medium flex items-center gap-1"
                        >
                          <Icon name="Plus" className="w-4 h-4" />
                          Add More
                        </button>
                      </div>

                      {uploadedDocuments.length > 0 ? (
                        <div className="grid gap-2">
                          {uploadedDocuments.map((doc) => {
                            const docType = documents.find(d => d.id === doc.documentId);
                            return (
                              <div key={doc.id} className="flex items-center gap-3 bg-gray-50 rounded-lg p-3">
                                <div className="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                  <Icon name="File" className="w-4 h-4 text-green-600" />
                                </div>
                                <div className="flex-1 min-w-0">
                                  <p className="text-sm font-medium text-gray-900 truncate">{doc.fileName}</p>
                                  <p className="text-xs text-gray-500">{docType?.name || 'Document'} â€¢ {formatFileSize(doc.fileSize)}</p>
                                </div>
                                <Icon name="CheckCircle" className="w-5 h-5 text-green-500" />
                              </div>
                            );
                          })}
                        </div>
                      ) : (
                        <div className="text-center py-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                          <Icon name="Upload" className="w-8 h-8 text-gray-400 mx-auto mb-2" />
                          <p className="text-sm text-gray-600">No documents uploaded yet</p>
                          <button
                            onClick={() => setShowDocumentUpload(true)}
                            className="mt-2 text-sm text-blue-600 hover:text-blue-800 font-medium"
                          >
                            Upload Documents
                          </button>
                        </div>
                      )}

                      {/* Document completion warning */}
                      {uploadedDocuments.length > 0 && uploadedDocuments.length < documents.length && (
                        <div className="mt-3 bg-amber-50 border border-amber-200 rounded-lg p-3 flex items-start gap-2">
                          <Icon name="AlertTriangle" className="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0" />
                          <p className="text-xs text-amber-800">
                            You've uploaded {uploadedDocuments.length} of {documents.length} recommended documents.
                            Missing documents may delay your application.
                          </p>
                        </div>
                      )}
                    </div>

                    {/* Applicant Information Summary */}
                    <div className="bg-white rounded-xl p-5 border border-gray-200">
                      <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <Icon name="User" className="w-5 h-5 text-gray-600" />
                        Applicant Information
                      </h3>
                      <div className="grid md:grid-cols-2 gap-4 text-sm">
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-gray-500 text-xs mb-1">Annual Income</p>
                          <p className="font-semibold text-gray-900">${parseInt(formData.income || 0).toLocaleString()}</p>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-gray-500 text-xs mb-1">County</p>
                          <p className="font-semibold text-gray-900">{formData.location} County</p>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-gray-500 text-xs mb-1">First-Time Buyer</p>
                          <p className="font-semibold text-gray-900">{formData.firstTimeBuyer ? 'Yes' : 'No'}</p>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-gray-500 text-xs mb-1">Credit Score Range</p>
                          <p className="font-semibold text-gray-900">{formData.creditScore || 'Not specified'}</p>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-gray-500 text-xs mb-1">Down Payment Saved</p>
                          <p className="font-semibold text-gray-900">${parseInt(formData.downPaymentSaved || 0).toLocaleString()}</p>
                        </div>
                        <div className="bg-gray-50 rounded-lg p-3">
                          <p className="text-gray-500 text-xs mb-1">Target Home Price</p>
                          <p className="font-semibold text-gray-900">${parseInt(formData.purchasePrice || 0).toLocaleString()}</p>
                        </div>
                      </div>
                    </div>

                    {/* Agreements & Signature */}
                    <div className="bg-white rounded-xl p-5 border border-gray-200">
                      <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <Icon name="Shield" className="w-5 h-5 text-gray-600" />
                        Authorizations & Signature
                      </h3>

                      <div className="space-y-4">
                        <label className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                          <input
                            type="checkbox"
                            checked={applicationData.agreeToTerms}
                            onChange={(e) => setApplicationData({...applicationData, agreeToTerms: e.target.checked})}
                            className="w-5 h-5 mt-0.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                          />
                          <div>
                            <p className="font-medium text-gray-900">I certify the information provided is accurate</p>
                            <p className="text-xs text-gray-500 mt-1">I understand that providing false information may result in denial of assistance and potential legal consequences.</p>
                          </div>
                        </label>

                        <label className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100 transition-colors">
                          <input
                            type="checkbox"
                            checked={applicationData.authorizeCredit}
                            onChange={(e) => setApplicationData({...applicationData, authorizeCredit: e.target.checked})}
                            className="w-5 h-5 mt-0.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                          />
                          <div>
                            <p className="font-medium text-gray-900">I authorize a credit check (soft pull)</p>
                            <p className="text-xs text-gray-500 mt-1">This soft inquiry will not affect your credit score. A hard pull will only occur if you proceed with a lender.</p>
                          </div>
                        </label>

                        <div className="pt-4 border-t border-gray-200">
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Electronic Signature
                          </label>
                          <input
                            type="text"
                            placeholder="Type your full legal name"
                            value={applicationData.signature}
                            onChange={(e) => setApplicationData({...applicationData, signature: e.target.value})}
                            className="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-100 transition-all"
                          />
                          <p className="text-xs text-gray-500 mt-2">By typing your name above, you agree this constitutes your electronic signature.</p>
                        </div>
                      </div>
                    </div>

                    {/* Submit Button */}
                    <div className="pt-4">
                      <button
                        onClick={() => {
                          if (applicationData.agreeToTerms && applicationData.authorizeCredit && applicationData.signature.trim()) {
                            setApplicationData({
                              ...applicationData,
                              submitted: true,
                              submittedAt: new Date().toISOString()
                            });
                          }
                        }}
                        disabled={!applicationData.agreeToTerms || !applicationData.authorizeCredit || !applicationData.signature.trim()}
                        className={`w-full py-4 rounded-xl font-bold text-lg transition-all ${
                          applicationData.agreeToTerms && applicationData.authorizeCredit && applicationData.signature.trim()
                            ? 'bg-gradient-to-r from-green-600 to-emerald-600 text-white hover:from-green-700 hover:to-emerald-700 shadow-lg hover:shadow-xl'
                            : 'bg-gray-200 text-gray-400 cursor-not-allowed'
                        }`}
                      >
                        <span className="flex items-center justify-center gap-2">
                          <Icon name="Send" className="w-5 h-5" />
                          Submit Application
                        </span>
                      </button>
                      {(!applicationData.agreeToTerms || !applicationData.authorizeCredit || !applicationData.signature.trim()) && (
                        <p className="text-center text-xs text-gray-500 mt-2">
                          Please complete all required fields above to submit
                        </p>
                      )}
                    </div>

                    {/* Privacy Note */}
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3">
                      <Icon name="Lock" className="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" />
                      <div className="text-sm text-blue-800">
                        <p className="font-medium">Your information is secure</p>
                        <p className="text-xs mt-1">All data is encrypted and only shared with the specific programs you're applying to. We never sell your information.</p>
                      </div>
                    </div>
                      </>
                    )}
                  </>
                )}
              </div>
            )}

            {/* Step 7: Feedback */}
            {step === 7 && (
              <div className="space-y-6">
                <div>
                  <h2 className="text-xl font-bold text-gray-900 mb-2">Help Us Build This Tool</h2>
                  <p className="text-gray-600">Your feedback will shape whether and how we build this for Colorado families.</p>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    How helpful was this roadmap?
                  </label>
                  <div className="flex gap-2">
                    {[1, 2, 3, 4, 5].map(rating => (
                      <button
                        key={rating}
                        onClick={() => setFeedback({...feedback, helpful: rating})}
                        className={`w-12 h-12 rounded-lg border-2 font-bold transition-colors ${
                          feedback.helpful === rating
                            ? 'border-blue-500 bg-blue-500 text-white'
                            : 'border-gray-300 hover:border-gray-400'
                        }`}
                      >
                        {rating}
                      </button>
                    ))}
                  </div>
                  <div className="flex justify-between text-xs text-gray-600 mt-1">
                    <span>Not helpful</span>
                    <span>Very helpful</span>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    What was most confusing or unclear?
                  </label>
                  <textarea
                    className="w-full p-3 border border-gray-300 rounded-lg"
                    rows="3"
                    placeholder="Be specific - this helps us improve..."
                    value={feedback.clarity}
                    onChange={(e) => setFeedback({...feedback, clarity: e.target.value})}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    Would you pay $25-50 for access to this tool with all features (document vault, lender matching, education tracking)?
                  </label>
                  <div className="space-y-2">
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        name="wouldPay"
                        value="yes"
                        checked={feedback.wouldPay === 'yes'}
                        onChange={(e) => setFeedback({...feedback, wouldPay: e.target.value})}
                      />
                      <span className="text-sm">Yes, this would save me time and stress</span>
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        name="wouldPay"
                        value="maybe"
                        checked={feedback.wouldPay === 'maybe'}
                        onChange={(e) => setFeedback({...feedback, wouldPay: e.target.value})}
                      />
                      <span className="text-sm">Maybe, depends on how much better than free options</span>
                    </label>
                    <label className="flex items-center gap-2">
                      <input
                        type="radio"
                        name="wouldPay"
                        value="no"
                        checked={feedback.wouldPay === 'no'}
                        onChange={(e) => setFeedback({...feedback, wouldPay: e.target.value})}
                      />
                      <span className="text-sm">No, I'd only use it if free</span>
                    </label>
                  </div>
                </div>

                {/* Rate Feedback Questions */}
                <div className="border-t border-gray-200 pt-6 mt-6">
                  <h3 className="font-medium text-gray-900 mb-4">About the Interest Rate Estimates</h3>

                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Were the estimated interest rates and monthly payments helpful?
                    </label>
                    <div className="space-y-2">
                      <label className="flex items-center gap-2">
                        <input
                          type="radio"
                          name="rateHelpful"
                          value="yes-helpful"
                          checked={feedback.rateHelpful === 'yes-helpful'}
                          onChange={(e) => setFeedback({...feedback, rateHelpful: e.target.value})}
                        />
                        <span className="text-sm">Yes, they helped me understand affordability and compare options</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input
                          type="radio"
                          name="rateHelpful"
                          value="somewhat"
                          checked={feedback.rateHelpful === 'somewhat'}
                          onChange={(e) => setFeedback({...feedback, rateHelpful: e.target.value})}
                        />
                        <span className="text-sm">Somewhat - I understand they're estimates</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input
                          type="radio"
                          name="rateHelpful"
                          value="no-wanted-specific"
                          checked={feedback.rateHelpful === 'no-wanted-specific'}
                          onChange={(e) => setFeedback({...feedback, rateHelpful: e.target.value})}
                        />
                        <span className="text-sm">No, I wanted more specific/guaranteed rates</span>
                      </label>
                      <label className="flex items-center gap-2">
                        <input
                          type="radio"
                          name="rateHelpful"
                          value="ignored"
                          checked={feedback.rateHelpful === 'ignored'}
                          onChange={(e) => setFeedback({...feedback, rateHelpful: e.target.value})}
                        />
                        <span className="text-sm">I ignored them / didn't trust them</span>
                      </label>
                    </div>
                  </div>

                  <div className="mb-4">
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      What would make rate information more useful? (Select all that apply)
                    </label>
                    <div className="space-y-2">
                      {[
                        { value: 'single-rate', label: 'Show single rate instead of range' },
                        { value: 'explain-more', label: 'Explain more about what affects rates' },
                        { value: 'market-comparison', label: 'Show comparison to current market average' },
                        { value: 'no-rates', label: "Don't show rates at all" }
                      ].map(option => (
                        <label key={option.value} className="flex items-center gap-2">
                          <input
                            type="checkbox"
                            checked={feedback.rateImprovements.includes(option.value)}
                            onChange={(e) => {
                              if (e.target.checked) {
                                setFeedback({...feedback, rateImprovements: [...feedback.rateImprovements, option.value]});
                              } else {
                                setFeedback({...feedback, rateImprovements: feedback.rateImprovements.filter(v => v !== option.value)});
                              }
                            }}
                          />
                          <span className="text-sm">{option.label}</span>
                        </label>
                      ))}
                    </div>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">
                    What features would make this most valuable to you?
                  </label>
                  <textarea
                    className="w-full p-3 border border-gray-300 rounded-lg"
                    rows="4"
                    placeholder="e.g., 'Real-time program funding status', 'Text message reminders for deadlines', 'Direct connection to housing counselors'..."
                    value={feedback.comments}
                    onChange={(e) => setFeedback({...feedback, comments: e.target.value})}
                  />
                </div>

                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                  <p className="text-sm text-green-900">
                    <strong>Thank you!</strong> Your feedback helps Gary Community Ventures decide whether to build this tool for Colorado families. We'll use your input to prioritize features that actually solve your problems.
                  </p>
                </div>

                <div className="bg-gray-100 rounded-lg p-4">
                  <p className="text-sm text-gray-700 font-medium mb-2">Want to stay updated?</p>
                  <div className="flex gap-2">
                    <input
                      type="email"
                      placeholder="your.email@example.com"
                      className="flex-1 p-2 border border-gray-300 rounded-lg text-sm"
                    />
                    <button className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-700">
                      Notify Me
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Navigation */}
            <div className="flex justify-between mt-8 pt-6 border-t border-gray-200">
              <button
                onClick={handleBack}
                disabled={step === 0}
                className={`flex items-center gap-2 px-5 py-3 rounded-xl font-medium transition-all duration-200 ${
                  step === 0
                    ? 'text-gray-400 cursor-not-allowed'
                    : 'text-gray-700 hover:bg-gray-100 hover:shadow-sm'
                }`}
              >
                <Icon name="ArrowLeft" className="w-4 h-4" />
                Back
              </button>

              {step !== 2 && (
                <button
                  onClick={handleNext}
                  disabled={!canProceed()}
                  className={`flex items-center gap-2 px-8 py-3 rounded-xl font-semibold transition-all duration-200 ${
                    !canProceed()
                      ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                      : 'bg-gradient-to-r from-blue-600 to-indigo-600 text-white hover:from-blue-700 hover:to-indigo-700 shadow-lg hover:shadow-xl hover:scale-[1.02]'
                  }`}
                >
                  {step === steps.length - 1 ? 'Complete' : 'Continue'}
                  <Icon name="ArrowRight" className="w-4 h-4" />
                </button>
              )}
            </div>
          </div>
          </div>

          {/* Document Center Modal */}
          {showDocumentUpload && (
            <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden shadow-2xl">
                {/* Modal Header */}
                <div className="bg-gradient-to-r from-blue-600 to-indigo-600 px-6 py-4 text-white">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                        <Icon name="FolderOpen" className="w-5 h-5" />
                      </div>
                      <div>
                        <h2 className="text-xl font-bold">Document Center</h2>
                        <p className="text-blue-100 text-sm">Upload and manage your required documents</p>
                      </div>
                    </div>
                    <button
                      onClick={() => setShowDocumentUpload(false)}
                      className="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center hover:bg-white/30 transition-colors"
                    >
                      <Icon name="X" className="w-5 h-5" />
                    </button>
                  </div>
                </div>

                {/* Progress Bar */}
                <div className="px-6 py-3 bg-gray-50 border-b">
                  <div className="flex items-center justify-between text-sm mb-2">
                    <span className="text-gray-600">Upload Progress</span>
                    <span className="font-semibold text-blue-600">
                      {documents.filter(d => getUploadsForDocument(d.id).length > 0).length} of {documents.length} documents
                    </span>
                  </div>
                  <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-blue-500 to-indigo-500 transition-all duration-500"
                      style={{ width: `${(documents.filter(d => getUploadsForDocument(d.id).length > 0).length / documents.length) * 100}%` }}
                    />
                  </div>
                </div>

                {/* Document List */}
                <div className="p-6 overflow-y-auto max-h-[calc(90vh-200px)]">
                  <div className="space-y-4">
                    {documents.map((doc) => {
                      const uploads = getUploadsForDocument(doc.id);
                      const hasUploads = uploads.length > 0;

                      return (
                        <div
                          key={doc.id}
                          className={`border-2 rounded-xl p-4 transition-all ${
                            hasUploads ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-white hover:border-blue-200'
                          }`}
                        >
                          <div className="flex items-start justify-between gap-4">
                            <div className="flex-1">
                              <div className="flex items-center gap-2">
                                {hasUploads ? (
                                  <div className="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center">
                                    <Icon name="Check" className="w-4 h-4 text-white" />
                                  </div>
                                ) : (
                                  <div className="w-6 h-6 bg-gray-200 rounded-full flex items-center justify-center">
                                    <Icon name="FileText" className="w-3 h-3 text-gray-500" />
                                  </div>
                                )}
                                <h4 className="font-semibold text-gray-900">{doc.name}</h4>
                              </div>
                              <p className="text-xs text-gray-500 mt-1 ml-8">Required for: {doc.programs}</p>
                              {doc.optional && (
                                <p className="text-xs text-amber-600 mt-1 ml-8">Note: {doc.optional}</p>
                              )}

                              {/* Uploaded files */}
                              {uploads.length > 0 && (
                                <div className="mt-3 ml-8 space-y-2">
                                  {uploads.map((upload) => (
                                    <div key={upload.id} className="flex items-center justify-between bg-white rounded-lg p-2 border border-green-200">
                                      <div className="flex items-center gap-2">
                                        <Icon name="File" className="w-4 h-4 text-green-600" />
                                        <span className="text-sm text-gray-700 truncate max-w-[200px]">{upload.fileName}</span>
                                        <span className="text-xs text-gray-400">{formatFileSize(upload.fileSize)}</span>
                                      </div>
                                      <button
                                        onClick={() => removeDocument(upload.id)}
                                        className="text-red-500 hover:text-red-700 p-1"
                                      >
                                        <Icon name="Trash2" className="w-4 h-4" />
                                      </button>
                                    </div>
                                  ))}
                                </div>
                              )}
                            </div>

                            {/* Upload Button */}
                            <div>
                              <label className={`cursor-pointer inline-flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                hasUploads
                                  ? 'bg-green-100 text-green-700 hover:bg-green-200'
                                  : 'bg-blue-600 text-white hover:bg-blue-700'
                              }`}>
                                <Icon name="Upload" className="w-4 h-4" />
                                {hasUploads ? 'Add More' : 'Upload'}
                                <input
                                  type="file"
                                  className="hidden"
                                  multiple
                                  accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                                  onChange={(e) => handleDocumentUpload(doc.id, e.target.files)}
                                />
                              </label>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>

                  {/* Tips Section */}
                  <div className="mt-6 bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <h4 className="font-semibold text-blue-900 flex items-center gap-2">
                      <Icon name="Info" className="w-4 h-4" />
                      Document Tips
                    </h4>
                    <ul className="mt-2 space-y-1 text-sm text-blue-800">
                      <li>â€¢ Accepted formats: PDF, JPG, PNG, DOC, DOCX</li>
                      <li>â€¢ Make sure all pages are legible and complete</li>
                      <li>â€¢ Bank statements should show your name and account number</li>
                      <li>â€¢ Tax returns should include all schedules and W-2s</li>
                    </ul>
                  </div>
                </div>

                {/* Modal Footer */}
                <div className="px-6 py-4 bg-gray-50 border-t flex items-center justify-between">
                  <p className="text-sm text-gray-500">
                    {uploadedDocuments.length} file{uploadedDocuments.length !== 1 ? 's' : ''} uploaded
                  </p>
                  <button
                    onClick={() => setShowDocumentUpload(false)}
                    className="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-blue-700 transition-colors"
                  >
                    Done
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Footer */}
          <div className="mt-8 pb-8 text-center">
            <p className="text-sm text-gray-500">A prototype by Gary Community Ventures</p>
            <p className="text-xs text-gray-400 mt-1">Testing application support tools for Colorado families</p>
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ColoradoHomebuyerNavigator />);
  </script>
</body>
</html>
